<!DOCTYPE HTML>
<html>

<!-- HEADER -->
<head>

<meta charset="UTF-8">

<title>You grew up on a small blue planet, dreaming of journeying to the stars. Today, you say goodbye.</title>

<script type="bitsyGameData" id="exportedGameData">
You grew up on a small blue planet, dreaming of journeying to the stars. Today, you say goodbye.

# BITSY VERSION 6.0

! ROOM_FORMAT 1

PAL 0
255,255,255
0,0,0
0,0,0

PAL 1
0,0,0
255,255,255
255,255,255

ROOM 0
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,k,e,m,n,e,e,o,p,e,e,e
e,h,e,e,24,25,23,l,l,16,e,r,q,e,e,e
e,e,e,26,0,2b,2c,2o,2p,17,18,r,q,e,t,s
e,e,29,27,0,2f,2d,2n,2q,19,e,r,q,v,u,u
e,e,2a,28,28,2e,2h,2n,2q,1a,1b,r,q,x,w,w
e,e,e,e,e,2e,2i,2n,2q,1e,1d,r,q,k,e,e
e,e,e,e,e,2e,2j,2n,2q,e,e,r,q,e,e,e
1a,1p,1q,1s,1u,2g,2k,2l,2m,e,e,r,q,e,13,14
1o,1o,1n,1r,1t,1v,22,20,21,1f,e,r,q,z,12,15
1i,1j,1k,1l,1m,1w,1x,1y,1z,1h,1g,r,q,10,11,15
f,f,f,f,f,f,f,f,f,f,f,f,f,f,f,f
0,2r,0,0,0,0,0,0,0,2r,0,0,0,0,0,0
0,0,0,0,0,0,0,0,0,0,0,2r,0,0,0,5f
0,0,2r,0,0,0,0,0,0,0,0,0,0,0,0,0
2r,0,0,0,0,0,0,0,0,0,2r,0,0,0,2r,0
NAME rocket
ITM 8 1,2
ITM 8 14,1
ITM 8 2,7
ITM 8 9,8
EXT 15,13 7 3,7
PAL 0

ROOM 1
2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u
2u,2u,2u,2u,2u,2u,e,30,30,2u,2u,2u,2u,2u,2u,2u
2u,2u,e,30,e,2u,2y,2u,2u,2z,2u,2u,30,2u,2u,2u
2u,2u,2y,2u,2z,2u,2w,31,3z,40,2u,2y,2u,2z,2u,2u
2u,2u,2w,j,2x,2u,2w,3x,3y,41,2u,45,j,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,3u,3v,3w,2u,44,2u,2x,2u,2u
2u,e,2w,31,2x,e,2w,3t,3s,3r,2u,43,k,2x,2u,2u
2u,e,2w,2u,2x,e,2w,2u,3q,3p,2u,42,2u,2x,2u,2u
2u,e,2s,2v,2t,e,2s,2v,2v,2t,2u,2s,2v,2t,2u,2u
e,e,3o,e,e,e,e,e,e,e,e,e,e,e,e,e
e,57,35,59,36,55,35,34,56,36,55,35,5b,36,57,e
e,57,0,0,0,55,0,0,0,0,55,0,0,0,58,e
e,57,0,0,0,55,0,0,0,0,55,0,0,0,57,e
2u,57,33,33,33,2u,33,33,33,33,2u,33,33,33,57,2u
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME rocket interior
ITM 8 12,7
ITM 8 3,5
EXT 14,11 8 3,7
PAL 0

ROOM 2
2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u
2u,2u,2u,2u,2u,2u,e,30,30,2u,2u,2u,2u,2u,2u,2u
2u,2u,e,30,e,2u,2y,2u,2u,2z,2u,2u,30,2u,2u,2u
2u,2u,2y,2u,2z,2u,2w,31,4f,4g,2u,2y,2u,2z,2u,2u
2u,2u,2w,j,2x,2u,2w,e,4e,4d,2u,4j,j,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,4b,4a,4c,2u,4i,2u,2x,2u,2u
2u,2u,2w,31,2x,2u,2w,2u,48,49,2u,4h,k,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,2u,47,46,2u,2w,2u,2x,2u,2u
2u,2u,2s,2v,2t,2u,2s,2v,2v,2t,2u,2s,2v,2t,2u,2u
e,e,3o,3m,e,e,e,e,e,e,e,e,e,e,e,e
e,e,35,5a,36,55,35,34,56,36,55,35,5b,36,e,e
e,e,0,0,0,55,0,0,0,0,55,0,0,0,58,e
e,e,0,0,0,55,0,0,0,0,55,0,0,0,e,e
2u,e,33,33,33,2u,33,33,33,33,2u,33,33,33,e,2u
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME Interior Day 2
ITM 5 2,11
EXT 14,11 9 3,7
PAL 0

ROOM 3
2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u
2u,2u,2u,2u,2u,2u,e,30,30,2u,2u,2u,2u,2u,2u,2u
2u,2u,e,30,e,2u,2y,2u,2u,2z,2u,2u,30,2u,2u,2u
2u,2u,2y,2u,2z,2u,2w,31,2u,4s,2u,2y,2u,2z,2u,2u
2u,2u,2w,j,2x,2u,2w,4o,4q,4r,2u,2w,j,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,4n,4p,2x,2u,2w,2u,2x,2u,2u
2u,2u,2w,31,2x,2u,2w,4m,4l,4k,2u,2w,k,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,2u,j,2x,2u,2w,2u,2x,2u,2u
2u,2u,2s,2v,2t,2u,2s,2v,2v,2t,2u,2s,2v,2t,2u,2u
e,e,5c,3m,5c,e,e,e,e,e,e,e,e,e,e,e
2u,e,35,5a,36,55,35,34,56,36,55,35,5b,36,e,e
2u,e,0,0,0,55,0,0,0,0,55,0,0,0,58,2u
e,e,0,0,0,55,0,0,0,0,55,0,0,0,e,57
2u,e,33,33,33,2u,33,33,33,33,2u,33,33,33,e,2u
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME Interior Day 3
ITM 1 8,11
EXT 14,11 a 3,7
PAL 0

ROOM 4
2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u
2u,2u,2u,2u,2u,2u,e,30,30,2u,2u,2u,2u,2u,2u,2u
2u,2u,e,30,e,2u,2y,2u,2u,2z,2u,2u,30,2u,2u,2u
2u,2u,2y,2u,2z,2u,2w,31,2u,2x,2u,2y,2u,2z,2u,2u
2u,2u,2w,j,2x,2u,2w,e,4v,4u,2u,2w,j,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,2u,4w,4t,2u,2w,2u,2x,2u,2u
2u,2u,2w,31,2x,2u,2w,2u,2u,2x,2u,2w,k,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,2u,j,2x,2u,2w,2u,2x,2u,2u
2u,2u,2s,2v,2t,2u,2s,2v,2v,2t,2u,2s,2v,2t,2u,2u
e,e,e,3m,e,e,e,e,e,e,e,e,e,e,e,e
e,e,35,5a,36,55,35,34,56,36,55,35,5b,36,e,e
e,e,0,0,0,55,0,0,0,0,55,u,0,0,58,2u
e,e,0,0,0,55,0,0,0,0,55,0,0,0,e,e
2u,e,33,33,33,2u,33,33,33,33,2u,33,33,33,e,e
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME Interior Day 4
ITM 2 9,11
EXT 14,11 b 3,7
PAL 0

ROOM 5
2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u
2u,2u,2u,2u,2u,2u,e,30,30,2u,2u,2u,2u,2u,2u,2u
2u,2u,e,30,e,2u,2y,2u,2u,2z,2u,2u,30,2u,2u,2u
2u,2u,2y,2u,2z,2u,2w,31,2u,2x,2u,2y,2u,2z,2u,2u
2u,2u,2w,j,2x,2u,2w,e,2u,2x,2u,2w,j,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,e,4x,2x,2u,2w,2u,2x,2u,2u
2u,2u,2w,31,2x,2u,2w,2u,2u,2x,2u,2w,k,2x,2u,2u
2u,2u,2w,2u,2x,2u,2w,2u,j,2x,2u,2w,2u,2x,2u,2u
2u,2u,2s,2v,2t,2u,2s,2v,2v,2t,2u,2s,2v,2t,2u,2u
e,e,e,0,e,e,e,e,e,e,e,e,e,e,e,e
2u,e,35,5a,36,55,35,34,56,36,55,35,5b,36,e,e
2u,e,0,0,0,55,0,0,0,0,55,0,0,0,58,2u
e,e,0,0,0,55,0,0,0,0,55,0,0,0,e,e
e,e,33,33,33,2u,33,33,33,33,2u,33,33,33,e,2u
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
2u,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME Interior Day 5
ITM 3 8,11
EXT 14,11 c 2,7
PAL 0

ROOM 7
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,5c,5c,5c,5c,5c,5d,5c,5c,5c,5c,5e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME transition 1
ITM 6 5,7
ITM 7 12,7
EXT 13,7 1 8,12
PAL 0

ROOM 8
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,5c,5c,5c,5c,5c,5g,5c,5c,5c,5c,5e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME transition 2
ITM 9 11,7
EXT 13,7 2 8,12
PAL 0

ROOM 9
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,5c,5c,5c,5c,5c,5h,5c,5c,5c,5c,5e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME transition 3
ITM a 5,7
EXT 13,7 3 8,12
PAL 0

ROOM a
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,5c,5c,5c,5c,5c,5i,5c,5c,5c,5c,5e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME transition 4
ITM b 11,7
EXT 13,7 4 7,12
PAL 0

ROOM b
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,5c,5c,5c,5c,5c,5j,5c,5c,5c,5c,5e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME transition 5
ITM c 5,7
EXT 13,7 5 8,12
PAL 0

ROOM c
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,5c,5c,5c,5c,5c,5c,5c,5c,5c,5c,5k,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
NAME ending
ITM d 8,7
ITM e 3,7
END 1 13,7
PAL 0

TIL 10
11111101
11111101
11111101
11111100
11111100
11111100
11111100
11111100
NAME city 2

TIL 11
11111101
00000101
11111101
00000001
00000001
00000001
00000001
00000001
NAME city 3

TIL 12
11111100
11111100
11111100
11111100
11111111
00000001
11111101
00000101
NAME city 4

TIL 13
11111111
11111111
11111100
11111101
11111101
11111101
11111101
11111101
NAME city 5

TIL 14
11111111
11111111
00000011
11111011
00001011
11111011
00001011
11111011
NAME city 6

TIL 15
00000011
00000011
00000011
00000011
00000011
00000011
00000011
00000011
NAME city

TIL 16
11111111
11111111
11111111
01111111
11111111
11111111
11111111
10011111
NAME rocket lip and bridge

TIL 17
10000000
11111111
11110110
11110110
10000000
10011111
10010101
10000000

TIL 18
00000001
11111111
11011011
11011011
00000001
11111101
01010101
00000001

TIL 19
10011111
11111111
11111111
11111111
11111111
11111111
11111111
11111111

TIL 20
11111111
00000000
00000000
00000000
00000000
00000000
01111111
11000011

TIL 21
11111111
00000000
00000000
00000000
00000000
00000000
11111110
11000001

TIL 22
11001111
11111111
11111110
11111100
11111000
11110000
01110000
11110000

TIL 23
11111111
11111111
11111111
11111110
11111111
10001111
00001111
00001111

TIL 24
11111111
11111111
11111111
11111111
11111111
11000001
10000000
00000000

TIL 25
11111111
11111111
11111111
11111111
11111111
11111111
11111111
01111110
WAL true

TIL 26
11111111
11111111
11111110
11111100
11111000
11111000
11111000
11000000
WAL true

TIL 27
10000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000

TIL 28
00000000
00000000
11111111
11111111
11111111
11111111
11111111
11111111
WAL true

TIL 29
11111111
11111111
11111111
11111000
11110000
11100000
11000000
10000000

TIL 30
11111111
11111111
11111111
11111111
11111111
11111111
11111111
00000000
WAL true

TIL 31
11111111
11111111
11111111
11111111
11001111
11001111
11111111
11111111

TIL 32
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000

TIL 33
11111111
00000000
11111111
00000000
11111111
11111111
11111111
11111111
WAL false

TIL 34
00011000
01111110
01111110
00000000
11111111
11111111
10011001
11111111
WAL false

TIL 35
00010000
00010000
00010000
00010000
00011111
00011111
00000111
00000111
WAL false

TIL 36
00001000
00001000
00001000
00001000
11111000
11111000
11100000
11100000
WAL false

TIL 37
00000100
01000100
01010000
00000000
11111111
11111111
11111111
00000000
WAL false

TIL 40
11111110
11111110
11000000
00000000
00000000
10000000
10000000
00000110
WAL true

TIL 41
00000000
00000011
00111111
00011111
00011111
11111111
11100010
01100000
WAL true

TIL 42
00001111
00011111
00111111
01111111
01111111
01111111
01111111
01111111
WAL true

TIL 43
00000000
00000000
00000000
00000001
00000001
00000011
00000011
00000111
WAL true

TIL 44
00111111
00111110
00100000
01100000
01110000
01111000
00111000
00000000
WAL true

TIL 45
00111111
00111111
00111111
00111111
00111111
00111111
00111111
00111111
WAL true

TIL 46
00011110
00001110
11000000
11111110
11111110
11111110
11111110
11111110
WAL true

TIL 47
11111100
11111110
11111111
11111111
11111111
11111111
11111111
11111111
WAL true

TIL 48
00000111
00000011
00000001
10000000
11000000
11000000
11100000
11110000
WAL true

TIL 49
11111110
11111110
11111110
00111110
00111110
00111110
00011110
00011110
WAL true

TIL 50
00000000
00000000
00000000
00000000
00000000
01111111
01000000
01111111
WAL true

TIL 51
00111111
01111110
10000100
10000100
10000100
11111100
00000100
11111100
WAL true

TIL 52
00000000
11111110
00000010
00000010
00000010
11111110
00011100
00000000
WAL true

TIL 53
00000000
01111111
01000110
01000110
01000110
01111111
01110000
00000000
WAL true

TIL 54
11111111
11110000
11111111
11111000
11111111
11111111
11111111
11111111

TIL 55
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
NAME interior wall

TIL 56
00000000
01111110
01111110
00000000
11111111
11111111
10011001
11111111

TIL 57
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
WAL false

TIL 58
11111111
11111111
11111011
11111001
10000000
11111001
11111011
11111111
NAME exit
WAL false

TIL 59
01011010
11100111
11100111
10111101
11111111
11111111
11111111
10000001
WAL false

TIL e
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
NAME space
WAL true

TIL f
11111111
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME grassborder
WAL true

TIL g
11111111
11111111
11111111
11111111
11111111
11101111
11101111
11111111
NAME star a

TIL h
11101111
11111111
10101010
11111111
11101111
11111111
11101111
11101111
NAME star a1

TIL i
11111111
11111111
11111100
11111111
11111111
11111111
11111111
11111111
NAME star a2

TIL j
11111111
11111111
01111111
11111111
11111111
11111111
11111111
11111111
NAME star a3

TIL k
11111111
11111101
11111111
11111111
11111111
11111111
11111111
11111111
NAME star b

TIL l
00000000
00000000
11111111
00000000
11111111
11111111
00000000
00000000
NAME rocket lip

TIL m
11111111
11111111
11111100
11111000
11110000
11100000
11000000
10000000
NAME rocket top l

TIL n
11111111
11111111
00111111
00011111
00001111
00000111
00000011
00000001
NAME rocket top 2

TIL o
11111111
11111111
11111111
11111111
11111111
11111111
11000000
11010101
NAME fence top l

TIL p
11111111
11111111
11111111
11111111
11111111
11111111
00000011
10101011
NAME fence top r

TIL q
00000000
10111100
11011010
11100110
11100110
11011010
10111100
00000000
NAME structure r

TIL r
00000000
00111101
01011011
01100111
01100111
01011011
00111101
00000000
NAME structure l

TIL s
11111111
11111111
11111111
10000001
00000000
00000000
00000000
00000000
NAME cloud 1

TIL t
11111111
11111111
11111111
11111111
11111111
11111110
11000110
10000010
NAME cloud 2

TIL u
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME cloud 

TIL v
11111111
11111111
11111111
11110000
11100000
11000000
11000000
11000000
NAME cloud 3

TIL w
00000000
00000000
00000000
00000000
00000000
00000000
11111111
11111111
NAME cloud 4

TIL x
11000000
11000000
11100000
11110000
11110000
10100000
11111111
11111111
NAME cloud 4

TIL z
11111111
11111111
11111111
11111111
11111111
11111100
11111101
11111101
NAME city 1

TIL 1a
11111111
11111111
11111111
11111111
11111111
11000000
10000000
10000000

TIL 1b
11111111
11111111
11111111
11111111
11111111
11111111
01111111
01111111

TIL 1c
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000

TIL 1d
01111111
00000111
00000011
00000001
00000001
00000001
00000001
00000001

TIL 1e
10000000
10000000
10000000
10000000
10000000
10000000
10000000
10000000

TIL 1f
11111111
11111111
01111111
00111111
00011111
00001111
00001100
00001111

TIL 1g
11111111
11000111
11000111
11101111
11101111
11111111
00000001
00000001

TIL 1h
10001100
11001100
11001100
11001100
11101100
11111111
00000000
00000000

TIL 1i
11111111
00110000
00110000
00110000
00110000
00110000
00110000
00110000

TIL 1j
11111111
00010001
00011111
00010001
00011111
00000000
00000000
00000000

TIL 1k
11111110
01000000
01000000
01000000
01000000
01000000
01000000
01000000

TIL 1l
11011111
11010001
11011111
11000000
11000000
11000000
11000000
11000000

TIL 1m
01111111
01111111
01111111
01111111
01111111
01111111
01111100
01111100

TIL 1n
00100111
00100000
00111000
01000100
00000010
00000010
00000010
11111110

TIL 1o
00000000
00000000
00000000
00000000
00000000
00000000
00000000
11111111

TIL 1p
11111111
11111111
11111111
11110000
11100000
11100000
01100000
00100000

TIL 1q
11111111
11111111
11111111
11111111
01111111
00100000
00100111
00100100

TIL 1r
11011111
00011111
00011111
00011111
11111111
11000000
11011111
11010001

TIL 1s
11111111
11111111
11111111
11111111
11111111
00011111
11011111
01011111

TIL 1t
10001100
11111111
11111111
11111111
11111111
01111111
01111111
01111111

TIL 1u
11111100
11111000
11110000
11100001
11000010
10000100
10001100
10001100

TIL 1v
11111111
11110000
11111111
11111111
11111111
11111111
11111110
11111111

TIL 1w
11111110
11000110
11000110
11101110
11101110
11111111
00000000
00000000

TIL 1x
01110001
01110011
01110011
01110011
01110111
11111111
00000000
00000000

TIL 1y
11000111
11001111
11001111
11001111
11011111
11111111
00000000
00000000

TIL 1z
11100011
11110011
11110011
11110011
11111011
11111111
00000000
00000000

TIL 2a
10000000
00000000
11111111
11111111
11111111
11111111
11111111
11111111

TIL 2b
01111110
01111110
01111110
00111010
00010010
00101010
01011010
10111010

TIL 2c
00001111
00001111
00001111
00001111
00001111
01111111
01111001
01111001

TIL 2d
01111111
01111111
01111111
01111111
00001111
00001111
00001111
00001111

TIL 2e
10000010
11111111
10000010
10000010
10000010
10000010
10000010
10000010

TIL 2f
10111010
10111010
10111010
10111010
10111010
10000010
10000010
10000010

TIL 2g
10000010
10000010
11000010
01100010
00111111
00011111
00110000
01110000

TIL 2h
00001111
11111111
00001111
00001111
00001111
11001111
10101111
10011111

TIL 2i
10001111
10000111
10000111
10000111
10000111
10000111
10000111
10000111

TIL 2j
10000111
10000111
10000111
10000101
10000101
11000111
11100111
10110111

TIL 2k
10011111
10001111
11000111
01100101
11110101
11111111
11001111
11111111

TIL 2l
00001000
00001111
00000111
00000111
00000000
00000000
00000000
00000000

TIL 2m
00011000
11111000
11111000
11111000
00000000
00000000
00000000
00000000

TIL 2n
00001111
00001000
00001000
00001000
00001000
00001000
11111000
11111000

TIL 2o
00000001
00000010
00000100
00001000
00001000
00001000
11111010
11111000

TIL 2p
10000000
01000000
00100000
00010000
00011000
00011000
01011111
00011111

TIL 2q
11111000
00011000
00011000
00011000
00011000
00011000
00011111
00011111

TIL 2r
00000000
00000000
00001000
00001000
00101010
00000000
00000000
00000000

TIL 2s
01111111
01111111
01111111
01111111
01111111
01000000
01000000
00000000
NAME window edge

TIL 2t
11111110
11111110
11111110
11111110
11111110
00000010
00000010
00000000
NAME window edge right

TIL 2u
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
NAME space 2
WAL false

TIL 2v
11111111
11111111
11111111
11111111
11111111
00000000
00000000
00000000
NAME window border

TIL 2w
01111111
01111111
01111111
01111111
01111111
01111111
01111111
01111111
NAME window side right
WAL true

TIL 2x
11111110
11111110
11111110
11111110
11111110
11111110
11111110
11111110

TIL 2y
11111110
11111101
11111011
11110111
11101111
11011111
10111111
01111111
WAL true

TIL 2z
01111111
10111111
11011111
11101111
11110111
11111011
11111101
11111110
WAL true

TIL 3b
00000000
00000000
00000000
00000000
00000000
01100000
01111111
00111111

TIL 3c
11111100
11111111
11111111
11111111
11111111
11111111
00011111
00001111

TIL 3d
00011111
11111111
11111111
11111111
11111111
11111111
11111111
11111110

TIL 3e
11111111
11111111
11111111
11111111
11111100
11111000
11110000
00000000

TIL 3f
11000000
10000000
00000011
00000111
00000111
00001111
00001111
00001111

TIL 3g
00111111
01111111
11111111
11111111
11111111
11111111
11111111
11111111

TIL 3h
11111111
11111111
11111111
11111111
11111111
11111111
11110000
11100000

TIL 3i
11111111
11111111
11111111
11111111
11111111
11111111
11111111
01111111

TIL 3j
00001111
00111111
01111111
11111111
11111111
11111111
11111111
11111111

TIL 3k
11111111
11111111
11110000
11100000
11000000
00000000
00000000
11111000

TIL 3l
11111111
00001111
11111111
00111111
11111111
11111111
11111111
11111111
WAL false

TIL 3m
11111111
11111111
11111111
11111111
11111111
11111111
11111111
00000000
WAL true

TIL 3n
11111111
11111111
11111111
11111111
11111111
11111111
11111111
00001111
WAL true

TIL 3o
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11110000
WAL true

TIL 3p
00000000
00000000
00000000
00000000
00000000
11100000
11111110
11111110
WAL true

TIL 3q
11111100
11111000
11111100
11111100
11111111
11111111
11111111
11111111
WAL true

TIL 3r
00011100
00000000
00000000
00000000
00000000
00000000
00000000
00000000
WAL true

TIL 3s
11100000
11110000
11110000
11111000
11111100
11111110
11111110
11111110
WAL true

TIL 3t
11111011
11111111
11111111
11111111
11111111
11111111
11111111
11111111
WAL true

TIL 3u
11111000
11111000
11111000
11111000
11111000
11111000
11111000
11111011
WAL true

TIL 3v
00000000
00000000
00000000
00000000
00000000
00000000
00000000
10000000
WAL true

TIL 3w
00011110
00111110
01111110
01111110
01111110
01111110
01111110
00111110
WAL true

TIL 3x
11111111
11111111
11111111
11111111
11111111
11111101
11111100
11111000
WAL true

TIL 3y
11111111
11110110
11110000
11110000
11000000
11000000
11000000
00000000
WAL true

TIL 3z
11111111
11111111
11111111
11111111
11111110
11111111
11111111
11111111
WAL true

TIL 4a
00011111
00011110
00001100
00000000
00000001
00000011
00000111
00000111
WAL true

TIL 4b
11111110
11111110
11111110
11111110
11111110
11111110
11111110
11111110
WAL true

TIL 4c
11100110
01000000
00000000
00000000
11100110
11111110
11111110
11111110
WAL true

TIL 4d
00111110
01111110
01111110
11111110
11111110
11111110
11111110
11100110
WAL true

TIL 4e
11110000
11100000
11000000
11000011
10000111
00000111
00000111
00001111
WAL true

TIL 4f
11111111
11111111
11111111
11111111
11111111
11111111
11111110
11111100
WAL true

TIL 4g
11111110
11111110
11111110
11111110
11111110
11000000
00000000
00011110
WAL true

TIL 4h
00011111
00011111
00011111
00111111
01111111
01111111
01111111
01111111
WAL true

TIL 4i
00001111
00001111
00001111
00001111
00001111
00001111
00001111
00001111
WAL true

TIL 4j
01111111
01111111
01111111
01111111
01111111
01011111
01011111
00001111
WAL true

TIL 4k
11111110
11111100
11111000
11110000
01110000
00110000
00000000
00000010
WAL true

TIL 4l
00000000
00000000
00000000
10000000
11000000
11100000
11111000
11111110
WAL true

TIL 4m
11111110
11111111
11111111
11111111
11111111
11111111
11111111
11111111
WAL true

TIL 4n
11111100
11111100
11111100
11111100
11111100
11111100
11111110
11111110
WAL true

TIL 4o
11111111
11111111
11111111
11111111
11111111
11111111
11111110
11111110
WAL true

TIL 4p
00000111
00000011
00000001
00000011
00000111
00000111
00000111
00000011
WAL true

TIL 4q
11111110
11111111
11111111
11111111
01111111
01111111
01111111
00111111
WAL true

TIL 4r
00000000
11011000
11111000
11110000
11110000
11100000
11100000
00000000
WAL true

TIL 4s
11111110
11111110
11111110
11111110
11111110
11111110
11111110
10000010
WAL true

TIL 4t
00000110
00000110
00000110
10000110
10000110
00001110
00011110
00111110
WAL true

TIL 4u
11111110
11111110
11111110
11111110
00111110
00011110
00001110
00000110
WAL true

TIL 4v
11111111
11111111
11111111
11111111
11111000
11111110
11111111
01111110
WAL true

TIL 4w
10111000
10001000
10000111
10000111
10000011
11000011
11100011
11110000
WAL true

TIL 4x
11111111
11111111
11100111
11000011
11000011
11100111
11111111
11111111

TIL 4y
00001000
00001000
00001000
00001000
00000000
00000000
00000000
00000000

TIL 4z
00000000
00000000
00000000
00000000
11111111
11111111
00000000
00000000

TIL 5a
01011010
11100111
11100111
10111101
11111111
11111111
11111111
10000001
WAL false

TIL 5b
00000000
01111110
01111110
00000000
11111111
11111111
11111111
00000000
WAL false

TIL 5c
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111

TIL 5d
11100111
11000111
11100111
11100111
11100111
11100111
11100111
10000001
NAME 1

TIL 5e
11111111
11100111
11000011
11011011
11011011
11000011
10000001
10111101

TIL 5f
00000000
00000000
01111100
01010100
11111111
11111111
11111111
01100110
WAL false

TIL 5g
11000011
10010001
10111001
11110001
11100011
11000111
10001111
10000001
NAME 2

TIL 5h
11100011
11000001
11011001
11110001
11110011
11011001
11000001
11100011
NAME 3

TIL 5i
11111001
11110001
11100101
11001101
11000000
11111001
11111001
11111001

TIL 5j
10000001
10011111
10011111
10000011
11111001
10111001
10000001
11000011

TIL 5k
11111111
11100111
11100111
11000011
10000001
01000010
11011011
11011011
NAME self

SPR 10
11111111
10000001
10000001
11111111
11000011
11000011
11000011
11111111
>
11111111
10000001
10000001
11111111
11000011
11111111
11000011
11111111
NAME family3
DLG SPR_l
POS 3 7,9

SPR 11
11111111
11000011
10000001
10000001
10111101
11100111
11000011
11000011
NAME desk3
DLG SPR_m
POS 3 3,9

SPR 12
11111111
10000001
11011011
10000001
10011001
10011001
10000001
11111111
>
11111111
11111111
10000001
11011011
10000001
10011001
10011001
10000001
NAME Food3
DLG SPR_n
POS 3 12,9

SPR 13
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
>
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
NAME Screen3

SPR 14
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME FamBoard3
DLG SPR_z
POS 3 6,9

SPR 15
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME WorkBoard3
DLG SPR_y
POS 3 2,9

SPR 16
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME LiveBoard3
DLG SPR_x
POS 3 11,9

SPR 17
11111111
10000001
10000001
11111111
11000011
11000011
11000011
11111111
>
11111111
10000001
10000001
11111111
11000011
11111111
11000011
11111111
NAME family4
DLG SPR_o
POS 4 7,9

SPR 18
11111111
11000011
10000001
10000001
10111101
11100111
11000011
11000011
NAME desk4
DLG SPR_q
POS 4 3,9

SPR 19
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
>
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
NAME screen4

SPR A
00000000
00011000
00011000
00111100
01111110
10111101
00100100
00100100
POS 0 7,13

SPR a
11111111
11101111
11101111
11111111
00101001
11111111
11101111
11101111
>
11111111
11111111
11101111
11111111
10101011
11111111
11101111
11111111
NAME star

SPR b
00000000
00111000
00111000
00111000
01111100
10111010
00111000
00101000
>
00000000
00111000
00111000
00111000
01111100
10111010
00111000
00101000
NAME partner
DLG SPR_b
POS 0 3,14

SPR e
00011000
00011000
00111110
01110111
00111110
00110110
00111110
00010100
NAME work dude
DLG SPR_a
POS 0 4,12

SPR h
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME FamBoard1
DLG SPR_4
POS 1 6,9

SPR i
11111111
11000011
10000001
10000001
10111101
11100111
11000011
11000011
>
11111111
11000011
10000001
10000001
10111101
11100111
11000011
11000011
NAME desk1
DLG SPR_6
POS 1 3,9

SPR l
00000000
00000000
00000000
00011100
00011100
00101010
00001000
00010100
NAME child
DLG SPR_c
POS 0 2,14

SPR m
00000000
00000000
00111000
00111010
01111110
10111000
00111000
00101000
>
00000000
00000000
00111000
00111001
01111110
10111000
00111000
00101000
NAME olderChild
DLG SPR_d
POS 0 4,14

SPR o
11111111
10000001
10000001
11111111
11000011
11000011
11000011
11111111
>
11111111
10000001
10000001
11111111
11000011
11111111
11000011
11111111
NAME family2
DLG SPR_j
POS 2 7,9

SPR q
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME WorkBoard1
DLG SPR_7
POS 1 2,9

SPR r
11111111
11000011
10000001
10000001
10111101
11100111
11000011
11000011
NAME desk2
DLG SPR_f
POS 2 3,9

SPR s
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
>
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
NAME Screen1

SPR t
11111111
10000001
11011011
10000001
10011001
10011001
10000001
11111111
>
11111111
11111111
10000001
11011011
10000001
10011001
10011001
10000001
NAME Food1
DLG SPR_e
POS 1 12,9

SPR u
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME LiveBoard1
DLG SPR_8
POS 1 11,9

SPR v
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
>
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
NAME Screen2

SPR w
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME FamBoard2
DLG SPR_g
POS 2 6,9

SPR x
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME WorkBoard2
DLG SPR_h
POS 2 2,9

SPR y
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME LiveBoard2
DLG SPR_i
POS 2 11,9

SPR z
11111111
10000001
11011011
10000001
10011001
10011001
10000001
11111111
>
11111111
11111111
10000001
11011011
10000001
10011001
10011001
10000001
NAME Food2
DLG SPR_k
POS 2 12,9

SPR 1a
11111111
10000001
11011011
10000001
10011001
10011001
10000001
11111111
>
11111111
11111111
10000001
11011011
10000001
10011001
10011001
10000001
NAME Food4
DLG SPR_p
POS 4 12,9

SPR 1b
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME FamBoard4
DLG SPR_u
POS 4 6,9

SPR 1c
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME WorkBoard4
DLG SPR_v
POS 4 2,9

SPR 1d
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME LiveBoard4
DLG SPR_w
POS 4 11,9

SPR 1e
11111111
10000001
10000001
11111111
11000011
11000011
11000011
11111111
>
11111111
10000001
10000001
11111111
11000011
11111111
11000011
11111111
NAME family5
DLG SPR_10
POS 5 7,9

SPR 1f
11111111
11000011
10000001
10000001
10111101
11100111
11000011
11000011
NAME desk5
DLG SPR_11
POS 5 3,9

SPR 1g
11111111
10000001
11011011
10000001
10011001
10011001
10000001
11111111
>
11111111
11111111
10000001
11011011
10000001
10011001
10011001
10000001
NAME Food5
DLG SPR_12
POS 5 12,9

SPR 1h
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
>
11111111
11111111
10000001
10000001
10000001
10000001
10000001
11111111
NAME screen5

SPR 1i
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME FamBoard5
DLG SPR_t
POS 5 6,9

SPR 1j
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME WorkBoard5
DLG SPR_s
POS 5 2,9

SPR 1k
11111111
10000001
10111101
10000001
10111101
10000001
10000001
11111111
NAME LiveBoard5
DLG SPR_r
POS 5 11,9

SPR 1l
11111111
11111111
11111111
00000001
01010100
01010100
00000001
11111111
>
11111111
11111111
00000001
01010100
01010100
00000001
11111111
11111111
NAME charge1
DLG SPR_13
POS 1 8,9

SPR 1m
11111111
10000001
10000001
11111111
11000011
11111111
11000011
11111111
>
11111111
10000001
10000001
11111111
11000011
11000011
11000011
11111111
NAME family1
DLG SPR_9
POS 1 7,9

SPR 1r
11111111
11111111
00000001
01010100
01010100
00000001
11111111
11111111
>
11111111
11111111
11111111
00000001
01010100
01010100
00000001
11111111
NAME charge 2
DLG SPR_14
POS 2 8,9

SPR 1s
11111111
11111111
11111111
00000001
01010100
01010100
00000001
11111111
>
11111111
11111111
00000001
01010100
01010100
00000001
11111111
11111111
NAME charge 3
DLG SPR_15
POS 3 8,9

SPR 1t
11111111
11111111
11111111
00000001
01010100
01010100
00000001
11111111
>
11111111
11111111
00000001
01010100
01010100
00000001
11111111
11111111
NAME charge 4
DLG SPR_16
POS 4 8,9

SPR 1u
11111111
11111111
11111111
00000001
01010100
01010100
00000001
11111111
>
11111111
11111111
00000001
01010100
01010100
00000001
11111111
11111111
NAME charge 5
DLG SPR_17
POS 5 8,9

SPR 1v
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
DLG SPR_18

ITM 1
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME Day3Prompt
DLG ITM_a

ITM 2
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME Day4Prompt
DLG ITM_3

ITM 3
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME Day5Prompt
DLG ITM_2

ITM 4
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME PowerPrompt
DLG ITM_4

ITM 5
00000000
00000000
00000000
00000000
00000000
00000000
00000000
00000000
NAME Inconvenience
DLG ITM_5

ITM 6
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
NAME transition 1 dialog
DLG ITM_6

ITM 7
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
NAME transition0.2
DLG ITM_0

ITM 8
11111111
11101111
11101111
11111111
00101001
11111111
11101111
11101111
>
11111111
11111111
11101111
11111111
10101011
11111111
11101111
11111111

ITM 9
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
DLG ITM_1

ITM a
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
DLG ITM_7

ITM b
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
DLG ITM_8

ITM c
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111
DLG ITM_9

ITM d
11111111
10011001
00000000
00000000
10000001
11000011
11100111
11111111
NAME relationships
DLG ITM_c

ITM e
11100111
11000011
11011011
11011011
11000011
11000011
10000001
10111101
NAME work
DLG ITM_b

ITM f
11111111
11100111
11100111
11000011
10000001
01000010
11011011
11011011
NAME self
DLG ITM_d

DLG SPR_0
grrrrr

DLG SPR_1
NAVIGATING YOUR RESEARCH BAY:Use the monitor on the left to contact your research supervisor at Asterius.The monitor on the right may be used to contact your family on Earth.Good luck, brave traveler. 

DLG SPR_2
NAVIGATING YOUR RESEARCH BAY: Use the monitor on the left to contact your research supervisor at Asterius. The monitor on the right may be used to contact your family on Earth. Good luck, brave traveler. 

DLG SPR_3
NAVIGATING YOUR RESEARCH BAY --- Use the monitor on the left to contact your research supervisor at Asterius. The monitor on the right may be used to contact your family on Earth. On the far side of the room is your work station. 

DLG SPR_4
Your communication console is located here. You may use it to contact your family on Earth. Doing so will consume some of your ship's daily charge however.

DLG SPR_5
{shk}{shk}

DLG SPR_a
"""
{cycle
  - There's not much time left before takeoff, but you should say goodbye before you go. The ship only has a limited number of energy each day, so communication will be hard up there. When you're ready, the car will take you to the rocket.
  - Be careful out there. Remember your training, and stay safe. If all goes well, you should be able to set up communications and navigation routes with us once you land for your journey back home. Once you've landed, your ship is equipped to harvest enough solar power to re-establish contact, so don't forget to stay on top of your ship's condition throughout the trip! 
}
"""

DLG SPR_c
"""
{shuffle
  - Are you really going up into space? To that planet that just showed up?
  - Are there gonna be aliens up there?
  - ...You're not going away forever are you?
}
"""

DLG SPR_d
"""
{cycle
  - You better remember to call us everyday!
  - Don't blow up in space or anything crazy like that...
}
"""

DLG SPR_b
"""
{cycle
  - Be safe up there, honey. I know you'll be busy up there with working and taking care of yourself...but please remember us.
  - I'll be thinking about you every day. 
  - You know what they say...absence makes the heart grow fonder. I know it's not up to you but, please don't be gone for too long...we love you.
}
"""

DLG SPR_f
"""
You approach your work desk 
{ActionsDay2 = ActionsDay2 + 1} {
  - ActionsDay2 < 4 ?
    {sequence
      - and fire up the ship’s photo-telescope and make sure it's working properly. You set it to periodically take some pictures of the surrounding celestial bodies. The Earth appears much further away today. A strange sense of isolation begins to well up within you as you observe the blue planet in its entirety.
      - and come back to inspect your telescope and find that it has malfunctioned. It takes you a couple hours to repair it back to functioning condition.
      - and come back to inspect your telescope and find that it has malfunctioned. It takes you a couple hours to repair it back to functioning condition. 
      - and after one more inspection you’re notified of a problem with your waste-to-water filtration systems. You waste no time repairing it; the thought of colonizing another planet with only your own "liquid" supply  is one you'd rather not dwell on.
    } 
    {Work = Work + 1}
  - ActionsDay2 > 3 ?
    However, you don't have enough power to run a scan of your ship's condition right now.
}
"""

DLG SPR_7
This is your workstation. Here, you may find several of the tools necessary to perform maintenance and inspections of your ship's equipment.

DLG SPR_8
These are your living quarters. Your bed, food supply, and exercise equipment can be found here.

DLG SPR_6
"""
You approach your work desk and begin to diagnose any problems with the ship.
{ActionsDay1 = ActionsDay1 + 1}{
  - ActionsDay1 < 4 ?
    {sequence
      - You inspect the ship's artificial gravity generator for any problems. There's a minor anomaly with the gravity well projector and you spend a couple hours repairing it...This solitary work gives you a peace of mind you haven't felt in a while.
      - You run another scan of your starship's current condition.  According to the readout, there is a break in one of your ship's navigation circuits, so you break out some soldering tools and spend a while restoring it.
      - You decide to use your last charge of the day to run a final scan of your ship. For now, everything seems fine, so you enable your shuttle's auto-repair systems to fix any issues that might come up.
    }
    {Work = Work + 1}
  - ActionsDay1 > 3 ?
    However, you don't have enough power to run a scan of your ship's condition right now.
}
"""

DLG SPR_e
"""
Inside your living quarters, 
{ActionsDay1 = ActionsDay1 + 1}{
  - ActionsDay1 < 4 ?
    {sequence
      - you spend some time doing cardio exercise on your treadmill. Afterwards, you approach your rations container and prepare some food to eat. Your food supply is mostly dehydrated thermostabilized hyper-nourishing hydroxylatable nutrition product provided by the company's food scientists - bland but nutritious.
      - you try doing some calisthenics to help yourself adjust to the feel of your ship's artificial gravity. Your body feels a bit lighter than it did on Earth. 
      - you decide to prepare one more meal before the day's end. It makes you regret not sneaking on some actual food before you left...
    }
    {Self = Self + 1}
  - ActionsDay1 > 3 ?
    you attempt to get some food to eat, but there is not enough power left to rehydrate your rations right now. 
}
"""

DLG SPR_g
Your communication console is located here. You may use it to contact your family on Earth. Doing so will consume some of your ship's daily charge however.

DLG SPR_h
This is your workstation. Here, you may find several of the tools necessary to perform maintenance and inspections of your ship's equipment.

DLG SPR_i
These are your living quarters. Your bed, food supply, and exercise equipment can be found here.

DLG SPR_j
"""
You activate the family-contact computer.
{ActionsDay2 = ActionsDay2 + 1}{
  - ActionsDay2 < 4 ?
    You receive a signal back from your family.
    {sequence
      - You hear the voice of your partner: "Hey there cosmonaut. Is everything going alright up there? Remember, it's the little one’s birthday tomorrow, so don't forget to call and wish him happy birthday."
      - You hear the voice of your oldest child: "Good morning...Well, it's morning here anyways. Are you doing okay? I never actually apologized for sneaking out of the house that night the week before you left so, I guess I'll do it now...sorry about that."
      - You hear the voice of your youngest child: "Heeey! How's space? Is it cold? Is it scary? Did you find aliens yet? I told my class about you in school today. Everybody else's parents have boring jobs, but yours is the coolest, and everybody said so too!"
    }
    {Family = Family + 1}
  - ActionsDay2 > 3 ?
    However, you do not have enough power to send another signal to Earth right now. Perhaps you'll try again tomorrow.
}
"""

DLG SPR_k
"""
Inside your living quarters, 
{ActionsDay2 = ActionsDay2 + 1}{
  - ActionsDay2 < 4 ?
    {shuffle
      - after rehydrating some food, you eat it while sitting on your bed and staring out your window. You try staring at Earth long enough to see it grow smaller as you sail through space. 
      - you do some stretches on the floor next to your bed. As you touch your hands to your toes, you feel a rush of clarity and strength in your mind and body. You realize you hadn’t quite given yourself much time to sit and think since you’ve been up here. You wonder if your partner and children are thinking about you right now.
      - you open up the storage module containing your rations and find something to eat. Today you settle on tacos. The taste is noticeably different than any taco back on Earth, but you manage to get it down. Musingly, you wonder if this is the farthest away from Earth that anyone’s ever eaten a taco.
    }
    {Self = Self + 1}
  - ActionsDay2 > 3 ?
    you attempt to get some food to eat, but there is not enough power left to rehydrate your rations right now. 
}
"""

DLG SPR_l
"""
You activate the family-contact computer.
{ActionsDay3 = ActionsDay3 + 1}{
  - ActionsDay3 < 3 ?
    You receive a signal back from your family.
    {sequence
      - You hear the voice of your youngest child: "Hi! How old am I now? I'm 6 years old now! They bought me a huuuuge cake for my party and we're about to eat all of it!"
      - You hear the voice of your partner: "Thanks for calling earlier. He was so excited and spent all day telling his friends about you. He loved the present you got him. Wish you could be here for this."
    }
    {Family = Family + 1}
{Birthday = 1}
{Ignore = Ignore - 1}
  - ActionsDay3 > 2 ?
    However, you do not have enough power to send another signal to Earth right now. Perhaps you'll try again tomorrow.
}
"""

DLG SPR_m
"""
You approach your work desk 
{ActionsDay3 = ActionsDay3 + 1} {
  - ActionsDay3 < 3 ?
    {sequence
      - and scan the ship's engine to see if there's anything wrong...The engine seems to be overheating slightly, so you power on the ship's auto-repair systems to fix it.
      - and run another scan of your starship and are alerted that your ship's oxygen levels are slightly lower than the recommended amount. You dedicate the rest of the day to fixing your oxygen synthesizer.
    }
    {work = Work + 1}
  - ActionsDay3 > 2 ?
    However, you don't have enough power to run a scan of your ship's condition right now.
}
"""

DLG SPR_n
"""
Inside your living quarters, 
{ActionsDay3 = ActionsDay3 + 1}{
  - ActionsDay3 < 3 ?
    {sequence
      - The claustrophobia of your spacecraft is beginning to get to you, so you lie on your bed, legs crossed, and meditate. First you try not to think, and when that fails you try to think about nothing. After that doesn't work you try counting sheep. Ultimately your mind drifts off and you end up dozing off for a bit. You realize you probably should’ve paid more attention in the yoga classes you and your partner used to attend... 
      - you decide to lift some weights today. You can tell that your body is getting more used to life in space, and the slight 'off-ness' of the simulated gravity is becoming less and less noticeable.
    }
    {Self = Self + 1}
  - ActionsDay3 > 2 ?
    you attempt to get some food to eat, but there is not enough power left to rehydrate your rations right now. 
}
"""

DLG SPR_o
"""
You activate the family-contact computer.
{ActionsDay4 = ActionsDay4 + 1}{
  - Birthday < 1 ?
    You receive a message back from your family, but the strength of the signal is much weaker today...
    You hear the voice of your partner: "Hey, I-...busy, and if-...understand-...least you-...was call once-...I gav-...gift, but-...you.”
  - Birthday == 1 ?
    You receive a message back from your family, but the strength of the signal is much weaker today...
    {sequence
      - You hear the voice of your partner: "Hey-...-ou hear me? I-...glad you’ve been-...to keep up-...I hope you can-...will-...able to come back? Please-...love you."
      - You hear the voice of your oldest child: "What’s up? Guess what-...-today? Me and Jessi-...and then-...to the whole school! Hey, is-...hard-...hear for you? I can’t-...what you’re saying...hello...?"
    }
    {Family = Family + 1}
{Ignore = Ignore - 1}
  - ActionsDay4 > 2 ?
    However, you do not have enough power to send another signal to Earth right now. Perhaps you'll try again tomorrow.
}
"""

DLG SPR_p
"""
Inside your living quarters, 
{ActionsDay4 = ActionsDay4 + 1}{
  - ActionsDay4 < 3 ?
    {sequence
      - you open your rations container and prepare some food to eat. You decide on some spaghetti. It reminds you of the spaghetti your partner used to make, but it's nowhere near as good. A sense of uneasiness washes over you as you realize all your memories of home were made on the ball you can see through your window.
      - you decide to do some cycling today. You spend several minutes on the ergometer until your motion becomes almost trance-like. The physical activity makes you feel relaxed, but it's not quite enough to distract you from that certain feeling of loneliness brought on by your isolation.
    }
    {Self = Self + 1}
  - ActionsDay4 > 2 ?
    you attempt to get some food to eat, but there is not enough power left to rehydrate your rations right now. 
}
"""

DLG SPR_q
"""
You approach your work desk,
{ActionsDay4 = ActionsDay4 + 1} {
  - ActionsDay4 < 3 ?
    {sequence
      - and perform a routine inspection of your ship's navigation systems. You spend some time repairing a slight imbalance in the ship's orientation sensor.
      - and notice that your scan reveals that the compression rating of the ship's airlock is below recommended levels. You spend around an hour fixing the issue.
    }
    {Work = Work + 1}
  - ActionsDay4 > 2 ?
    However, you don't have enough power to run a scan of your ship's condition right now.
}
"""

DLG SPR_r
These are your living quarters. Your bed, food supply, and exercise equipment can be found here.

DLG SPR_s
This is your workstation. Here, you may find several of the tools necessary to perform maintenance and inspections of your ship's equipment.

DLG SPR_t
Your communication console is located here. You may use it to contact your family on Earth. Doing so will consume some of your ship's daily charge however.

DLG SPR_u
Your communication console is located here. You may use it to contact your family on Earth. Doing so will consume some of your ship's daily charge however.

DLG SPR_v
This is your workstation. Here, you may find several of the tools necessary to perform maintenance and inspections of your ship's equipment.

DLG SPR_w
These are your living quarters. Your bed, food supply, and exercise equipment can be found here.

DLG SPR_x
These are your living quarters. Your bed, food supply, and exercise equipment can be found here.

DLG SPR_y
This is your workstation. Here, you may find several of the tools necessary to perform maintenance and inspections of your ship's equipment.

DLG SPR_z
Your communication console is located here. You may use it to contact your family on Earth. Doing so will consume some of your ship's daily charge however.

DLG SPR_10
"""
You activate the family-contact computer.
{ActionsDay5 = ActionsDay5 + 1}{
  - Ignore == 2 ?
    ...But you don't receive a signal back.
  - Ignore < 1 ?
    You receive a message back from your family, but the strength of the signal is almost nonexistent...
    You struggle to hear the voice of your partner: "Hey-...know you-...but-...let you know-...glad you-...every day."
    {Family = Family + 1}
  - ActionsDay5 > 1 ?
    However, you do not have enough power to send another signal to Earth right now.
  - Ignore == 1 ?
    You receive a message back from your family, but the strength of the signal is almost nonexistent...
    You struggle to hear the voice of your partner: "...good-...your voi-...Sorry for-...-time."
    {Family = Family + 1}
}
"""

DLG SPR_11
"""
You approach your work desk,
{ActionsDay5 = ActionsDay5 + 1} {
  - ActionsDay5 == 1 ?
    and diagnose the damage to your ship. Surveying the contact zone, it seems like a small asteroid collided with your vessel, but the damage was minimal as far as you can tell. You prepare for a space walk and spend some time repairing the damage.
    {Work = Work + 1}
  - ActionsDay5 > 1 ?
    However, you don't have enough power to run a scan of your ship's condition right now.
}
"""

DLG SPR_12
"""
Inside your living quarters, 
{ActionsDay5 = ActionsDay5 + 1}{
  - ActionsDay5 == 1 ?
    you grab a quick bite to eat from your ration storage and spend some time on your treadmill. As you run, you look outside your observation bay window. Earth is little more than a small blue dot now. You wonder about your family down there millions of miles away. In a way, you can see everyone in the world now...For a moment, your breath catches in your chest and your heart skips a beat as you gaze upon a sight that, before today, was only visible to one's imagination...     
    
    {Self = Self + 1} 
  - ActionsDay5 > 1 ?
    you attempt to get some food to eat, but there is not enough power left to rehydrate your rations right now. 
}
"""

DLG ITM_2
{shk}CCCRRRSSHSHH{shk} You hear and feel the startling rumble of an impact on the ship’s hull...

DLG ITM_3
"""
{
  - ActionsDay4 == 0 ?
    You step into your living quarters and notice that the coordinates displayed on your ship's navigation screen are slightly off-course...
  - ActionsDay4 == 1 ?
    You step into your living quarters and notice that your ship's pressure readings are lower than normal...
}
"""

DLG ITM_4
As you enter the bridge, you think to yourself about what you'll do today... Your ship doesn't have much energy left before the final landing.

DLG ITM_5
"""
Your ship's status readout suddenly displays a warning screen. It seems you've unexpectedly passed through an unseen electric field. It may have left you out of charges for the day...
{ActionsDay2 = 4}
"""

DLG ITM_6
{shk}As the rocket begins to rumble, you wonder if you will you be ready for what you'll face up there. Your last thoughts on Earth are of the people you've left behind.{shk}

DLG SPR_9
"""
You activate the family-contact computer.
{ActionsDay1 = ActionsDay1 + 1}{
  - ActionsDay1 < 4 ?
    You receive a signal back from your family.
    {sequence
      - You hear the voice of your partner: "Hey, honey. It's only been a day and we already miss you back home, but we're getting by...Your mission supervisor - what was his name again - Dr. Andrews, told me that your calls might be limited just before you left. So, do what you have to, but don't forget to call us if you can help it."  
      - You hear the voice of your youngest child: "Hey!!! I heard the screen thingy ringing so I answered it. Are you having fun in space? I wish I could've gone up there with you...Maybe I'll be an astronaut too when I grow up!"
      - You hear the voice of your oldest child: "How's it going? Yeah, I'm alright. School's fine, I guess. You know I give you the same answers every day, right? Just because you're a million miles away doesn't mean anything's different down here y'know...But thanks for looking out for us. I love you too."
    }
    {Family = Family + 1}
  - ActionsDay1 > 3 ?
    However, you do not have enough power to send another signal to Earth right now. Perhaps you'll try again tomorrow.
}
"""

DLG ITM_0
You think back to your training...You can access each of the facilities on the ship by using a charge. A ship like this can only gain three charges from solar energy each day. As you drift further from Earth's sun, your charges may decrease each day.

DLG SPR_13
"""
You check on how many charges you have used today.{
  - ActionsDay1 > 3 ?
    You have used all charges.
  - ActionsDay1 < 4 ?
    You have used {say ActionsDay1} charges.
}
"""

DLG SPR_14
"""
You check on how many charges you have used today.{
  - ActionsDay2 > 3 ?
    You have used all charges.
  - ActionsDay2 < 4 ?
    You have used {say ActionsDay2} charges.
}
"""

DLG SPR_15
"""
You check on how many charges you have used today.{
  - ActionsDay3 > 2 ?
    You have used all charges.
  - ActionsDay3 < 3 ?
    You have used {say ActionsDay3} charges.
}
"""

DLG SPR_16
"""
You check on how many charges you have used today.{
  - ActionsDay4 > 2 ?
    You have used all charges.
  - ActionsDay4 < 3 ?
    You have used {say ActionsDay4} charges.
}
"""

DLG SPR_17
"""
You check on how many charges you have used today.{
  - ActionsDay5 > 1 ?
    You have used all charges.
  - ActionsDay5 < 2 ?
    You have used {say ActionsDay5} charges.
}
"""

DLG ITM_1
You rise out of bed and step into the second day of your interstellar journey. Waking up in space, the previous day feels almost like a dream, proven real only by the fact that you can see planet you came from even farther away than before. You have 3 charges today.

DLG ITM_7
Your alarm rings and you awake on the third day. Back on Earth, you never had the luxury of being awoken by the sunrise, having to go to work training for your mission early in the mornings, but you do miss at least seeing the bright ball in the sky throughout the day. Due to the orientation of your vessel, you can only see the Earth from your window...Putting your mind back on your mission, you remember that you should have about 2 charges today.

DLG ITM_8
It is the penultimate day of your mission. By the end of tomorrow, you'll take your first hesitant steps onto a strange new world. You should have around 2 charges today.

DLG ITM_9
You awake on the last day of your trip. This far into your journey and nearing its end, you figure you only have a single charge left for today. You wonder how you’ll use it...

DLG ITM_a
As you step into the bridge of your ship, you hear a faint rumbling noise. Something may be wrong with the engine...

DLG SPR_18
"""
{
  - ActionsDay1 == 1 ?
    hey
  - ActionsDay1 < 1 ?
    yo
}{
  - {item "0"} == 1 ?

  - else ?

}
"""

DLG ITM_b
"""
{
  - Work == 0 ?
    You've landed safely on the strange new planet, thus successfully completing the first half of your mission. You attempt to get a signal out to your mission supervisor  to inform them of a job well done, but as you try to power on your communicator, you find that you haven't collected any solar energy here as you'd planned. Your ship's solar thermal collector is irreparably damaged, along with many other of your ship's vital systems and equipment. With your ship in such a poor condition, you wonder if it will even be possible to escape this world at all, or if you're completely stranded forever...
  - Work == 1 ?
    You inspect your ship as you land on the strange new planet, and find that it is in rather poor condition. You regret not maintaining it diligently enough throughout your journey, but you can tell that your communication systems are at least still functioning. However, you notice a small asteroid lodged inside your ship's thrusters...Returning home at this rate may prove difficult, if not impossible...
  - Work == 2 ?
    You inspect your ship as you land on the strange new planet, and find that it is in rather poor condition. You regret not maintaining it diligently enough throughout your journey, but you can tell that your communication systems are at least still functioning. However, you notice a small asteroid lodged inside your ship's thrusters...Returning home at this rate may prove difficult, if not impossible...
  - Work == 3 ?
    You inspect your ship as you land on the strange new planet, and find that it is in rather poor condition. You regret not maintaining it diligently enough throughout your journey, but you can tell that your communication systems are at least still functioning. However, you notice a small asteroid lodged inside your ship's thrusters...Returning home at this rate may prove difficult, if not impossible...
  - Work == 4 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work == 5 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work == 6 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work == 7 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth. 
  - Work == 8 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work > 8 ?
    You inspect your ship as you land on the strange new planet, and find that it is in utterly pristine condition. Due to your efforts along the way, it's almost a more capable vessel than it was on the day you first left Earth. You have more than enough reserve power to send a signal to your mission supervisor on Earth.
}
"""

DLG ITM_c
"""
{
  - Family == 0 ? 
    You manage to get a signal out to your family, but you don't receive a signal back. Despite your pleas, your voice is only met with silence.
  - Family == 1 ?
    You manage to get a signal out to your family, but you don't receive a signal back...Eventually you try again, and this time, you receive a reply. You hear the voice of your partner: "...Hello? Honey? Oh, you're okay? That's good. After you hadn't called for a while, I thought something was wrong, so I talked with your supervisor. He told me they'd never lost contact with your ship...So why didn't you call us? I know, I know, you couldn't call all day, every day. But we were worried about you...just enough to show us you were alright would've been nice...Still, I'm happy for you. Please don't make me worry like that again, okay? Be safe up there..."
  - Family == 2 ?
    You manage to get a signal out to your family, but you don't receive a signal back...Eventually you try again, and this time, you receive a reply. You hear the voice of your partner: "...Hello? Honey? Oh, you're okay? That's good. After you hadn't called for a while, I thought something was wrong, so I talked with your supervisor. He told me they'd never lost contact with your ship...So why didn't you call us? I know, I know, you couldn't call all day, every day. But we were worried about you...just enough to show us you were alright would've been nice...Still, I'm happy for you. Please don't make me worry like that again, okay? Be safe up there..."
  - Family == 3 ?
    You manage to get a signal out to your family, but you don't receive a signal back...Eventually you try again, and this time, you receive a reply. You hear the voice of your partner: "...Hello? Honey? Oh, you're okay? That's good. After you hadn't called for a while, I thought something was wrong, so I talked with your supervisor. He told me they'd never lost contact with your ship...So why didn't you call us? I know, I know, you couldn't call all day, every day. But we were worried about you...just enough to show us you were alright would've been nice...Still, I'm happy for you. Please don't make me worry like that again, okay? Be safe up there..."
  - Family == 4 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 5 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 6 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 7 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 8 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family > 8 ?
    Despite the poor condition of your ship, through desperation you manage to get one last signal out to your family so far away on Earth. You receive a signal back, and you hear the voice of your partner: "Hello? Honey!? Did you make it there safe? Oh, I'm so proud of you! I knew you could do it! I was so worried the whole week...You know I thought about you every day, hoping you'd get there safe and sound. All the kids ever talked about with their friends the whole week was you, you're practically a superstar! I'm almost afraid no one will believe me when I tell them about you!...What? What about your ship? What do you mean you might not be coming home?" You explain to your partner the dire condition of your ship, and your grim prospects of returning to Earth. Your partner's brokenhearted weeping is all you'll be able to hear for the next few nights...
}
"""

DLG ITM_d
"""
{
  - Self == 0 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth...However, you take another breath and feel a sudden rush of nausea wash over you. For whatever reason, you neglected to eat even once during your journey. But now, as you lie crumbling on the ground of this alien rock, you at least find solace in the fact that you completed this much of your mission....Your last thoughts are of home.
  - Self == 1 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 2 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 3 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 4 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 5 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 6 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 7 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 8 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way. 
  - Self > 8 ?
    On the surface of this new planet, you take a deep, hearty breath. Just as you were told, the air here is just as breathable as it was on Earth. Your body feels vital and strong, and thanks to this planet's lighter gravity, you take a mighty leap into the air and let out a shout of joy. Despite your childlike excitement at the prospect of exploring a whole new world, the reality of your situation concerning your ship and your family sets in...Suddenly, you become stricken with an intense sense of guilt... 
}
"""

END 0
"""
{
  - Work == 0 ?
    You've landed safely on the strange new planet, thus successfully completing the first half of your mission. You attempt to get a signal out to your mission supervisor  to inform them of a job well done, but as you try to power on your communicator, you find that you haven't collected any solar energy here as you'd planned. Your ship's solar thermal collector is irreparably damaged, along with many other of your ship's vital systems and equipment. With your ship in such a poor condition, you wonder if it will even be possible to escape this world at all, or if you're completely stranded forever...
  - Work == 1 ?
    You inspect your ship as you land on the strange new planet, and find that it is in rather poor condition. You regret not maintaining it diligently enough throughout your journey, but you can tell that your communication systems are at least still functioning. However, you notice a small asteroid lodged inside your ship's thrusters...Returning home at this rate may prove difficult, if not impossible...
  - Work == 2 ?
    You inspect your ship as you land on the strange new planet, and find that it is in rather poor condition. You regret not maintaining it diligently enough throughout your journey, but you can tell that your communication systems are at least still functioning. However, you notice a small asteroid lodged inside your ship's thrusters...Returning home at this rate may prove difficult, if not impossible...
  - Work == 3 ?
    You inspect your ship as you land on the strange new planet, and find that it is in rather poor condition. You regret not maintaining it diligently enough throughout your journey, but you can tell that your communication systems are at least still functioning. However, you notice a small asteroid lodged inside your ship's thrusters...Returning home at this rate may prove difficult, if not impossible...
  - Work == 4 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work == 5 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work == 6 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work == 7 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth. 
  - Work == 8 ?
    You inspect your ship as you land on the strange new planet, and find that it is in generally good condition. Some of your vessel's peripherals appear to be lightly damaged, but otherwise there is little to worry about. After collecting enough solar energy, you manage to send a signal to your mission supervisor on Earth.
  - Work > 8 ?
    You inspect your ship as you land on the strange new planet, and find that it is in utterly pristine condition. Due to your efforts along the way, it's almost a more capable vessel than it was on the day you first left Earth. You have more than enough reserve power to send a signal to your mission supervisor on Earth.
}{
  - Family == 0 ? 
    You manage to get a signal out to your family, but you don't receive a signal back. Despite your pleas, your voice is only met with silence.
  - Family == 1 ?
    You manage to get a signal out to your family, but you don't receive a signal back...Eventually you try again, and this time, you receive a reply. You hear the voice of your partner: "...Hello? Honey? Oh, you're okay? That's good. After you hadn't called for a while, I thought something was wrong, so I talked with your supervisor. He told me they'd never lost contact with your ship...So why didn't you call us? I know, I know, you couldn't call all day, every day. But we were worried about you...just enough to show us you were alright would've been nice...Still, I'm happy for you. Please don't make me worry like that again, okay? Be safe up there..."
  - Family == 2 ?
    You manage to get a signal out to your family, but you don't receive a signal back...Eventually you try again, and this time, you receive a reply. You hear the voice of your partner: "...Hello? Honey? Oh, you're okay? That's good. After you hadn't called for a while, I thought something was wrong, so I talked with your supervisor. He told me they'd never lost contact with your ship...So why didn't you call us? I know, I know, you couldn't call all day, every day. But we were worried about you...just enough to show us you were alright would've been nice...Still, I'm happy for you. Please don't make me worry like that again, okay? Be safe up there..."
  - Family == 3 ?
    You manage to get a signal out to your family, but you don't receive a signal back...Eventually you try again, and this time, you receive a reply. You hear the voice of your partner: "...Hello? Honey? Oh, you're okay? That's good. After you hadn't called for a while, I thought something was wrong, so I talked with your supervisor. He told me they'd never lost contact with your ship...So why didn't you call us? I know, I know, you couldn't call all day, every day. But we were worried about you...just enough to show us you were alright would've been nice...Still, I'm happy for you. Please don't make me worry like that again, okay? Be safe up there..."
  - Family == 4 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 5 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 6 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 7 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family == 8 ?
    You manage to get a signal out to your family, and after receiving a signal back, you hear the voice of your partner: "Hey, honey! Did you make it there safe? Great, I'm so proud of you! I knew you could do it, babe...It's alright, I know you had other things to do. I'm glad you at least called when you could. But don’t ever leave me worried like that again, okay...I'm just happy everything went alright out there. You have to take some pictures for me and the kids. Please promise you'll come back?"
  - Family > 8 ?
    Despite the poor condition of your ship, through desperation you manage to get one last signal out to your family so far away on Earth. You receive a signal back, and you hear the voice of your partner: "Hello? Honey!? Did you make it there safe? Oh, I'm so proud of you! I knew you could do it! I was so worried the whole week...You know I thought about you every day, hoping you'd get there safe and sound. All the kids ever talked about with their friends the whole week was you, you're practically a superstar! I'm almost afraid no one will believe me when I tell them about you!...What? What about your ship? What do you mean you might not be coming home?" You explain to your partner the dire condition of your ship, and your grim prospects of returning to Earth. Your partner's brokenhearted weeping is all you'll be able to hear for the next few nights...
}{
  - Self == 0 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth...However, you take another breath and feel a sudden rush of nausea wash over you. For whatever reason, you neglected to eat even once during your journey. But now, as you lie crumbling on the ground of this alien rock, you at least find solace in the fact that you completed this much of your mission....Your last thoughts are of home.
  - Self == 1 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 2 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 3 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 4 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 5 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 6 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 7 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 8 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way. 
  - Self > 8 ?
    On the surface of this new planet, you take a deep, hearty breath. Just as you were told, the air here is just as breathable as it was on Earth. Your body feels vital and strong, and thanks to this planet's lighter gravity, you take a mighty leap into the air and let out a shout of joy. Despite your childlike excitement at the prospect of exploring a whole new world, the reality of your situation concerning your ship and your family sets in...Suddenly, you become stricken with an intense sense of guilt... 
}    
"""

END 1
"""
{
  - Self == 0 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth...However, you take another breath and feel a sudden rush of nausea wash over you. For whatever reason, you neglected to eat even once during your journey. But now, as you lie crumbling on the ground of this alien rock, you at least find solace in the fact that you completed this much of your mission....Your last thoughts are of home.
  - Self == 1 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 2 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 3 ?
    After inspecting your ship and calling your family, you take a step out onto the planet you've landed on. You fail to keep your balance as your legs wobble under your own weight. You can feel your atrophied muscles struggling to keep you on your feet, and your breath is short and heavy. The atmosphere here is safe to breathe, as expected, but the shock of your inability to adjust has taken you by surprise. With great effort, you rise to your feet, and prepare to face the challenge of taming this new land...If you can survive, that is.
  - Self == 4 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 5 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 6 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 7 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way.
  - Self == 8 ?
    On the surface of this new planet, you take a deep breath. Just as you were told, the air here is just as breathable as it was on Earth. The lighter gravity takes a bit of getting used to, but it isn't too bad. The prospect of having to eat your "space food" rations every day is less than appealing, but you think making a living here will be rewarding in it's own way. 
  - Self > 8 ?
    On the surface of this new planet, you take a deep, hearty breath. Just as you were told, the air here is just as breathable as it was on Earth. Your body feels vital and strong, and thanks to this planet's lighter gravity, you take a mighty leap into the air and let out a shout of joy. Despite your childlike excitement at the prospect of exploring a whole new world, the reality of your situation concerning your ship and your family sets in...Suddenly, you become stricken with an intense sense of guilt... 
}
You wonder how you would have dealt with this distance another time.
"""

VAR ActionsDay1
0

VAR ActionsDay2
0

VAR ActionsDay3
0

VAR ActionsDay4
0

VAR ActionsDay5
0

VAR Family
0

VAR Work
0

VAR Self
0

VAR Birthday
0

VAR Ignore
2


</script>

<style>
html {
	margin:0px;
	padding:0px;
}

body {
	margin:0px;
	padding:0px;
	overflow:hidden;
	background:#ffffff;
}

#game {
	background:black;
	width:100vw;
	max-width:100vh;
	margin:auto;
	display:block;
}
</style>

<!-- SCRIPTS -->
<script>
function startExportedGame() {
	attachCanvas( document.getElementById("game") );
	load_game( document.getElementById("exportedGameData").text.slice(1) );
}
</script>

<script>
//hex-to-rgb method borrowed from stack overflow
function hexToRgb(hex) {
	// Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
	var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
	hex = hex.replace(shorthandRegex, function(m, r, g, b) {
		return r + r + g + g + b + b;
	});

	var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
	return result ? {
		r: parseInt(result[1], 16),
		g: parseInt(result[2], 16),
		b: parseInt(result[3], 16)
	} : null;
}
function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
}
function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

function hslToHex(h,s,l) {
    var rgbArr = hslToRgb(h,s,l);
    return rgbToHex( Math.floor(rgbArr[0]), Math.floor(rgbArr[1]), Math.floor(rgbArr[2]) );
}

function hexToHsl(hex) {
    var rgb = hexToRgb(hex);
    return rgbToHsl(rgb.r, rgb.g, rgb.b);
}

// really just a vector distance
function colorDistance(a1,b1,c1,a2,b2,c2) {
    return Math.sqrt( Math.pow(a1 - a2, 2) + Math.pow(b1 - b2, 2) + Math.pow(c1 - c2, 2) );
}

function hexColorDistance(hex1,hex2) {
    var color1 = hexToRgb(hex1);
    var color2 = hexToRgb(hex2);
    return rgbColorDistance(color1.r, color1.g, color1.b, color2.r, color2.g, color2.b);
}


// source : http://axonflux.com/handy-rgb-to-hsl-and-rgb-to-hsv-color-model-c
/* accepts parameters
 * h  Object = {h:x, s:y, v:z}
 * OR 
 * h, s, v
*/
function HSVtoRGB(h, s, v) {
    var r, g, b, i, f, p, q, t;
    if (arguments.length === 1) {
        s = h.s, v = h.v, h = h.h;
    }
    i = Math.floor(h * 6);
    f = h * 6 - i;
    p = v * (1 - s);
    q = v * (1 - f * s);
    t = v * (1 - (1 - f) * s);
    switch (i % 6) {
        case 0: r = v, g = t, b = p; break;
        case 1: r = q, g = v, b = p; break;
        case 2: r = p, g = v, b = t; break;
        case 3: r = p, g = q, b = v; break;
        case 4: r = t, g = p, b = v; break;
        case 5: r = v, g = p, b = q; break;
    }
    return {
        r: Math.round(r * 255),
        g: Math.round(g * 255),
        b: Math.round(b * 255)
    };
}

/* accepts parameters
 * r  Object = {r:x, g:y, b:z}
 * OR 
 * r, g, b
*/
function RGBtoHSV(r, g, b) {
    if (arguments.length === 1) {
        g = r.g, b = r.b, r = r.r;
    }
    var max = Math.max(r, g, b), min = Math.min(r, g, b),
        d = max - min,
        h,
        s = (max === 0 ? 0 : d / max),
        v = max / 255;

    switch (max) {
        case min: h = 0; break;
        case r: h = (g - b) + d * (g < b ? 6: 0); h /= 6 * d; break;
        case g: h = (b - r) + d * 2; h /= 6 * d; break;
        case b: h = (r - g) + d * 4; h /= 6 * d; break;
    }

    return {
        h: h,
        s: s,
        v: v
    };
}

// source : https://gist.github.com/mjackson/5311256
/**
 * Converts an HSL color value to RGB. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
 * Assumes h, s, and l are contained in the set [0, 1] and
 * returns r, g, and b in the set [0, 255].
 *
 * @param   Number  h       The hue
 * @param   Number  s       The saturation
 * @param   Number  l       The lightness
 * @return  Array           The RGB representation
 */
function hslToRgb(h, s, l) {
  var r, g, b;

  if (s == 0) {
    r = g = b = l; // achromatic
  } else {
    function hue2rgb(p, q, t) {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    }

    var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    var p = 2 * l - q;

    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }

  return [ r * 255, g * 255, b * 255 ];
}

/**
 * From: http://stackoverflow.com/questions/2353211/hsl-to-rgb-color-conversion
 *
 * Converts an RGB color value to HSL. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
 * Assumes r, g, and b are contained in the set [0, 255] and
 * returns h, s, and l in the set [0, 1].
 *
 * @param   {number}  r       The red color value
 * @param   {number}  g       The green color value
 * @param   {number}  b       The blue color value
 * @return  {Array}           The HSL representation
 */
function rgbToHsl(r, g, b){
    r /= 255, g /= 255, b /= 255;
    var max = Math.max(r, g, b), min = Math.min(r, g, b);
    var h, s, l = (max + min) / 2;

    if(max == min){
        h = s = 0; // achromatic
    }else{
        var d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch(max){
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
    }

    return [h, s, l];
}
</script>

<script>
var TransitionManager = function() {
	var transitionStart = null;
	var transitionEnd = null;
	var effectImage = null;

	var isTransitioning = false;
	var transitionTime = 0; // milliseconds
	var frameRate = 8; // cap the FPS
	var prevStep = -1; // used to avoid running post-process effect constantly

	this.BeginTransition = function(startRoom,startX,startY,endRoom,endX,endY,effectName) {
		// console.log("--- START ROOM TRANSITION ---");

		curEffect = effectName;

		var tmpRoom = player().room;
		var tmpX = player().x;
		var tmpY = player().y;

		if (transitionEffects[curEffect].showPlayerStart) {
			player().room = startRoom;
			player().x = startX;
			player().y = startY;
		}
		else {
			player().room = "_transition_none"; // kind of hacky!!
		}

		drawRoom(room[startRoom]);
		var startPalette = getPal( room[startRoom].pal );
		var startImage = new PostProcessImage( ctx.getImageData(0,0,canvas.width,canvas.height) ); // TODO : don't use global ctx?
		transitionStart = new TransitionInfo(startImage, startPalette, startX, startY);

		if (transitionEffects[curEffect].showPlayerEnd) {
			player().room = endRoom;
			player().x = endX;
			player().y = endY;
		}
		else {
			player().room = "_transition_none";
		}

		drawRoom(room[endRoom]);
		var endPalette = getPal( room[endRoom].pal );
		var endImage = new PostProcessImage( ctx.getImageData(0,0,canvas.width,canvas.height) );
		transitionEnd = new TransitionInfo(endImage, endPalette, endX, endY);

		effectImage = new PostProcessImage( ctx.createImageData(canvas.width,canvas.height) );

		isTransitioning = true;
		transitionTime = 0;
		prevStep = -1;

		player().room = tmpRoom;
		player().x = tmpX;
		player().y = tmpY;
	}

	this.UpdateTransition = function(dt) {
		if (!isTransitioning) {
			return;
		}

		transitionTime += dt;

		var transitionDelta = transitionTime / transitionEffects[curEffect].duration;
		var maxStep = Math.floor(frameRate * (transitionEffects[curEffect].duration / 1000));
		var step = Math.floor(transitionDelta * maxStep);

		if (step != prevStep) {
			// console.log("step! " + step + " " + transitionDelta);
			for (var y = 0; y < effectImage.Height; y++) {
				for (var x = 0; x < effectImage.Width; x++) {
					var color = transitionEffects[curEffect].pixelEffectFunc(transitionStart,transitionEnd,x,y,(step / maxStep));
					effectImage.SetPixel(x,y,color);
				}
			}
		}
		prevStep = step;

		ctx.putImageData(effectImage.GetData(), 0, 0);

		if (transitionTime >= transitionEffects[curEffect].duration) {
			isTransitioning = false;
			transitionTime = 0;
			transitionStart = null;
			transitionEnd = null;
			effectImage = null;
			prevStep = -1;
		}
	}

	this.IsTransitionActive = function() {
		return isTransitioning;
	}

	var transitionEffects = {};
	var curEffect = "none";
	this.RegisterTransitionEffect = function(name, effect) {
		transitionEffects[name] = effect;
	}

	this.RegisterTransitionEffect("none", {
		showPlayerStart : false,
		showPlayerEnd : false,
		pixelEffectFunc : function() {},
	});

	this.RegisterTransitionEffect("fade_w", { // TODO : have it linger on full white briefly?
		showPlayerStart : false,
		showPlayerEnd : true,
		duration : 750,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var pixelColorA = delta < 0.5 ? start.Image.GetPixel(pixelX,pixelY) : {r:255,g:255,b:255,a:255};
			var pixelColorB = delta < 0.5 ? {r:255,g:255,b:255,a:255} : end.Image.GetPixel(pixelX,pixelY);

			delta = delta < 0.5 ? (delta / 0.5) : ((delta - 0.5) / 0.5); // hacky

			return PostProcessUtilities.LerpColor(pixelColorA, pixelColorB, delta);
		}
	});

	this.RegisterTransitionEffect("fade_b", {
		showPlayerStart : false,
		showPlayerEnd : true,
		duration : 750,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var pixelColorA = delta < 0.5 ? start.Image.GetPixel(pixelX,pixelY) : {r:0,g:0,b:0,a:255};
			var pixelColorB = delta < 0.5 ? {r:0,g:0,b:0,a:255} : end.Image.GetPixel(pixelX,pixelY);

			delta = delta < 0.5 ? (delta / 0.5) : ((delta - 0.5) / 0.5); // hacky

			return PostProcessUtilities.LerpColor(pixelColorA, pixelColorB, delta);
		}
	});

	this.RegisterTransitionEffect("wave", {
		showPlayerStart : true,
		showPlayerEnd : true,
		duration : 1500,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var waveDelta = delta < 0.5 ? delta / 0.5 : 1 - ((delta - 0.5) / 0.5);

			var offset = (pixelY + (waveDelta * waveDelta * 0.2 * start.Image.Height));
			var freq = 4;
			var size = 2 + (14 * waveDelta);
			pixelX += Math.floor(Math.sin(offset / freq) * size);

			if (pixelX < 0) {
				pixelX += start.Image.Width;
			}
			else if (pixelX >= start.Image.Width) {
				pixelX -= start.Image.Width;
			}

			var curImage = delta < 0.5 ? start.Image : end.Image;
			return curImage.GetPixel(pixelX,pixelY);
		}
	});

	this.RegisterTransitionEffect("tunnel", {
		showPlayerStart : true,
		showPlayerEnd : true,
		duration : 1500,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			if (delta <= 0.4) {
				var tunnelDelta = 1 - (delta / 0.4);

				var xDist = start.PlayerCenter.x - pixelX;
				var yDist = start.PlayerCenter.y - pixelY;
				var dist = Math.sqrt((xDist * xDist) + (yDist * yDist));

				if (dist > start.Image.Width * tunnelDelta) {
					return {r:0,g:0,b:0,a:255};
				}
				else {
					return start.Image.GetPixel(pixelX,pixelY);
				}
			}
			else if (delta <= 0.6)
			{
				return {r:0,g:0,b:0,a:255};
			}
			else {
				var tunnelDelta = (delta - 0.6) / 0.4;

				var xDist = end.PlayerCenter.x - pixelX;
				var yDist = end.PlayerCenter.y - pixelY;
				var dist = Math.sqrt((xDist * xDist) + (yDist * yDist));

				if (dist > end.Image.Width * tunnelDelta) {
					return {r:0,g:0,b:0,a:255};
				}
				else {
					return end.Image.GetPixel(pixelX,pixelY);
				}
			}
		}
	});

	this.RegisterTransitionEffect("slide_u", {
		showPlayerStart : false,
		showPlayerEnd : true,
		duration : 1000,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var pixelOffset = -1 * Math.floor(start.Image.Height * delta);
			var slidePixelY = pixelY + pixelOffset;

			var colorDelta = clampLerp(delta, 0.4);

			if (slidePixelY >= 0) {
				var colorA = start.Image.GetPixel(pixelX,slidePixelY);
				var colorB = PostProcessUtilities.GetCorrespondingColorFromPal(colorA,start.Palette,end.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
			else {
				slidePixelY += start.Image.Height;
				var colorB = end.Image.GetPixel(pixelX,slidePixelY);
				var colorA = PostProcessUtilities.GetCorrespondingColorFromPal(colorB,end.Palette,start.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
		}
	});

	this.RegisterTransitionEffect("slide_d", {
		showPlayerStart : false,
		showPlayerEnd : true,
		duration : 1000,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var pixelOffset = Math.floor(start.Image.Height * delta);
			var slidePixelY = pixelY + pixelOffset;

			var colorDelta = clampLerp(delta, 0.4);

			if (slidePixelY < start.Image.Height) {
				var colorA = start.Image.GetPixel(pixelX,slidePixelY);
				var colorB = PostProcessUtilities.GetCorrespondingColorFromPal(colorA,start.Palette,end.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
			else {
				slidePixelY -= start.Image.Height;
				var colorB = end.Image.GetPixel(pixelX,slidePixelY);
				var colorA = PostProcessUtilities.GetCorrespondingColorFromPal(colorB,end.Palette,start.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
		}
	});

	this.RegisterTransitionEffect("slide_l", {
		showPlayerStart : false,
		showPlayerEnd : true,
		duration : 1000,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var pixelOffset = -1 * Math.floor(start.Image.Width * delta);
			var slidePixelX = pixelX + pixelOffset;

			var colorDelta = clampLerp(delta, 0.4);

			if (slidePixelX >= 0) {
				var colorA = start.Image.GetPixel(slidePixelX,pixelY);
				var colorB = PostProcessUtilities.GetCorrespondingColorFromPal(colorA,start.Palette,end.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
			else {
				slidePixelX += start.Image.Width;
				var colorB = end.Image.GetPixel(slidePixelX,pixelY);
				var colorA = PostProcessUtilities.GetCorrespondingColorFromPal(colorB,end.Palette,start.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
		}
	});

	this.RegisterTransitionEffect("slide_r", {
		showPlayerStart : false,
		showPlayerEnd : true,
		duration : 1000,
		pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
			var pixelOffset = Math.floor(start.Image.Width * delta);
			var slidePixelX = pixelX + pixelOffset;

			var colorDelta = clampLerp(delta, 0.4);

			if (slidePixelX < start.Image.Width) {
				var colorA = start.Image.GetPixel(slidePixelX,pixelY);
				var colorB = PostProcessUtilities.GetCorrespondingColorFromPal(colorA,start.Palette,end.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
			else {
				slidePixelX -= start.Image.Width;
				var colorB = end.Image.GetPixel(slidePixelX,pixelY);
				var colorA = PostProcessUtilities.GetCorrespondingColorFromPal(colorB,end.Palette,start.Palette);
				var colorLerped = PostProcessUtilities.LerpColor(colorA, colorB, colorDelta);
				return colorLerped;
			}
		}
	});

	function clampLerp(deltaIn, clampDuration) {
		var clampOffset = (1.0 - clampDuration) / 2;
		var deltaOut = Math.min(clampDuration, Math.max(0.0, deltaIn - clampOffset)) / clampDuration;
		return deltaOut;
	}

	// TODO : WIP
	// this.RegisterTransitionEffect("fuzz", {
	// 	showPlayerStart : true,
	// 	showPlayerEnd : true,
	// 	duration : 1500,
	// 	pixelEffectFunc : function(start,end,pixelX,pixelY,delta) {
	// 		var curImage = delta <= 0.5 ? start : end;
	// 		var sampleSize = delta <= 0.5 ? (2 + Math.floor(14 * (delta/0.5))) : (16 - Math.floor(14 * ((delta-0.5)/0.5)));

	// 		var palIndex = 0;

	// 		var sampleX = Math.floor(pixelX / sampleSize) * sampleSize;
	// 		var sampleY = Math.floor(pixelY / sampleSize) * sampleSize;

	// 		var frameState = transitionEffects["fuzz"].frameState;

	// 		if (frameState.time != delta) {
	// 			frameState.time = delta;
	// 			frameState.preCalcSampleValues = {};
	// 		}

	// 		if (frameState.preCalcSampleValues[[sampleX,sampleY]]) {
	// 			palIndex = frameState.preCalcSampleValues[[sampleX,sampleY]];
	// 		}
	// 		else {
	// 			var paletteCount = {};
	// 			var foregroundValue = 1.0;
	// 			var backgroundValue = 0.4;
	// 			for (var y = sampleY; y < sampleY + sampleSize; y++) {
	// 				for (var x = sampleX; x < sampleX + sampleSize; x++) {
	// 					var color = curImage.Image.GetPixel(x,y)
	// 					var palIndex = PostProcessUtilities.GetColorPalIndex(color,curImage.Palette);
	// 					if (palIndex != -1) {
	// 						if (paletteCount[palIndex]) {
	// 							paletteCount[palIndex] += (palIndex != 0) ? foregroundValue : backgroundValue;
	// 						}
	// 						else {
	// 							paletteCount[palIndex] = (palIndex != 0) ? foregroundValue : backgroundValue;
	// 						}
	// 					}
	// 				}
	// 			}

	// 			var maxCount = 0;
	// 			for (var i in paletteCount) {
	// 				if (paletteCount[i] > maxCount) {
	// 					palIndex = i;
	// 					maxCount = paletteCount[i];
	// 				}
	// 			}

	// 			frameState.preCalcSampleValues[[sampleX,sampleY]] = palIndex;
	// 		}

	// 		return PostProcessUtilities.GetPalColor(curImage.Palette,palIndex);
	// 	},
	// 	frameState : { // ok this is hacky but it's for performance ok
	// 		time : -1,
	// 		preCalcSampleValues : {}
	// 	}
	// });
}; // TransitionManager()


// TODO : extract the scale variable so it can be changed?
var PostProcessUtilities = {
	SamplePixelColor : function(image,x,y) {
		var pixelIndex = (y * scale * image.width * 4) + (x * scale * 4);
		var r = image.data[pixelIndex + 0];
		var g = image.data[pixelIndex + 1];
		var b = image.data[pixelIndex + 2];
		var a = image.data[pixelIndex + 3];
		return { r:r, g:g, b:b, a:a };
	},
	SetPixelColor : function(image,x,y,colorRgba) {
		for (var yDelta = 0; yDelta <= scale; yDelta++) {
			for (var xDelta = 0; xDelta <= scale; xDelta++) {
				var pixelIndex = (((y * scale) + yDelta) * image.width * 4) + (((x * scale) + xDelta) * 4);
				image.data[pixelIndex + 0] = colorRgba.r;
				image.data[pixelIndex + 1] = colorRgba.g;
				image.data[pixelIndex + 2] = colorRgba.b;
				image.data[pixelIndex + 3] = colorRgba.a;
			}
		}
	},
	LerpColor : function(colorA,colorB,t) {
		// TODO: move to color_util.js?
		return {
			r : colorA.r + ((colorB.r - colorA.r) * t),
			g : colorA.g + ((colorB.g - colorA.g) * t),
			b : colorA.b + ((colorB.b - colorA.b) * t),
			a : colorA.a + ((colorB.a - colorA.a) * t),
		};
	},
	GetColorPalIndex : function(colorIn,curPal) {
		var colorIndex = -1;

		for (var i = 0; i < curPal.length; i++) {
			if (colorIn.r == curPal[i][0] && colorIn.g == curPal[i][1] && colorIn.b == curPal[i][2]) {
				colorIndex = i;
			}
		}

		return colorIndex;
	},
	GetPalColor : function(palette,index) {
		return { r: palette[index][0], g: palette[index][1], b: palette[index][2], a: 255 }
	},
	GetCorrespondingColorFromPal : function(colorIn,curPal,otherPal) { // this is kind of hacky!
		var colorIndex = PostProcessUtilities.GetColorPalIndex(colorIn,curPal);

		if (colorIndex >= 0 && colorIndex <= otherPal.length) {
			return PostProcessUtilities.GetPalColor(otherPal,colorIndex);
		}
		else {
			return colorIn;
		}
	},
};

var PostProcessImage = function(imageData) {
	this.Width = imageData.width / scale;
	this.Height = imageData.height / scale;

	this.GetPixel = function(x,y) {
		return PostProcessUtilities.SamplePixelColor(imageData,x,y);
	};

	this.SetPixel = function(x,y,colorRgba) {
		PostProcessUtilities.SetPixelColor(imageData,x,y,colorRgba);
	};

	this.GetData = function() {
		return imageData;
	};
};

var TransitionInfo = function(image, palette, playerX, playerY) {
	this.Image = image;
	this.Palette = palette;
	this.PlayerTilePos = { x: playerX, y: playerY };
	this.PlayerCenter = { x: Math.floor((playerX * tilesize) + (tilesize / 2)), y: Math.floor((playerY * tilesize) + (tilesize / 2)) };
};
</script>

<script>
/*
TODO:
- untangle local & external resource use in font manager (still more to do here)
*/

function FontManager(useExternalResources) {

if (useExternalResources === undefined || useExternalResources === null) {
	useExternalResources = false;
}

var self = this;

var fontExtension = ".bitsyfont";
this.GetExtension = function() {
	return fontExtension;
}

// place to store font data that is part of the local game data
var localResources = {};

// place to store font data fetched from a server (only used in editor)
var externalResources = null;
if (useExternalResources) {
	externalResources = new ResourceLoader();// NOTE : this class doesn't exist in exported game
}

this.LoadResources = function(filenames, onLoadAll) {
	if (!useExternalResources)
		return;

	// TODO : is this being called too many times?
	var onLoad = function() {
		var count = externalResources.getResourceLoadedCount();

		if (count >= filenames.length && onLoadAll != null) {
			onLoadAll();
		}
	}

	for (var i = 0; i < filenames.length; i++) {
		externalResources.load("bitsyfont", filenames[i], onLoad);
	}
}

// manually add resource
this.AddResource = function(filename, fontdata) {
	if (useExternalResources) {
		externalResources.set(filename, fontdata);
	}
	else {
		localResources[filename] = fontdata;
	}
}

this.ContainsResource = function(filename) {
	if (useExternalResources) {
		return externalResources.contains(filename);
	}
	else {
		return localResources[filename] != null;
	}
}

function GetData(fontName) {
	if (useExternalResources) {
		return externalResources.get(fontName + fontExtension);
	}
	else {
		return localResources[fontName + fontExtension];
	}
}
this.GetData = GetData;

function Create(fontData) {
	return new Font(fontData);
}
this.Create = Create;

this.Get = function(fontName) {
	var fontData = self.GetData(fontName);
	return self.Create(fontData);
}

function Font(fontData) {
	var name = "unknown";
	var width = 6; // default size so if you have NO font or an invalid font it displays boxes
	var height = 8;
	var chardata = {};
	var invalidCharData = {};

	this.getName = function() {
		return name;
	}

	this.getData = function() {
		return chardata;
	}

	this.getWidth = function() {
		return width;
	}

	this.getHeight = function() {
		return height;
	}

	this.hasChar = function(char) {
		var codepoint = char.charCodeAt(0);
		return chardata[codepoint] != null;
	}

	this.getChar = function(char) {

		var codepoint = char.charCodeAt(0);

		if (chardata[codepoint] != null) {
			return chardata[codepoint];
		}
		else {
			return invalidCharData;
		}
	}

	this.allCharCodes = function() {
		var codeList = [];
		for (var code in chardata) {
			codeList.push(code);
		}
		return codeList;
	}

	function parseFont(fontData) {
		if (fontData == null)
			return;

		var lines = fontData.split("\n");

		var isReadingChar = false;
		var isReadingCharProperties = false;
		var curCharLineCount = 0;
		var curCharCode = 0;

		for (var i = 0; i < lines.length; i++) {
			var line = lines[i];

			if (line[0] === "#") {
				continue; // skip comment lines
			}

			if (!isReadingChar) {
				// READING NON CHARACTER DATA LINE
				var args = line.split(" ");
				if (args[0] == "FONT") {
					name = args[1];
				}
				else if (args[0] == "SIZE") {
					width = parseInt(args[1]);
					height = parseInt(args[2]);
				}
				else if (args[0] == "CHAR") {
					isReadingChar = true;
					isReadingCharProperties = true;

					curCharLineCount = 0;
					curCharCode = parseInt(args[1]);
					chardata[curCharCode] = { 
						width: width,
						height: height,
						offset: {
							x: 0,
							y: 0
						},
						spacing: width,
						data: []
					};
				}
			}
			else {
				// CHAR PROPERTIES
				if (isReadingCharProperties) {
					var args = line.split(" ");
					if (args[0].indexOf("CHAR_") == 0) { // Sub-properties start with "CHAR_"
						if (args[0] == "CHAR_SIZE") {
							// Custom character size - overrides the default character size for the font
							chardata[curCharCode].width = parseInt(args[1]);
							chardata[curCharCode].height = parseInt(args[2]);
							chardata[curCharCode].spacing = parseInt(args[1]); // HACK : assumes CHAR_SIZE is always declared first
						}
						else if (args[0] == "CHAR_OFFSET") {
							// Character offset - shift the origin of the character on the X or Y axis
							chardata[curCharCode].offset.x = parseInt(args[1]);
							chardata[curCharCode].offset.y = parseInt(args[2]);
						}
						else if (args[0] == "CHAR_SPACING") {
							// Character spacing:
							// specify total horizontal space taken up by the character
							// lets chars take up more or less space on a line than its bitmap does
							chardata[curCharCode].spacing = parseInt(args[1]);
						}
					}
					else {
						isReadingCharProperties = false;
					}
				}

				// CHAR DATA
				if (!isReadingCharProperties) {
					// READING CHARACTER DATA LINE
					for (var j = 0; j < chardata[curCharCode].width; j++)
					{
						chardata[curCharCode].data.push( parseInt(line[j]) );
					}

					curCharLineCount++;
					if (curCharLineCount >= height) {
						isReadingChar = false;
					}
				}
			}
		}

		// init invalid character box
		invalidCharData = { 
			width: width,
			height: height,
			offset: {
				x: 0,
				y: 0
			},
			spacing: width, // TODO : name?
			data: []
		};
		for (var y = 0; y < height; y++) {
			for (var x = 0; x < width; x++) {
				if (x < width-1 && y < height-1) {
					invalidCharData.data.push(1);
				}
				else {
					invalidCharData.data.push(0);
				}
			}
		}
	}

	parseFont(fontData);
}

} // FontManager
</script>

<script>
function Script() {

this.CreateInterpreter = function() {
	return new Interpreter();
};

this.CreateUtils = function() {
	return new Utils();
};

var Interpreter = function() {
	var env = new Environment();
	var parser = new Parser( env );

	this.SetDialogBuffer = function(buffer) { env.SetDialogBuffer( buffer ); };

	// TODO -- maybe this should return a string instead othe actual script??
	this.Compile = function(scriptName, scriptStr) {
		// console.log("COMPILE");
		var script = parser.Parse( scriptStr );
		env.SetScript( scriptName, script );
	}
	this.Run = function(scriptName, exitHandler) { // Runs pre-compiled script
		// console.log("RUN");
		// console.log(env.GetScript( scriptName ));
		env.GetScript( scriptName )
			.Eval( env, function(result) { OnScriptReturn(result, exitHandler); } );

		// console.log("SERIALIZE!!!!");
		// console.log( env.GetScript( scriptName ).Serialize() );
	}
	this.Interpret = function(scriptStr, exitHandler) { // Compiles and runs code immediately
		// console.log("INTERPRET");
		var script = parser.Parse( scriptStr );
		script.Eval( env, function(result) { OnScriptReturn(result, exitHandler); } );
	}
	this.HasScript = function(name) { return env.HasScript(name); };

	this.ResetEnvironment = function() {
		env = new Environment();
		parser = new Parser( env );
	}

	this.Parse = function(scriptStr) { // parses a script but doesn't save it
		return parser.Parse( scriptStr );
	}
	this.Eval = function(scriptTree, exitHandler) { // runs a script stored externally
		scriptTree.Eval( env, function(result) { OnScriptReturn(result, exitHandler); } );
	}

	function OnScriptReturn(result, exitHandler) {
		if (isReturnObject(result)) {
			result = result.result; // pull out the contained result
		}

		// console.log("RESULT " + result);

		if (exitHandler != null) {
			exitHandler(result);
		}
	}

	this.CreateExpression = function(expStr) {
		return parser.CreateExpression( expStr );
	}

	this.SetVariable = function(name,value,useHandler) {
		env.SetVariable(name,value,useHandler);
	}

	this.DeleteVariable = function(name,useHandler) {
		env.DeleteVariable(name,useHandler);
	}
	this.HasVariable = function(name) {
		return env.HasVariable(name);
	}

	this.SetOnVariableChangeHandler = function(onVariableChange) {
		env.SetOnVariableChangeHandler(onVariableChange);
	}
	this.GetVariableNames = function() {
		return env.GetVariableNames();
	}
	this.GetVariable = function(name) {
		return env.GetVariable(name);
	}

	this.DebugVisualizeScriptTree = function(scriptName) {
		var printVisitor = {
			Visit : function(node,depth) {
				console.log("-".repeat(depth) + "- " + node.ToString());
			},
		};

		env.GetScript( scriptName ).VisitAll( printVisitor );
	}
}


var Utils = function() {
	// for editor ui
	this.CreateDialogBlock = function(children,doIndentFirstLine) {
		if(doIndentFirstLine === undefined) doIndentFirstLine = true;
		var block = new BlockNode( BlockMode.Dialog, doIndentFirstLine );
		for(var i = 0; i < children.length; i++) {
			block.AddChild( children[i] );
		}
		return block;
	}

	this.ChangeSequenceType = function(oldSequence,type) {
		if(type === "sequence") {
			return new SequenceNode( oldSequence.options );
		}
		else if(type === "cycle") {
			return new CycleNode( oldSequence.options );
		}
		else if(type === "shuffle") {
			return new ShuffleNode( oldSequence.options );
		}
		return oldSequence;
	}

	this.CreateSequenceBlock = function() {
		var option1 = new BlockNode( BlockMode.Dialog, false /*doIndentFirstLine*/ );
		var option2 = new BlockNode( BlockMode.Dialog, false /*doIndentFirstLine*/ );
		var sequence = new SequenceNode( [ option1, option2 ] );
		var block = new BlockNode( BlockMode.Code );
		block.AddChild( sequence );
		return block;
	}

	this.CreateIfBlock = function() {
		var leftNode = new BlockNode( BlockMode.Code );
		leftNode.AddChild( new FuncNode("item", [new LiteralNode("0")] ) );
		var rightNode = new LiteralNode( 1 );
		var condition1 = new ExpNode("==", leftNode, rightNode );

		var condition2 = new ElseNode();

		var result1 = new BlockNode( BlockMode.Dialog );
		var result2 = new BlockNode( BlockMode.Dialog );

		var ifNode = new IfNode( [ condition1, condition2 ], [ result1, result2 ] );
		var block = new BlockNode( BlockMode.Code );
		block.AddChild( ifNode );
		return block;
	}

	this.ReadDialogScript = function(lines, i) {
		var scriptStr = "";
		if (lines[i] === Sym.DialogOpen) {
			scriptStr += lines[i] + "\n";
			i++;
			while(lines[i] != Sym.DialogClose) {
				scriptStr += lines[i] + "\n";
				i++;
			}
			scriptStr += lines[i];
			i++;
		}
		else {
			scriptStr += lines[i];
		}
		return { script:scriptStr, index:i };
	}

	// TODO this.ReadCodeScript (reads through code open and close symbols), and this.ReadScript

	this.EnsureDialogBlockFormat = function(dialogStr) {
		// TODO -- what if it's already enclosed in dialog symbols??
		if(dialogStr.indexOf('\n') > -1) {
			dialogStr = Sym.DialogOpen + "\n" + dialogStr + "\n" + Sym.DialogClose;
		}
		return dialogStr;
	}

	this.RemoveDialogBlockFormat = function(source) {
		var sourceLines = source.split("\n");
		var dialogStr = "";
		if(sourceLines[0] === Sym.DialogOpen) {
			// multi line
			var i = 1;
			while (i < sourceLines.length && sourceLines[i] != Sym.DialogClose) {
				dialogStr += sourceLines[i] + (sourceLines[i+1] != Sym.DialogClose ? '\n' : '');
				i++;
			}
		}
		else {
			// single line
			dialogStr = source;
		}
		return dialogStr;
	}
}


/* BUILT-IN FUNCTIONS */ // TODO: better way to encapsulate these?
function deprecatedFunc(environment,parameters,onReturn) {
	console.log("BITSY SCRIPT WARNING: Tried to use deprecated function");
	onReturn(null);
}

// TODO : vNext
// function returnFunc(environment,parameters,onReturn) {
// 	var ret = { isReturn: true, result: null };
// 	if (parameters.length > 0 && parameters[0] != undefined && parameters[0] != null) {
// 		ret.result = parameters[0];
// 	}
// 	onReturn(ret);
// }

// TODO : vNext
// // TODO : this is kind of hacky
// // - needs to work with names too
// function changeAvatarFunc(environment,parameters,onReturn) {
// 	if( parameters[0] != undefined && parameters[0] != null ) {
// 		sprite["A"].drw = "SPR_" + parameters[0];
// 	}
// 	onReturn(null);
// }

function printFunc(environment,parameters,onReturn) {
	// console.log("PRINT FUNC");
	// console.log(parameters);
	if( parameters[0] != undefined && parameters[0] != null ) {
		// console.log(parameters[0]);
		// console.log(parameters[0].toString());
		// var textStr = parameters[0].toString();
		var textStr = "" + parameters[0];
		// console.log(textStr);
		var onFinishHandler = function() {
			// console.log("FINISHED PRINTING ---- SCRIPT");
			onReturn(null);
		}; // called when dialog is finished printing
		environment.GetDialogBuffer().AddText( textStr, onFinishHandler );
	}
	else {
		onReturn(null);
	}
}

function linebreakFunc(environment,parameters,onReturn) {
	// console.log("LINEBREAK FUNC");
	environment.GetDialogBuffer().AddLinebreak();
	onReturn(null);
}

function printDrawingFunc(environment,parameters,onReturn) {
	var drawingId = parameters[0];
	environment.GetDialogBuffer().AddDrawing( drawingId, function() {
		onReturn(null);
	});
}

function printSpriteFunc(environment,parameters,onReturn) {
	var spriteId = parameters[0];
	if(names.sprite.has(spriteId)) spriteId = names.sprite.get(spriteId); // id is actually a name
	var drawingId = sprite[spriteId].drw;
	printDrawingFunc(environment, [drawingId], onReturn);
}

function printTileFunc(environment,parameters,onReturn) {
	var tileId = parameters[0];
	if(names.tile.has(tileId)) tileId = names.tile.get(tileId); // id is actually a name
	var drawingId = tile[tileId].drw;
	printDrawingFunc(environment, [drawingId], onReturn);
}

function printItemFunc(environment,parameters,onReturn) {
	var itemId = parameters[0];
	if(names.item.has(itemId)) itemId = names.item.get(itemId); // id is actually a name
	var drawingId = item[itemId].drw;
	printDrawingFunc(environment, [drawingId], onReturn);
}

function printFontFunc(environment, parameters, onReturn) {
	var allCharacters = "";
	var font = fontManager.Get( fontName );
	var codeList = font.allCharCodes();
	for (var i = 0; i < codeList.length; i++) {
		allCharacters += String.fromCharCode(codeList[i]) + " ";
	}
	printFunc(environment, [allCharacters], onReturn);
}

function itemFunc(environment,parameters,onReturn) {
	var itemId = parameters[0];
	if(names.item.has(itemId)) itemId = names.item.get(itemId); // id is actually a name
	var itemCount = player().inventory[itemId] ? player().inventory[itemId] : 0; // TODO : ultimately the environment should include a reference to the game state
	// console.log("ITEM FUNC " + itemId + " " + itemCount);
	onReturn(itemCount);
}

function addOrRemoveTextEffect(environment,name) {
	if( environment.GetDialogBuffer().HasTextEffect(name) )
		environment.GetDialogBuffer().RemoveTextEffect(name);
	else
		environment.GetDialogBuffer().AddTextEffect(name);
}

function rainbowFunc(environment,parameters,onReturn) {
	addOrRemoveTextEffect(environment,"rbw");
	onReturn(null);
}

// TODO : should the colors use a parameter instead of special names?
function color1Func(environment,parameters,onReturn) {
	addOrRemoveTextEffect(environment,"clr1");
	onReturn(null);
}

function color2Func(environment,parameters,onReturn) {
	addOrRemoveTextEffect(environment,"clr2");
	onReturn(null);
}

function color3Func(environment,parameters,onReturn) {
	addOrRemoveTextEffect(environment,"clr3");
	onReturn(null);
}

function wavyFunc(environment,parameters,onReturn) {
	addOrRemoveTextEffect(environment,"wvy");
	onReturn(null);
}

function shakyFunc(environment,parameters,onReturn) {
	addOrRemoveTextEffect(environment,"shk");
	onReturn(null);
}

/* BUILT-IN OPERATORS */
function setExp(environment,left,right,onReturn) {
	// console.log("SET " + left.name);

	if(left.type != "variable") {
		// not a variable! return null and hope for the best D:
		onReturn( null );
		return;
	}

	right.Eval(environment,function(rVal) {
		environment.SetVariable( left.name, rVal );
		// console.log("VAL " + environment.GetVariable( left.name ) );
		left.Eval(environment,function(lVal) {
			onReturn( lVal );
		});
	});
}
function equalExp(environment,left,right,onReturn) {
	// console.log("EVAL EQUAL");
	// console.log(left);
	// console.log(right);
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal === rVal );
		});
	});
}
function greaterExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal > rVal );
		});
	});
}
function lessExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal < rVal );
		});
	});
}
function greaterEqExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal >= rVal );
		});
	});
}
function lessEqExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal <= rVal );
		});
	});
}
function multExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal * rVal );
		});
	});
}
function divExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal / rVal );
		});
	});
}
function addExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal + rVal );
		});
	});
}
function subExp(environment,left,right,onReturn) {
	right.Eval(environment,function(rVal){
		left.Eval(environment,function(lVal){
			onReturn( lVal - rVal );
		});
	});
}

/* ENVIRONMENT */
var Environment = function() {
	var dialogBuffer = null;
	this.SetDialogBuffer = function(buffer) { dialogBuffer = buffer; };
	this.GetDialogBuffer = function() { return dialogBuffer; };

	var functionMap = new Map();
	functionMap.set("print", printFunc);
	functionMap.set("say", printFunc);
	functionMap.set("br", linebreakFunc);
	functionMap.set("item", itemFunc);
	functionMap.set("rbw", rainbowFunc);
	functionMap.set("clr1", color1Func);
	functionMap.set("clr2", color2Func);
	functionMap.set("clr3", color3Func);
	functionMap.set("wvy", wavyFunc);
	functionMap.set("shk", shakyFunc);
	functionMap.set("printSprite", printSpriteFunc);
	functionMap.set("printTile", printTileFunc);
	functionMap.set("printItem", printItemFunc);
	functionMap.set("debugOnlyPrintFont", printFontFunc); // DEBUG ONLY

	// TODO : vNext
	// functionMap.set("changeAvatar", changeAvatarFunc);
	// functionMap.set("return", returnFunc);

	this.HasFunction = function(name) { return functionMap.has(name); };
	this.EvalFunction = function(name,parameters,onReturn) {
		// console.log(functionMap);
		// console.log(name);
		functionMap.get( name )( this, parameters, onReturn );
	}

	var variableMap = new Map();

	this.HasVariable = function(name) { return variableMap.has(name); };
	this.GetVariable = function(name) { return variableMap.get(name); };
	this.SetVariable = function(name,value,useHandler) {
		// console.log("SET VARIABLE " + name + " = " + value);
		if(useHandler === undefined) useHandler = true;
		variableMap.set(name, value);
		if(onVariableChangeHandler != null && useHandler)
			onVariableChangeHandler(name);
	};
	this.DeleteVariable = function(name,useHandler) {
		if(useHandler === undefined) useHandler = true;
		if(variableMap.has(name)) {
			variableMap.delete(name);
			if(onVariableChangeHandler != null && useHandler)
				onVariableChangeHandler(name);
		}
	};

	var operatorMap = new Map();
	operatorMap.set("=", setExp);
	operatorMap.set("==", equalExp);
	operatorMap.set(">", greaterExp);
	operatorMap.set("<", lessExp);
	operatorMap.set(">=", greaterEqExp);
	operatorMap.set("<=", lessEqExp);
	operatorMap.set("*", multExp);
	operatorMap.set("/", divExp);
	operatorMap.set("+", addExp);
	operatorMap.set("-", subExp);

	this.HasOperator = function(sym) { return operatorMap.get(sym); };
	this.EvalOperator = function(sym,left,right,onReturn) {
		operatorMap.get( sym )( this, left, right, onReturn );
	}

	var scriptMap = new Map();
	this.HasScript = function(name) { return scriptMap.has(name); };
	this.GetScript = function(name) { return scriptMap.get(name); };
	this.SetScript = function(name,script) { scriptMap.set(name, script); };

	var onVariableChangeHandler = null;
	this.SetOnVariableChangeHandler = function(onVariableChange) {
		onVariableChangeHandler = onVariableChange;
	}
	this.GetVariableNames = function() {
		return Array.from( variableMap.keys() );
	}
}

function leadingWhitespace(depth) {
	var str = "";
	for(var i = 0; i < depth; i++) {
		str += "  "; // two spaces per indent
	}
	// console.log("WHITESPACE " + depth + " ::" + str + "::");
	return str;
}

/* NODES */
var TreeRelationship = function() {
	this.parent = null;
	this.children = [];
	this.AddChild = function(node) {
		this.children.push( node );
		node.parent = this;
	};

	this.VisitAll = function(visitor, depth) {
		if (depth == undefined || depth == null) {
			depth = 0;
		}

		visitor.Visit( this, depth );
		for( var i = 0; i < this.children.length; i++ ) {
			this.children[i].VisitAll( visitor, depth + 1 );
		}
	};
}

function isReturnObject(val) {
	return typeof val === "object" && val != null
				&& val.isReturn != undefined && val.isReturn != null
				&& val.isReturn;
}

var BlockMode = {
	Code : "code",
	Dialog : "dialog"
};

var BlockNode = function(mode, doIndentFirstLine) {
	Object.assign( this, new TreeRelationship() );
	// Object.assign( this, new Runnable() );
	this.type = "block";
	this.mode = mode;

	this.Eval = function(environment,onReturn) {
		// console.log("EVAL BLOCK " + this.children.length);

		if( this.onEnter != null ) {
			this.onEnter();
		}

		var lastVal = null;
		var i = 0;

		function evalChildren(children,done) {
			if (i < children.length) {
				// console.log(">> CHILD " + i);
				children[i].Eval( environment, function(val) {
					// console.log("<< CHILD " + i);

					if (isReturnObject(val)) { // early return
						lastVal = val;
						done();
					}
					else {
						lastVal = val;
						i++;
						evalChildren(children,done);
					}
				} );
			}
			else {
				done();
			}
		};

		var self = this;
		evalChildren( this.children, function() {
			if( self.onExit != null ) {
				self.onExit();
			}
			onReturn(lastVal);
		} );
	}

	if(doIndentFirstLine === undefined) doIndentFirstLine = true; // This is just for serialization

	this.Serialize = function(depth) {
		if(depth === undefined) depth = 0;

		// console.log("SERIALIZE BLOCK!!!");
		// console.log(depth);
		// console.log(doIndentFirstLine);

		var str = "";
		var lastNode = null;
		if (this.mode === BlockMode.Code) str += "{"; // todo: increase scope of Sym?
		for (var i = 0; i < this.children.length; i++) {

			var curNode = this.children[i];

			if(curNode.type === "block" && lastNode && lastNode.type === "block" && !isBlockWithNoNewline(curNode) && !isBlockWithNoNewline(lastNode))
				str += "\n";

			var shouldIndentFirstLine = (i == 0 && doIndentFirstLine);
			var shouldIndentAfterLinebreak = (lastNode && lastNode.type === "function" && lastNode.name === "br");
			if(this.mode === BlockMode.Dialog && (shouldIndentFirstLine || shouldIndentAfterLinebreak))
				str += leadingWhitespace(depth);
			str += curNode.Serialize(depth);
			lastNode = curNode;
		}
		if (this.mode === BlockMode.Code) str += "}";
		return str;
	}

	this.ToString = function() {
		return this.type + " " + this.mode;
	};
}

function isBlockWithNoNewline(node) {
	return isTextEffectBlock(node) || isMultilineListBlock(node);
}

function isTextEffectBlock(node) {
	if(node.type === "block") {
		if(node.children.length > 0 && node.children[0].type === "function") {
			var func = node.children[0];
			if(func.name === "clr1" || func.name === "clr2" || func.name === "clr3" || func.name === "wvy" || func.name === "shk" || func.name === "rbw") {
				return true;
			}
		}
	}
	return false;
}

function isMultilineListBlock(node) {
	if(node.type === "block") {
		if(node.children.length > 0) {
			var child = node.children[0];
			if(child.type === "sequence" || child.type === "cycle" || child.type === "shuffle" || child.type === "if") {
				return true;
			}
		}
	}
	return false;
}

var FuncNode = function(name,arguments) {
	Object.assign( this, new TreeRelationship() );
	// Object.assign( this, new Runnable() );
	this.type = "function";
	this.name = name;
	this.arguments = arguments;

	this.Eval = function(environment,onReturn) {

		if( this.onEnter != null ) this.onEnter();

		// console.log("FUNC");
		// console.log(this.arguments);
		var argumentValues = [];
		var i = 0;
		function evalArgs(arguments,done) {
			if(i < arguments.length) {
				// Evaluate each argument
				arguments[i].Eval( environment, function(val) {
					argumentValues.push( val );
					i++;
					evalArgs(arguments,done);
				} );
			}
			else {
				done();
			}
		};
		var self = this; // hack to deal with scope
		evalArgs( this.arguments, function() {
			// Then evaluate the function
			// console.log("ARGS");
			// console.log(argumentValues);

			if( self.onExit != null ) self.onExit();

			environment.EvalFunction( self.name, argumentValues, onReturn );
		} );
	}

	this.Serialize = function(depth) {
		var isDialogBlock = this.parent.mode && this.parent.mode === BlockMode.Dialog;
		if(isDialogBlock && this.name === "print") {
			// TODO this could cause problems with "real" print functions
			return this.arguments[0].value; // first argument should be the text of the {print} func
		}
		else if(isDialogBlock && this.name === "br") {
			return "\n";
		}
		else {
			var str = "";
			str += this.name;
			for(var i = 0; i < this.arguments.length; i++) {
				str += " ";
				str += this.arguments[i].Serialize(depth);
			}
			return str;
		}
	}

	this.ToString = function() {
		return this.type + " " + this.name;
	};
}

var LiteralNode = function(value) {
	Object.assign( this, new TreeRelationship() );
	// Object.assign( this, new Runnable() );
	this.type = "literal";
	this.value = value;

	this.Eval = function(environment,onReturn) {
		onReturn(this.value);
	}

	this.Serialize = function(depth) {
		var str = "";

		if(this.value === null)
			return str;

		if(typeof this.value === "string") str += '"';
		str += this.value;
		if(typeof this.value === "string") str += '"';

		return str;
	}

	this.ToString = function() {
		return this.type + " " + this.value;
	};
}

var VarNode = function(name) {
	Object.assign( this, new TreeRelationship() );
	// Object.assign( this, new Runnable() );
	this.type = "variable";
	this.name = name;

	this.Eval = function(environment,onReturn) {
		// console.log("EVAL " + this.name + " " + environment.HasVariable(this.name) + " " + environment.GetVariable(this.name));
		if( environment.HasVariable(this.name) )
			onReturn( environment.GetVariable( this.name ) );
		else
			onReturn(null); // not a valid variable -- return null and hope that's ok
	} // TODO: might want to store nodes in the variableMap instead of values???

	this.Serialize = function(depth) {
		var str = "" + this.name;
		return str;
	}

	this.ToString = function() {
		return this.type + " " + this.name;
	};
}

var ExpNode = function(operator, left, right) {
	Object.assign( this, new TreeRelationship() );
	this.type = "operator";
	this.operator = operator;
	this.left = left;
	this.right = right;

	this.Eval = function(environment,onReturn) {
		// console.log("EVAL " + this.operator);
		var self = this; // hack to deal with scope
		environment.EvalOperator( this.operator, this.left, this.right, 
			function(val){
				// console.log("EVAL EXP " + self.operator + " " + val);
				onReturn(val);
			} );
		// NOTE : sadly this pushes a lot of complexity down onto the actual operator methods
	}

	this.Serialize = function(depth) {
		var isNegativeNumber = this.operator === "-" && this.left.type === "literal" && this.left.value === null;

		if(!isNegativeNumber) {
			var str = "";
			str += this.left.Serialize(depth);
			str += " " + this.operator + " ";
			str += this.right.Serialize(depth);
			return str;
		}
		else {
			return this.operator + this.right.Serialize(depth); // hacky but seems to work
		}
	}

	this.VisitAll = function(visitor, depth) {
		if (depth == undefined || depth == null) {
			depth = 0;
		}

		visitor.Visit( this, depth );
		if(this.left != null)
			this.left.VisitAll( visitor, depth + 1 );
		if(this.right != null)
			this.right.VisitAll( visitor, depth + 1 );
	};

	this.ToString = function() {
		return this.type + " " + this.operator;
	};
}

var SequenceBase = function() {
	this.Serialize = function(depth) {
		var str = "";
		str += this.type + "\n";
		for (var i = 0; i < this.options.length; i++) {
			// console.log("SERIALIZE SEQUENCE ");
			// console.log(depth);
			str += leadingWhitespace(depth + 1) + Sym.List + " " + this.options[i].Serialize(depth + 2) + "\n";
		}
		str += leadingWhitespace(depth);
		return str;
	}

	this.VisitAll = function(visitor, depth) {
		if (depth == undefined || depth == null) {
			depth = 0;
		}

		visitor.Visit( this, depth );
		for( var i = 0; i < this.options.length; i++ ) {
			this.options[i].VisitAll( visitor, depth + 1 );
		}
	};

	this.ToString = function() {
		return this.type;
	};
}

var SequenceNode = function(options) {
	Object.assign( this, new TreeRelationship() );
	Object.assign( this, new SequenceBase() );
	this.type = "sequence";
	this.options = options;

	var index = 0;
	this.Eval = function(environment,onReturn) {
		// console.log("SEQUENCE " + index);
		this.options[index].Eval( environment, onReturn );

		var next = index + 1;
		if(next < this.options.length)
			index = next;
	}
}

var CycleNode = function(options) {
	Object.assign( this, new TreeRelationship() );
	Object.assign( this, new SequenceBase() );
	this.type = "cycle";
	this.options = options;

	var index = 0;
	this.Eval = function(environment,onReturn) {
		// console.log("CYCLE " + index);
		this.options[index].Eval( environment, onReturn );

		var next = index + 1;
		if(next < this.options.length)
			index = next;
		else
			index = 0;
	}
}

var ShuffleNode = function(options) {
	Object.assign( this, new TreeRelationship() );
	Object.assign( this, new SequenceBase() );
	this.type = "shuffle";
	this.options = options;

	var optionsShuffled = [];
	function shuffle(options) {
		optionsShuffled = [];
		var optionsUnshuffled = options.slice();
		while(optionsUnshuffled.length > 0) {
			var i = Math.floor( Math.random() * optionsUnshuffled.length );
			optionsShuffled.push( optionsUnshuffled.splice(i,1)[0] );
		}
	}
	shuffle(this.options);

	var index = 0;
	this.Eval = function(environment,onReturn) {
		// OLD RANDOM VERSION
		// var index = Math.floor(Math.random() * this.options.length);
		// this.options[index].Eval( environment, onReturn );

		optionsShuffled[index].Eval( environment, onReturn );
		
		index++;
		if (index >= this.options.length) {
			shuffle(this.options);
			index = 0;
		}
	}
}

var IfNode = function(conditions, results, isSingleLine) {
	Object.assign( this, new TreeRelationship() );
	this.type = "if";
	this.conditions = conditions;
	this.results = results;

	this.Eval = function(environment,onReturn) {
		// console.log("EVAL IF");
		var i = 0;
		var self = this;
		function TestCondition() {
			// console.log("EVAL " + i);
			self.conditions[i].Eval(environment, function(val) {
				// console.log(val);
				if(val == true) {
					self.results[i].Eval(environment, onReturn);
				}
				else if(i+1 < self.conditions.length) {
					i++;
					TestCondition(); // test next condition
				}
				else {
					onReturn(null); // out of conditions and none were true
				}
			});
		};
		TestCondition();
	}

	if(isSingleLine === undefined) isSingleLine = false; // This is just for serialization

	this.Serialize = function(depth) {
		var str = "";
		if(isSingleLine) {
			str += this.conditions[0].Serialize() + " ? " + this.results[0].Serialize();
			if(this.conditions.length > 1 && this.conditions[1].type === "else")
				str += " : " + this.results[1].Serialize();
		}
		else {
			str += "\n";
			for (var i = 0; i < this.conditions.length; i++) {
				str += leadingWhitespace(depth + 1) + Sym.List + " " + this.conditions[i].Serialize(depth) + " ?\n";
				str += this.results[i].Serialize(depth + 2) + "\n";
			}
			str += leadingWhitespace(depth);
		}
		return str;
	}

	this.IsSingleLine = function() {
		return isSingleLine;
	}

	this.VisitAll = function(visitor, depth) {
		if (depth == undefined || depth == null) {
			depth = 0;
		}

		visitor.Visit( this, depth );
		for( var i = 0; i < this.conditions.length; i++ ) {
			this.conditions[i].VisitAll( visitor, depth + 1 );
		}
		for( var i = 0; i < this.results.length; i++ ) {
			this.results[i].VisitAll( visitor, depth + 1 );
		}
	};

	this.ToString = function() {
		return this.type + " " + this.mode;
	};
}

var ElseNode = function() {
	Object.assign( this, new TreeRelationship() );
	this.type = "else";

	this.Eval = function(environment,onReturn) {
		onReturn(true);
	}

	this.Serialize = function() {
		return "else";
	}

	this.ToString = function() {
		return this.type + " " + this.mode;
	};
}

var Sym = {
	// DialogOpen : "/\"",
	// DialogClose : "\"/",
	DialogOpen : '"""',
	DialogClose : '"""',
	CodeOpen : "{",
	CodeClose : "}",
	Linebreak : "\n", // just call it "break" ?
	Separator : ":",
	List : "-",
	String : '"'
};

var Parser = function(env) {
	var environment = env;

	this.Parse = function(scriptStr) {
		// console.log("NEW PARSE!!!!!!");

		// TODO : make this work for single-line, no dialog block scripts

		var state = new ParserState( new BlockNode(BlockMode.Dialog), scriptStr );

		if( state.MatchAhead(Sym.DialogOpen) ) {
			// multi-line dialog block
			var dialogStr = state.ConsumeBlock( Sym.DialogOpen, Sym.DialogClose );
			state = new ParserState( new BlockNode(BlockMode.Dialog), dialogStr );
			state = ParseDialog( state );
		}
		// else if( state.MatchAhead(Sym.CodeOpen) ) { // NOTE: This causes problems when you lead with a code block
		// 	// code-block: should this ever happen?
		// 	state = ParseCodeBlock( state );
		// }
		else {
			// single-line dialog block
			state = ParseDialog( state );
		}

		// console.log( state.rootNode );
		return state.rootNode;
	};

	var ParserState = function( rootNode, str ) {
		this.rootNode = rootNode;
		this.curNode = this.rootNode;

		var sourceStr = str;
		var i = 0;
		this.Index = function() { return i; };
		this.Count = function() { return sourceStr.length; };
		this.Done = function() { return i >= sourceStr.length; };
		this.Char = function() { return sourceStr[i]; };
		this.Step = function(n) { if(n===undefined) n=1; i += n; };
		this.MatchAhead = function(str) {
			// console.log(str);
			str = "" + str; // hack to turn single chars into strings
			// console.log(str);
			// console.log(str.length);
			for(var j = 0; j < str.length; j++) {
				if( i + j >= sourceStr.length )
					return false;
				else if( str[j] != sourceStr[i+j] )
					return false;
			}
			return true;
		}
		this.Peak = function(end) {
			var str = "";
			var j = i;
			// console.log(j);
			while(j < sourceStr.length && end.indexOf( sourceStr[j] ) == -1 ) {
				str += sourceStr[j];
				j++;
			}
			// console.log("PEAK ::" + str + "::");
			return str;
		}
		this.ConsumeBlock = function( open, close ) {
			var startIndex = i;

			var matchCount = 0;
			if( this.MatchAhead( open ) ) {
				matchCount++;
				this.Step( open.length );
			}

			while( matchCount > 0 && !this.Done() ) {
				if( this.MatchAhead( close ) ) {
					matchCount--;
					this.Step( close.length );
				}
				else if( this.MatchAhead( open ) ) {
					matchCount++;
					this.Step( open.length );
				}
				else {
					this.Step();
				}
			}

			// console.log("!!! " + startIndex + " " + i);

			return sourceStr.slice( startIndex + open.length, i - close.length );
		}
		this.Print = function() { console.log(sourceStr); };
		this.Source = function() { return sourceStr; };
	};

	function ParseDialog(state) {
		// console.log("PARSE DIALOG");
		state.Print();

		// for linebreak logic: add linebreaks after lines with dialog or empty lines (if it's not the very first line)
		var hasBlock = false;
		var hasDialog = false;
		var isFirstLine = true;

		// console.log("---- PARSE DIALOG ----");

		var text = "";
		var addTextNode = function() {
			// console.log("TEXT " + text.length);
			if (text.length > 0) {
				// console.log("TEXT " + text);
				// console.log("text!!");
				// console.log([text]);

				state.curNode.AddChild( new FuncNode( "print", [new LiteralNode(text)] ) );
				text = "";

				hasDialog = true;
			}
		}

		while ( !state.Done() ) {

			if( state.MatchAhead(Sym.CodeOpen) ) {
				addTextNode();
				state = ParseCodeBlock( state );

				// console.log("CODE");

				var len = state.curNode.children.length;
				if(len > 0 && state.curNode.children[len-1].type === "block") {
					var block = state.curNode.children[len-1];
					if(isMultilineListBlock(block))
						hasDialog = true; // hack to get correct newline behavior for multiline blocks
				}

				hasBlock = true;
			}
			// NOTE: nested dialog blocks disabled for now
			// else if( state.MatchAhead(Sym.DialogOpen) ) {
			// 	addTextNode();
			// 	state = ParseDialogBlock( state ); // These can be nested (should they though???)

			// 	hasBlock = true;
			// }
			else {
				if ( state.MatchAhead(Sym.Linebreak) ) {
					addTextNode();

					/*
					NOTES:
					linebreaks SHOULD happen on
					- lines with text (including the first or last line)
					- empty lines (that are NOT the first or last line)
					linebreaks should NOT happen on
					- lines with only CODE blocks
					- empty FIRST or LAST lines

					also, apparently:
					- NEVER line break on the last line
					*/
					var isLastLine = (state.Index() + 1) == state.Count();
					// console.log("block " + hasBlock);
					// console.log("dialog " + hasDialog);
					var isEmptyLine = !hasBlock && !hasDialog;
					// console.log("empty " + isEmptyLine);
					var isValidEmptyLine = isEmptyLine && !(isFirstLine || isLastLine);
					// console.log("valid empty " + isValidEmptyLine);
					var shouldAddLinebreak = (hasDialog || isValidEmptyLine) && !isLastLine; // last clause is a hack (but it works - why?)
					// console.log("LINEBREAK? " + shouldAddLinebreak);
					if( shouldAddLinebreak ) {
						// console.log("NEWLINE");
						// console.log("empty? " + isEmptyLine);
						// console.log("dialog? " + hasDialog);
						state.curNode.AddChild( new FuncNode( "br", [] ) ); // use function or character?
					}

					// linebreak logic
					isFirstLine = false;
					hasBlock = false;
					hasDialog = false;

					text = "";
				}
				else {
					text += state.Char();
				}
				state.Step();
			}

		}
		addTextNode();

		// console.log("---- PARSE DIALOG ----");

		// console.log(state);
		return state;
	}

	function ParseDialogBlock(state) {
		var dialogStr = state.ConsumeBlock( Sym.DialogOpen, Sym.DialogClose );

		var dialogState = new ParserState( new BlockNode(BlockMode.Dialog), dialogStr );
		dialogState = ParseDialog( dialogState );

		state.curNode.AddChild( dialogState.rootNode );

		return state;
	}

	function ParseIf(state) {
		var conditionStrings = [];
		var resultStrings = [];
		var curIndex = -1;
		var isNewline = true;
		var isConditionDone = false;
		var codeBlockCount = 0;

		while( !state.Done() ) {
			if(state.Char() === Sym.CodeOpen)
				codeBlockCount++;
			else if(state.Char() === Sym.CodeClose)
				codeBlockCount--;

			var isWhitespace = (state.Char() === " " || state.Char() === "\t");
			var isSkippableWhitespace = isNewline && isWhitespace;
			var isNewListItem = isNewline && (codeBlockCount <= 0) && (state.Char() === Sym.List);

			if(isNewListItem) {
				curIndex++;
				isConditionDone = false;
				conditionStrings[curIndex] = "";
				resultStrings[curIndex] = "";
			}
			else if(curIndex > -1) {
				if(!isConditionDone) {
					if(state.Char() === "?" || state.Char() === "\n") { // TODO: use Sym
						// end of condition
						isConditionDone = true;
					}
					else {
						// read in condition
						conditionStrings[curIndex] += state.Char();
					}
				}
				else {
					// read in result
					if(!isSkippableWhitespace)
						resultStrings[curIndex] += state.Char();
				}
			}

			isNewline = (state.Char() === Sym.Linebreak) || isSkippableWhitespace || isNewListItem;

			state.Step();
		}

		// console.log("PARSE IF:");
		// console.log(conditionStrings);
		// console.log(resultStrings);

		var conditions = [];
		for(var i = 0; i < conditionStrings.length; i++) {
			var str = conditionStrings[i].trim();
			if(str === "else") {
				conditions.push( new ElseNode() );
			}
			else {
				var exp = CreateExpression( str );
				conditions.push( exp );
			}
		}

		var results = [];
		for(var i = 0; i < resultStrings.length; i++) {
			var str = resultStrings[i];
			var dialogBlockState = new ParserState( new BlockNode(BlockMode.Dialog), str );
			dialogBlockState = ParseDialog( dialogBlockState );
			var dialogBlock = dialogBlockState.rootNode;
			results.push( dialogBlock );
		}

		state.curNode.AddChild( new IfNode( conditions, results ) );

		return state;
	}

	function IsSequence(str) {
		// console.log("IsSequence? " + str);
		return str === "sequence" || str === "cycle" || str === "shuffle";
	}

	// TODO: don't forget about eating whitespace
	function ParseSequence(state, sequenceType) {
		// console.log("SEQUENCE " + sequenceType);
		state.Print();

		var isNewline = false;
		var itemStrings = [];
		var curItemIndex = -1; // -1 indicates not reading an item yet
		var codeBlockCount = 0;

		while( !state.Done() ) {
			if(state.Char() === Sym.CodeOpen)
				codeBlockCount++;
			else if(state.Char() === Sym.CodeClose)
				codeBlockCount--;

			var isWhitespace = (state.Char() === " " || state.Char() === "\t");
			var isSkippableWhitespace = isNewline && isWhitespace;
			var isNewListItem = isNewline && (codeBlockCount <= 0) && (state.Char() === Sym.List);

			if(isNewListItem) {
				// console.log("found next list item");
				curItemIndex++;
				itemStrings[curItemIndex] = "";
			}
			else if(curItemIndex > -1) {
				if(!isSkippableWhitespace)
					itemStrings[curItemIndex] += state.Char();
			}

			isNewline = (state.Char() === Sym.Linebreak) || isSkippableWhitespace || isNewListItem;

			// console.log(state.Char());
			state.Step();
		}
		// console.log(itemStrings);
		// console.log("SEQUENCE DONE");

		var options = [];
		for(var i = 0; i < itemStrings.length; i++) {
			var str = itemStrings[i];
			var dialogBlockState = new ParserState( new BlockNode( BlockMode.Dialog, false /* doIndentFirstLine */ ), str );
			dialogBlockState = ParseDialog( dialogBlockState );
			var dialogBlock = dialogBlockState.rootNode;
			options.push( dialogBlock );
		}

		// console.log(options);

		if(sequenceType === "sequence")
			state.curNode.AddChild( new SequenceNode( options ) );
		else if(sequenceType === "cycle")
			state.curNode.AddChild( new CycleNode( options ) );
		else if(sequenceType === "shuffle")
			state.curNode.AddChild( new ShuffleNode( options ) );

		return state;
	}

	function ParseFunction(state, funcName) {
		console.log("~~~ PARSE FUNCTION " + funcName);

		var args = [];

		var curSymbol = "";
		function OnSymbolEnd() {
			curSymbol = curSymbol.trim();
			// console.log("PARAMTER " + curSymbol);
			args.push( StringToValue(curSymbol) );
			// console.log(args);
			curSymbol = "";
		}

		while( !( state.Char() === "\n" || state.Done() ) ) {
			if( state.MatchAhead(Sym.CodeOpen) ) {
				var codeBlockState = new ParserState( new BlockNode(BlockMode.Code), state.ConsumeBlock( Sym.CodeOpen, Sym.CodeClose ) );
				codeBlockState = ParseCode( codeBlockState );
				var codeBlock = codeBlockState.rootNode;
				args.push( codeBlock );
				curSymbol = "";
			}
			else if( state.MatchAhead(Sym.String) ) {
				/* STRING LITERAL */
				var str = state.ConsumeBlock(Sym.String, Sym.String);
				// console.log("STRING " + str);
				args.push( new LiteralNode(str) );
				curSymbol = "";
			}
			else if(state.Char() === " " && curSymbol.length > 0) {
				OnSymbolEnd();
			}
			else {
				curSymbol += state.Char();
			}
			state.Step();
		}

		if(curSymbol.length > 0) {
			OnSymbolEnd();
		}

		state.curNode.AddChild( new FuncNode( funcName, args ) );

		return state;
	}

	function IsValidVariableName(str) {
		var reg = /^[a-zA-Z_$][a-zA-Z_$0-9]*$/;
		var isValid = reg.test(str);
		// console.log("VALID variable??? " + isValid);
		return isValid;
	}

	function StringToValue(valStr) {
		if(valStr[0] === Sym.CodeOpen) {
			// CODE BLOCK!!!
			var codeStr = (new ParserState( null, valStr )).ConsumeBlock(Sym.CodeOpen, Sym.CodeClose); //hacky
			var codeBlockState = new ParserState( new BlockNode( BlockMode.Code ), codeStr );
			codeBlockState = ParseCode( codeBlockState );
			return codeBlockState.rootNode;
		}
		else if(valStr[0] === Sym.String) {
			// STRING!!
			// console.log("STRING");
			var str = "";
			var i = 1;
			while (i < valStr.length && valStr[i] != Sym.String) {
				str += valStr[i];
				i++;
			}
			// console.log(str);
			return new LiteralNode( str );
		}
		else if(valStr === "true") {
			// BOOL
			return new LiteralNode( true );
		}
		else if(valStr === "false") {
			// BOOL
			return new LiteralNode( false );
		}
		else if( !isNaN(parseFloat(valStr)) ) {
			// NUMBER!!
			// console.log("NUMBER!!! " + valStr);
			return new LiteralNode( parseFloat(valStr) );
		}
		else if(IsValidVariableName(valStr)) {
			// VARIABLE!!
			// console.log("VARIABLE");
			return new VarNode(valStr); // TODO : check for valid potential variables
		}
		else {
			// uh oh
			return new LiteralNode(null);
		}
	}

	var setSymbol = "=";
	var ifSymbol = "?";
	var elseSymbol = ":";
	var operatorSymbols = ["==", ">", "<", ">=", "<=", "-", "+", "/", "*"]; // operators need to be in reverse order of precedence
	function CreateExpression(expStr) {
		console.log("CREATE EXPRESSION --- " + expStr);

		expStr = expStr.trim();

		function IsInsideString(index) {
			var inString = false;
			for(var i = 0; i < expStr.length; i++) {
				if(expStr[i] === Sym.String)
					inString = !inString;

				if(index === i)
					return inString;
			}
			return false;
		}

		function IsInsideCode(index) {
			var count = 0;
			for(var i = 0; i < expStr.length; i++) {
				if(expStr[i] === Sym.CodeOpen)
					count++;
				else if(expStr[i] === Sym.CodeClose)
					count--;

				if(index === i)
					return count > 0;
			}
			return false;
		}

		var operator = null;

		// set is special because other operator can look like it, and it has to go first in the order of operations
		var setIndex = expStr.indexOf(setSymbol);
		if( setIndex > -1 && !IsInsideString(setIndex) && !IsInsideCode(setIndex) ) { // it might be a set operator
			if( expStr[setIndex+1] != "=" && expStr[setIndex-1] != ">" && expStr[setIndex-1] != "<" ) {
				// ok it actually IS a set operator and not ==, >=, or <=
				operator = setSymbol;
				var variableName = expStr.substring(0,setIndex).trim(); // TODO : valid variable name testing
				var left = IsValidVariableName(variableName) ? new VarNode( variableName ) : new LiteralNode(null);
				var right = CreateExpression( expStr.substring(setIndex+setSymbol.length) );
				var exp = new ExpNode( operator, left, right );
				return exp;
			}
		}

		// special if "expression" for single-line if statements
		var ifIndex = expStr.indexOf(ifSymbol);
		if( ifIndex > -1 && !IsInsideString(ifIndex) && !IsInsideCode(ifIndex) ) {
			operator = ifSymbol;
			var conditionStr = expStr.substring(0,ifIndex).trim();
			var conditions = [ CreateExpression(conditionStr) ];

			var resultStr = expStr.substring(ifIndex+ifSymbol.length);
			var results = [];
			function AddResult(str) {
				var dialogBlockState = new ParserState( new BlockNode(BlockMode.Dialog), str );
				dialogBlockState = ParseDialog( dialogBlockState );
				var dialogBlock = dialogBlockState.rootNode;
				results.push( dialogBlock );
			}

			var elseIndex = resultStr.indexOf(elseSymbol); // does this need to test for strings?
			if(elseIndex > -1) {
				conditions.push( new ElseNode() );

				var elseStr = resultStr.substring(elseIndex+elseSymbol.length);
				var resultStr = resultStr.substring(0,elseIndex);

				AddResult( resultStr.trim() );
				AddResult( elseStr.trim() );
			}
			else {
				AddResult( resultStr.trim() );
			}

			return new IfNode( conditions, results, true /*isSingleLine*/ );
		}

		for( var i = 0; (operator == null) && (i < operatorSymbols.length); i++ ) {
			var opSym = operatorSymbols[i];
			var opIndex = expStr.indexOf( opSym );
			if( opIndex > -1 && !IsInsideString(opIndex) && !IsInsideCode(opIndex) ) {
				operator = opSym;
				var left = CreateExpression( expStr.substring(0,opIndex) );
				var right = CreateExpression( expStr.substring(opIndex+opSym.length) );
				var exp = new ExpNode( operator, left, right );
				return exp;
			}
		}

		if( operator == null ) {
			return StringToValue(expStr);
		}
	}
	this.CreateExpression = CreateExpression;

	function IsWhitespace(str) {
		return ( str === " " || str === "\t" || str === "\n" );
	}

	function IsExpression(str) {
		var tempState = new ParserState(null, str); // hacky
		var nonWhitespaceCount = 0;

		while (!tempState.Done()) {
			if( IsWhitespace(tempState.Char()) ) {
				tempState.Step(); // consume whitespace
			}
			else if( tempState.MatchAhead(Sym.CodeOpen) ) {
				tempState.ConsumeBlock( Sym.CodeOpen, Sym.CodeClose );
			}
			else {
				nonWhitespaceCount++;
				tempState.Step();
			}
		}

		var isExpression = nonWhitespaceCount > 0;
		return isExpression;
	}

	function ParseExpression(state) {
		var line = state.Source(); // state.Peak( [Sym.Linebreak] ); // TODO : remove the linebreak thing
		// console.log("EXPRESSION " + line);
		var exp = CreateExpression( line );
		// console.log(exp);
		state.curNode.AddChild( exp );
		state.Step( line.length );
		return state;
	}

	function ParseCode(state) {
		console.log("PARSE CODE --- " + state.Source());

		// skip leading whitespace
		while (IsWhitespace(state.Char())) {
			state.Step();
		}

		if( state.Char() === Sym.List && (state.Peak([]).indexOf("?") > -1) ) { // TODO : symbols? matchahead?
			// console.log("PEAK IF " + state.Peak( ["?"] ));
			state = ParseIf( state );
		}
		else if( environment.HasFunction( state.Peak( [" "] ) ) ) { // TODO --- what about newlines???
			var funcName = state.Peak( [" "] );
			state.Step( funcName.length );
			state = ParseFunction( state, funcName );
		}
		else if( IsSequence( state.Peak( [" ", Sym.Linebreak] ) ) ) {
			var sequenceType = state.Peak( [" ", Sym.Linebreak] );
			state.Step( sequenceType.length );
			state = ParseSequence( state, sequenceType );
		}
		else if (IsExpression(state.Source())) {
			state = ParseExpression(state);
		}
		else {
			// multi-line code block
			while (!state.Done()) {
				if( state.MatchAhead(Sym.CodeOpen) ) {
					state = ParseCodeBlock( state );
				}
				else {
					state.Step();
				}
			}
		}

		// just go to the end now
		while (!state.Done()) {
			state.Step();
		}

		return state;
	}

	function ParseCodeBlock(state) {
		var codeStr = state.ConsumeBlock( Sym.CodeOpen, Sym.CodeClose );

		// console.log("PARSE CODE");
		// console.log(codeStr);

		var codeState = new ParserState( new BlockNode(BlockMode.Code), codeStr );
		codeState = ParseCode( codeState );
		
		state.curNode.AddChild( codeState.rootNode );

		return state;
	}

}

} // Script()
</script>

<script>
function Dialog() {

this.CreateRenderer = function() {
	return new DialogRenderer();
};

this.CreateBuffer = function() {
	return new DialogBuffer();
};

var DialogRenderer = function() {

	// TODO : refactor this eventually? remove everything from struct.. avoid the defaults?
	var textboxInfo = {
		img : null,
		width : 104,
		height : 8+4+2+5, //8 for text, 4 for top-bottom padding, 2 for line padding, 5 for arrow
		top : 12,
		left : 12,
		bottom : 12, //for drawing it from the bottom
		font_scale : 0.5, // we draw font at half-size compared to everything else
		padding_vert : 2,
		padding_horz : 4,
		arrow_height : 5,
	};

	var font = null;
	this.SetFont = function(f) {
		font = f;
		textboxInfo.height = (textboxInfo.padding_vert * 3) + (relativeFontHeight() * 2) + textboxInfo.arrow_height;
		textboxInfo.img = context.createImageData(textboxInfo.width*scale, textboxInfo.height*scale);
	}

	function textScale() {
		return scale * textboxInfo.font_scale;
	}

	function relativeFontWidth() {
		return Math.ceil( font.getWidth() * textboxInfo.font_scale );
	}

	function relativeFontHeight() {
		return Math.ceil( font.getHeight() * textboxInfo.font_scale );
	}

	var context = null;
	this.AttachContext = function(c) {
		context = c;
	};

	this.ClearTextbox = function() {
		if(context == null) return;

		//create new image none exists
		if(textboxInfo.img == null)
			textboxInfo.img = context.createImageData(textboxInfo.width*scale, textboxInfo.height*scale);

		// fill text box with black
		for (var i=0;i<textboxInfo.img.data.length;i+=4)
		{
			textboxInfo.img.data[i+0]=0;
			textboxInfo.img.data[i+1]=0;
			textboxInfo.img.data[i+2]=0;
			textboxInfo.img.data[i+3]=255;
		}
	};

	var isCentered = false;
	this.SetCentered = function(centered) {
		isCentered = centered;
	};

	this.DrawTextbox = function() {
		if(context == null) return;
		if (isCentered) {
			context.putImageData(textboxInfo.img, textboxInfo.left*scale, ((height/2)-(textboxInfo.height/2))*scale);
		}
		else if (player().y < mapsize/2) {
			//bottom
			context.putImageData(textboxInfo.img, textboxInfo.left*scale, (height-textboxInfo.bottom-textboxInfo.height)*scale);
		}
		else {
			//top
			context.putImageData(textboxInfo.img, textboxInfo.left*scale, textboxInfo.top*scale);
		}
	};

	var arrowdata = [
		1,1,1,1,1,
		0,1,1,1,0,
		0,0,1,0,0
	];
	this.DrawNextArrow = function() {
		// console.log("draw arrow!");
		var top = (textboxInfo.height-5) * scale;
		var left = (textboxInfo.width-(5+4)) * scale;
		if (textDirection === TextDirection.RightToLeft) { // RTL hack
			left = 4 * scale;
		}

		for (var y = 0; y < 3; y++) {
			for (var x = 0; x < 5; x++) {
				var i = (y * 5) + x;
				if (arrowdata[i] == 1) {
					//scaling nonsense
					for (var sy = 0; sy < scale; sy++) {
						for (var sx = 0; sx < scale; sx++) {
							var pxl = 4 * ( ((top+(y*scale)+sy) * (textboxInfo.width*scale)) + (left+(x*scale)+sx) );
							textboxInfo.img.data[pxl+0] = 255;
							textboxInfo.img.data[pxl+1] = 255;
							textboxInfo.img.data[pxl+2] = 255;
							textboxInfo.img.data[pxl+3] = 255;
						}
					}
				}
			}
		}
	};

	var text_scale = 2; //using a different scaling factor for text feels like cheating... but it looks better
	this.DrawChar = function(char, row, col, leftPos) {
		char.offset = {
			x: char.base_offset.x,
			y: char.base_offset.y
		}; // compute render offset *every* frame

		char.SetPosition(row,col);
		char.ApplyEffects(effectTime);

		var charData = char.bitmap;

		var top = (4 * scale) + (row * 2 * scale) + (row * font.getHeight() * text_scale) + Math.floor( char.offset.y );
		var left = (4 * scale) + (leftPos * text_scale) + Math.floor( char.offset.x );

		var debug_r = Math.random() * 255;

		for (var y = 0; y < char.height; y++) {
			for (var x = 0; x < char.width; x++) {

				var i = (y * char.width) + x;
				if ( charData[i] == 1 ) {

					//scaling nonsense
					for (var sy = 0; sy < text_scale; sy++) {
						for (var sx = 0; sx < text_scale; sx++) {
							var pxl = 4 * ( ((top+(y*text_scale)+sy) * (textboxInfo.width*scale)) + (left+(x*text_scale)+sx) );
							textboxInfo.img.data[pxl+0] = char.color.r;
							textboxInfo.img.data[pxl+1] = char.color.g;
							textboxInfo.img.data[pxl+2] = char.color.b;
							textboxInfo.img.data[pxl+3] = char.color.a;
						}
					}
				}
				// else {
				// 	// DEBUG

				// 	//scaling nonsense
				// 	for (var sy = 0; sy < text_scale; sy++) {
				// 		for (var sx = 0; sx < text_scale; sx++) {
				// 			var pxl = 4 * ( ((top+(y*text_scale)+sy) * (textboxInfo.width*scale)) + (left+(x*text_scale)+sx) );
				// 			textboxInfo.img.data[pxl+0] = debug_r;
				// 			textboxInfo.img.data[pxl+1] = 0;
				// 			textboxInfo.img.data[pxl+2] = 0;
				// 			textboxInfo.img.data[pxl+3] = 255;
				// 		}
				// 	}
				// }

			}
		}
		
		// call printHandler for character
		char.OnPrint();
	};

	var effectTime = 0; // TODO this variable should live somewhere better
	this.Draw = function(buffer,dt) {
		effectTime += dt;

		this.ClearTextbox();

		buffer.ForEachActiveChar( this.DrawChar );

		if( buffer.CanContinue() )
			this.DrawNextArrow();

		this.DrawTextbox();

		if( buffer.DidPageFinishThisFrame() && onPageFinish != null )
			onPageFinish();
	};

	/* this is a hook for GIF rendering */
	var onPageFinish = null;
	this.SetPageFinishHandler = function(handler) {
		onPageFinish = handler;
	};

	this.Reset = function() {
		effectTime = 0;
		// TODO - anything else?
	}

	// this.CharsPerRow = function() {
	// 	return textboxInfo.charsPerRow;
	// }
}


var DialogBuffer = function() {
	var buffer = [[[]]]; // holds dialog in an array buffer
	var pageIndex = 0;
	var rowIndex = 0;
	var charIndex = 0;
	var nextCharTimer = 0;
	var nextCharMaxTime = 50; // in milliseconds
	var isDialogReadyToContinue = false;
	var activeTextEffects = [];
	var font = null;
	var arabicHandler = new ArabicHandler();
	var onDialogEndCallbacks = [];

	this.SetFont = function(f) {
		font = f;
	}

	this.CurPage = function() { return buffer[ pageIndex ]; };
	this.CurRow = function() { return this.CurPage()[ rowIndex ]; };
	this.CurChar = function() { return this.CurRow()[ charIndex ]; };
	this.CurPageCount = function() { return buffer.length; };
	this.CurRowCount = function() { return this.CurPage().length; };
	this.CurCharCount = function() { return this.CurRow().length; };

	this.ForEachActiveChar = function(handler) { // Iterates over visible characters on the active page
		var rowCount = rowIndex + 1;
		for (var i = 0; i < rowCount; i++) {
			var row = this.CurPage()[i];
			var charCount = (i == rowIndex) ? charIndex+1 : row.length;
			// console.log(charCount);

			var leftPos = 0;
			if (textDirection === TextDirection.RightToLeft) {
				leftPos = 24 * 8; // hack -- I think this is correct?
			}

			for(var j = 0; j < charCount; j++) {
				var char = row[j];
				if(char) {
					if (textDirection === TextDirection.RightToLeft) {
						leftPos -= char.spacing;
					}
					// console.log(j + " " + leftPos);

					// handler( char, i /*rowIndex*/, j /*colIndex*/ );
					handler(char, i /*rowIndex*/, j /*colIndex*/, leftPos)

					if (textDirection === TextDirection.LeftToRight) {
						leftPos += char.spacing;
					}
				}
			}
		}
	}

	this.Reset = function() {
		buffer = [[[]]];
		pageIndex = 0;
		rowIndex = 0;
		charIndex = 0;
		isDialogReadyToContinue = false;

		activeTextEffects = [];

		onDialogEndCallbacks = [];

		isActive = false;
	};

	this.DoNextChar = function() {
		// console.log("DO NEXT CHAR");

		nextCharTimer = 0; //reset timer

		//time to update characters
		if (charIndex + 1 < this.CurCharCount()) {
			//add char to current row
			charIndex++;
		}
		else if (rowIndex + 1 < this.CurRowCount()) {
			//start next row
			rowIndex++;
			charIndex = 0;
		}
		else {
			//the page is full!
			isDialogReadyToContinue = true;
			didPageFinishThisFrame = true;

			// console.log("WAITING FOR INPUT");
		}

		// console.log(this.CurChar());
		if(this.CurChar() != null)
			this.CurChar().OnPrint(); // make sure we hit the callback before we run out of text
	};

	this.Update = function(dt) {
		didPageFinishThisFrame = false;
		didFlipPageThisFrame = false;
		// this.Draw(dt); // TODO move into a renderer object
		if (isDialogReadyToContinue) {
			return; //waiting for dialog to be advanced by player
		}

		nextCharTimer += dt; //tick timer

		if (nextCharTimer > nextCharMaxTime) {
			this.DoNextChar();
		}
	};

	this.Skip = function() {
		console.log("SKIPPP");
		didPageFinishThisFrame = false;
		didFlipPageThisFrame = false;
		// add new characters until you get to the end of the current line of dialog
		while (rowIndex < this.CurRowCount()) {
			this.DoNextChar();

			if(isDialogReadyToContinue) {
				//make sure to push the rowIndex past the end to break out of the loop
				rowIndex++;
				charIndex = 0;
			}
		}
		rowIndex = this.CurRowCount()-1;
		charIndex = this.CurCharCount()-1;
	};

	this.FlipPage = function() {
		didFlipPageThisFrame = true;
		isDialogReadyToContinue = false;
		pageIndex++;
		rowIndex = 0;
		charIndex = 0;
	}

	this.EndDialog = function() {
		isActive = false; // no more text to show... this should be a sign to stop rendering dialog

		for (var i = 0; i < onDialogEndCallbacks.length; i++) {
			onDialogEndCallbacks[i]();
		}
	}

	this.Continue = function() {
		console.log("CONTINUE");
		if (pageIndex + 1 < this.CurPageCount()) {
			//start next page
			this.FlipPage();
			return true; /* hasMoreDialog */
		}
		else {
			//end dialog mode
			this.EndDialog();
			return false; /* hasMoreDialog */
		}
	};

	var isActive = false;
	this.IsActive = function() { return isActive; };

	this.OnDialogEnd = function(callback) {
		if (!isActive) {
			callback();
		}
		else {
			onDialogEndCallbacks.push(callback);
		}
	}

	this.CanContinue = function() { return isDialogReadyToContinue; };

	function DialogChar(effectList) {
		this.effectList = effectList.slice(); // clone effect list (since it can change between chars)

		this.color = { r:255, g:255, b:255, a:255 };
		this.offset = { x:0, y:0 }; // in pixels (screen pixels?)

		this.col = 0;
		this.row = 0;

		this.SetPosition = function(row,col) {
			// console.log("SET POS");
			// console.log(this);
			this.row = row;
			this.col = col;
		}

		this.ApplyEffects = function(time) {
			// console.log("APPLY EFFECTS! " + time);
			for(var i = 0; i < this.effectList.length; i++) {
				var effectName = this.effectList[i];
				// console.log("FX " + effectName);
				TextEffects[ effectName ].DoEffect( this, time );
			}
		}

		var printHandler = null; // optional function to be called once on printing character
		this.SetPrintHandler = function(handler) {
			printHandler = handler;
		}
		this.OnPrint = function() {
			if (printHandler != null) {
				console.log("PRINT HANDLER ---- DIALOG BUFFER");
				printHandler();
				printHandler = null; // only call handler once (hacky)
			}
		}

		this.bitmap = [];
		this.width = 0;
		this.height = 0;
		this.base_offset = { // hacky name
 			x: 0,
			y: 0
		};
		this.spacing = 0;
	}

	function DialogFontChar(font, char, effectList) {
		Object.assign(this, new DialogChar(effectList));

		var charData = font.getChar(char);
		this.bitmap = charData.data;
		this.width = charData.width;
		this.height = charData.height;
		this.base_offset.x = charData.offset.x;
		this.base_offset.y = charData.offset.y;
		this.spacing = charData.spacing;
	}

	function DialogDrawingChar(drawingId, effectList) {
		Object.assign(this, new DialogChar(effectList));

		var imageData = renderer.GetImageSource(drawingId)[0];
		var imageDataFlat = [];
		for (var i = 0; i < imageData.length; i++) {
			// console.log(imageData[i]);
			imageDataFlat = imageDataFlat.concat(imageData[i]);
		}

		this.bitmap = imageDataFlat;
		this.width = 8;
		this.height = 8;
		this.spacing = 8;
	}

	function AddWordToCharArray(charArray,word,effectList) {
		for(var i = 0; i < word.length; i++) {
			charArray.push( new DialogFontChar( font, word[i], effectList ) );
		}
		return charArray;
	}

	function GetCharArrayWidth(charArray) {
		var width = 0;
		for(var i = 0; i < charArray.length; i++) {
			width += charArray[i].spacing;
		}
		return width;
	}

	function GetStringWidth(str) {
		var width = 0;
		for (var i = 0; i < str.length; i++) {
			var charData = font.getChar(str[i]);
			width += charData.spacing;
		}
		return width;
	}

	var pixelsPerRow = 192; // hard-coded fun times!!!

	this.AddDrawing = function(drawingId, onFinishHandler) {
		// console.log("DRAWING ID " + drawingId);

		var curPageIndex = buffer.length - 1;
		var curRowIndex = buffer[curPageIndex].length - 1;
		var curRowArr = buffer[curPageIndex][curRowIndex];

		var drawingChar = new DialogDrawingChar(drawingId, activeTextEffects)
		drawingChar.SetPrintHandler( onFinishHandler );

		var rowLength = GetCharArrayWidth(curRowArr);

		// TODO : clean up copy-pasted code here :/
		if (rowLength + drawingChar.spacing  <= pixelsPerRow || rowLength <= 0)
		{
			//stay on same row
			curRowArr.push( drawingChar );
		}
		else if (curRowIndex == 0)
		{
			//start next row
			buffer[ curPageIndex ][ curRowIndex ] = curRowArr;
			buffer[ curPageIndex ].push( [] );
			curRowIndex++;
			curRowArr = buffer[ curPageIndex ][ curRowIndex ];
			curRowArr.push( drawingChar );
		}
		else {
			//start next page
			buffer[ curPageIndex ][ curRowIndex ] = curRowArr;
			buffer.push( [] );
			curPageIndex++;
			buffer[ curPageIndex ].push( [] );
			curRowIndex = 0;
			curRowArr = buffer[ curPageIndex ][ curRowIndex ];
			curRowArr.push( drawingChar );
		}

		isActive = true; // this feels like a bad way to do this???
	}

	// TODO : convert this into something that takes DialogChar arrays
	this.AddText = function(textStr,onFinishHandler) {
		// console.log("ADD TEXT " + textStr);

		//process dialog so it's easier to display
		var words = textStr.split(" ");

		// var curPageIndex = this.CurPageCount() - 1;
		// var curRowIndex = this.CurRowCount() - 1;
		// var curRowArr = this.CurRow();

		var curPageIndex = buffer.length - 1;
		var curRowIndex = buffer[curPageIndex].length - 1;
		var curRowArr = buffer[curPageIndex][curRowIndex];

		for (var i = 0; i < words.length; i++) {
			var word = words[i];
			if (arabicHandler.ContainsArabicCharacters(word)) {
				word = arabicHandler.ShapeArabicCharacters(word);
			}

			var wordWithPrecedingSpace = ((i == 0) ? "" : " ") + word;
			var wordLength = GetStringWidth( wordWithPrecedingSpace );

			var rowLength = GetCharArrayWidth(curRowArr);

			if (rowLength + wordLength <= pixelsPerRow || rowLength <= 0) {
				//stay on same row
				curRowArr = AddWordToCharArray( curRowArr, wordWithPrecedingSpace, activeTextEffects );
			}
			else if (curRowIndex == 0) {
				//start next row
				buffer[ curPageIndex ][ curRowIndex ] = curRowArr;
				buffer[ curPageIndex ].push( [] );
				curRowIndex++;
				curRowArr = buffer[ curPageIndex ][ curRowIndex ];
				curRowArr = AddWordToCharArray( curRowArr, word, activeTextEffects );
			}
			else {
				//start next page
				buffer[ curPageIndex ][ curRowIndex ] = curRowArr;
				buffer.push( [] );
				curPageIndex++;
				buffer[ curPageIndex ].push( [] );
				curRowIndex = 0;
				curRowArr = buffer[ curPageIndex ][ curRowIndex ];
				curRowArr = AddWordToCharArray( curRowArr, word, activeTextEffects );
			}
		}

		//destroy any empty stuff
		var lastPage = buffer[ buffer.length-1 ];
		var lastRow = lastPage[ lastPage.length-1 ];
		if( lastRow.length == 0 )
			lastPage.splice( lastPage.length-1, 1 );
		if( lastPage.length == 0 )
			buffer.splice( buffer.length-1, 1 );

		//finish up 
		lastPage = buffer[ buffer.length-1 ];
		lastRow = lastPage[ lastPage.length-1 ];
		if( lastRow.length > 0 ) {
			var lastChar = lastRow[ lastRow.length-1 ];
			lastChar.SetPrintHandler( onFinishHandler );
		}

		console.log(buffer);

		isActive = true;
	};

	this.AddLinebreak = function() {
		var lastPage = buffer[ buffer.length-1 ];
		if( lastPage.length <= 1 ) {
			console.log("LINEBREAK - NEW ROW ");
			// add new row
			lastPage.push( [] );
		}
		else {
			// add new page
			buffer.push( [[]] );
		}
		console.log(buffer);

		isActive = true;
	}

	/* new text effects */
	this.HasTextEffect = function(name) {
		return activeTextEffects.indexOf( name ) > -1;
	}
	this.AddTextEffect = function(name) {
		activeTextEffects.push( name );
	}
	this.RemoveTextEffect = function(name) {
		activeTextEffects.splice( activeTextEffects.indexOf( name ), 1 );
	}

	/* this is a hook for GIF rendering */
	var didPageFinishThisFrame = false;
	this.DidPageFinishThisFrame = function(){ return didPageFinishThisFrame; };

	var didFlipPageThisFrame = false;
	this.DidFlipPageThisFrame = function(){ return didFlipPageThisFrame; };

	// this.SetCharsPerRow = function(num){ charsPerRow = num; }; // hacky
};

/* ARABIC */
var ArabicHandler = function() {

	var arabicCharStart = 0x0621;
	var arabicCharEnd = 0x064E;

	var CharacterForm = {
		Isolated : 0,
		Final : 1,
		Initial : 2,
		Middle : 3
	};

	// map glyphs to their character forms
	var glyphForms = {
		/*		 Isolated, Final, Initial, Middle Forms	*/
		0x0621: [0xFE80,0xFE80,0xFE80,0xFE80], /*  HAMZA  */ 
		0x0622: [0xFE81,0xFE82,0xFE81,0xFE82], /*  ALEF WITH MADDA ABOVE  */ 
		0x0623: [0xFE83,0xFE84,0xFE83,0xFE84], /*  ALEF WITH HAMZA ABOVE  */ 
		0x0624: [0xFE85,0xFE86,0xFE85,0xFE86], /*  WAW WITH HAMZA ABOVE  */ 
		0x0625: [0xFE87,0xFE88,0xFE87,0xFE88], /*  ALEF WITH HAMZA BELOW  */ 
		0x0626: [0xFE89,0xFE8A,0xFE8B,0xFE8C], /*  YEH WITH HAMZA ABOVE  */ 
		0x0627: [0xFE8D,0xFE8E,0xFE8D,0xFE8E], /*  ALEF  */ 
		0x0628: [0xFE8F,0xFE90,0xFE91,0xFE92], /*  BEH  */ 
		0x0629: [0xFE93,0xFE94,0xFE93,0xFE94], /*  TEH MARBUTA  */ 
		0x062A: [0xFE95,0xFE96,0xFE97,0xFE98], /*  TEH  */ 
		0x062B: [0xFE99,0xFE9A,0xFE9B,0xFE9C], /*  THEH  */ 
		0x062C: [0xFE9D,0xFE9E,0xFE9F,0xFEA0], /*  JEEM  */ 
		0x062D: [0xFEA1,0xFEA2,0xFEA3,0xFEA4], /*  HAH  */ 
		0x062E: [0xFEA5,0xFEA6,0xFEA7,0xFEA8], /*  KHAH  */ 
		0x062F: [0xFEA9,0xFEAA,0xFEA9,0xFEAA], /*  DAL  */ 
		0x0630: [0xFEAB,0xFEAC,0xFEAB,0xFEAC], /*  THAL */ 
		0x0631: [0xFEAD,0xFEAE,0xFEAD,0xFEAE], /*  RAA  */ 
		0x0632: [0xFEAF,0xFEB0,0xFEAF,0xFEB0], /*  ZAIN  */ 
		0x0633: [0xFEB1,0xFEB2,0xFEB3,0xFEB4], /*  SEEN  */ 
		0x0634: [0xFEB5,0xFEB6,0xFEB7,0xFEB8], /*  SHEEN  */ 
		0x0635: [0xFEB9,0xFEBA,0xFEBB,0xFEBC], /*  SAD  */ 
		0x0636: [0xFEBD,0xFEBE,0xFEBF,0xFEC0], /*  DAD  */ 
		0x0637: [0xFEC1,0xFEC2,0xFEC3,0xFEC4], /*  TAH  */ 
		0x0638: [0xFEC5,0xFEC6,0xFEC7,0xFEC8], /*  ZAH  */ 
		0x0639: [0xFEC9,0xFECA,0xFECB,0xFECC], /*  AIN  */ 
		0x063A: [0xFECD,0xFECE,0xFECF,0xFED0], /*  GHAIN  */ 
		0x063B: [0x0000,0x0000,0x0000,0x0000], /*  space */
		0x063C: [0x0000,0x0000,0x0000,0x0000], /*  space */
		0x063D: [0x0000,0x0000,0x0000,0x0000], /*  space */
		0x063E: [0x0000,0x0000,0x0000,0x0000], /*  space */
		0x063F: [0x0000,0x0000,0x0000,0x0000], /*  space */
		0x0640: [0x0640,0x0640,0x0640,0x0640], /*  TATWEEL  */ 
		0x0641: [0xFED1,0xFED2,0xFED3,0xFED4], /*  FAA  */ 
		0x0642: [0xFED5,0xFED6,0xFED7,0xFED8], /*  QAF  */ 
		0x0643: [0xFED9,0xFEDA,0xFEDB,0xFEDC], /*  KAF  */ 
		0x0644: [0xFEDD,0xFEDE,0xFEDF,0xFEE0], /*  LAM  */ 
		0x0645: [0xFEE1,0xFEE2,0xFEE3,0xFEE4], /*  MEEM  */ 
		0x0646: [0xFEE5,0xFEE6,0xFEE7,0xFEE8], /*  NOON  */ 
		0x0647: [0xFEE9,0xFEEA,0xFEEB,0xFEEC], /*  HEH  */ 
		0x0648: [0xFEED,0xFEEE,0xFEED,0xFEEE], /*  WAW  */ 
		0x0649: [0xFEEF,0xFEF0,0xFBE8,0xFBE9], /*  ALEF MAKSURA  */ 
		0x064A: [0xFEF1,0xFEF2,0xFEF3,0xFEF4], /*  YEH  */ 
		0x064B: [0xFEF5,0xFEF6,0xFEF5,0xFEF6], /*  LAM ALEF MADD*/
		0x064C: [0xFEF7,0xFEF8,0xFEF7,0xFEF8], /*  LAM ALEF HAMZA ABOVE*/
		0x064D: [0xFEF9,0xFEFa,0xFEF9,0xFEFa], /*  LAM ALEF HAMZA BELOW*/
		0x064E: [0xFEFb,0xFEFc,0xFEFb,0xFEFc], /*  LAM ALEF */
	};

	var disconnectedCharacters = [0x0621,0x0622,0x0623,0x0624,0x0625,0x0627,0x062f,0x0630,0x0631,0x0632,0x0648,0x0649,0x064b,0x064c,0x064d,0x064e];

	function IsArabicCharacter(char) {
		var code = char.charCodeAt(0);
		return (code >= arabicCharStart && code <= arabicCharEnd);
	}

	function ContainsArabicCharacters(word) {
		for (var i = 0; i < word.length; i++) {
			if (IsArabicCharacter(word[i])) {
				return true;
			}
		}
		return false;
	}

	function IsDisconnectedCharacter(char) {
		var code = char.charCodeAt(0);
		return disconnectedCharacters.indexOf(code) != -1;
	}

	function ShapeArabicCharacters(word) {
		var shapedWord = "";

		for (var i = 0; i < word.length; i++) {
			if (!IsArabicCharacter(word[i])) {
				shapedWord += word[i];
				continue;
			}

			var connectedToPreviousChar = i-1 >= 0 && IsArabicCharacter(word[i-1]) && !IsDisconnectedCharacter(word[i-1]);

			var connectedToNextChar = i+1 < word.length && IsArabicCharacter(word[i+1]) && !IsDisconnectedCharacter(word[i]);

			var form;
			if (!connectedToPreviousChar && !connectedToNextChar) {
				form = CharacterForm.Isolated;
			}
			else if (connectedToPreviousChar && !connectedToNextChar) {
				form = CharacterForm.Final;
			}
			else if (!connectedToPreviousChar && connectedToNextChar) {
				form = CharacterForm.Initial;
			}
			else if (connectedToPreviousChar && connectedToNextChar) {
				form = CharacterForm.Middle;
			}

			var code = word[i].charCodeAt(0);

			// handle lam alef special case
			if (code == 0x0644 && connectedToNextChar) {
				var nextCode = word[i+1].charCodeAt(0);
				var specialCode = null;
				if (nextCode == 0x0622) {
					// alef madd
					specialCode = glyphForms[0x064b][form];
				}
				else if (nextCode == 0x0623) {
					// hamza above
					specialCode = glyphForms[0x064c][form];
				}
				else if (nextCode == 0x0625) {
					// hamza below
					specialCode = glyphForms[0x064d][form];
				}
				else if (nextCode == 0x0627) {
					// alef
					specialCode = glyphForms[0x064e][form];
				}

				if (specialCode != null) {
					shapedWord += String.fromCharCode(specialCode);
					i++; // skip a step
					continue;
				}
			}

			// hacky?
			if (form === CharacterForm.Isolated) {
				shapedWord += word[i];
				continue;
			}

			var shapedCode = glyphForms[code][form];
			shapedWord += String.fromCharCode(shapedCode);
		}

		return shapedWord;
	}

	this.ContainsArabicCharacters = ContainsArabicCharacters;
	this.ShapeArabicCharacters = ShapeArabicCharacters;
}

/* NEW TEXT EFFECTS */
var TextEffects = new Map();

var RainbowEffect = function() { // TODO - should it be an object or just a method?
	this.DoEffect = function(char,time) {
		// console.log("RAINBOW!!!");
		// console.log(char);
		// console.log(char.color);
		// console.log(char.col);

		var h = Math.abs( Math.sin( (time / 600) - (char.col / 8) ) );
		var rgb = hslToRgb( h, 1, 0.5 );
		char.color.r = rgb[0];
		char.color.g = rgb[1];
		char.color.b = rgb[2];
		char.color.a = 255;
	}
};
TextEffects["rbw"] = new RainbowEffect();

var ColorEffect = function(index) {
	this.DoEffect = function(char) {
		var pal = getPal( curPal() );
		var color = pal[ parseInt( index ) ];
		// console.log(color);
		char.color.r = color[0];
		char.color.g = color[1];
		char.color.b = color[2];
		char.color.a = 255;
	}
};
TextEffects["clr1"] = new ColorEffect(0);
TextEffects["clr2"] = new ColorEffect(1); // TODO : should I use parameters instead of special names?
TextEffects["clr3"] = new ColorEffect(2);

var WavyEffect = function() {
	this.DoEffect = function(char,time) {
		char.offset.y += Math.sin( (time / 250) - (char.col / 2) ) * 4;
	}
};
TextEffects["wvy"] = new WavyEffect();

var ShakyEffect = function() {
	function disturb(func,time,offset,mult1,mult2) {
		return func( (time * mult1) - (offset * mult2) );
	}

	this.DoEffect = function(char,time) {
		char.offset.y += 3
						* disturb(Math.sin,time,char.col,0.1,0.5)
						* disturb(Math.cos,time,char.col,0.3,0.2)
						* disturb(Math.sin,time,char.row,2.0,1.0);
		char.offset.x += 3
						* disturb(Math.cos,time,char.row,0.1,1.0)
						* disturb(Math.sin,time,char.col,3.0,0.7)
						* disturb(Math.cos,time,char.col,0.2,0.3);
	}
};
TextEffects["shk"] = new ShakyEffect();

} // Dialog()
</script>

<script>
/*
TODO
- reset renderer function
- react to changes in: drawings, palettes
- possible future plan: limit size of cache (remove old images)
- change image store path from (pal > col > draw) to (draw > pal > col)
- get rid of old getSpriteImage (etc) methods
- get editor working again [in progress]
- move debug timer class into core (seems useful)
*/

function Renderer(tilesize, scale) {

console.log("!!!!! NEW RENDERER");

var imageStore = { // TODO : rename to imageCache
	source: {},
	render: {}
};

var palettes = null; // TODO : need null checks?
var context = null;

function setPalettes(paletteObj) {
	palettes = paletteObj;

	// TODO : should this really clear out the render cache?
	imageStore.render = {};
}

function getPaletteColor(paletteId, colorIndex) {
	var palette = palettes[paletteId];

	if (colorIndex > palette.colors.length) { // do I need this failure case? (seems un-reliable)
		colorIndex = 0;
	}

	var color = palette.colors[colorIndex];

	return {
		r : color[0],
		g : color[1],
		b : color[2]
	};
}

var debugRenderCount = 0;

// TODO : change image store path from (pal > col > draw) to (draw > pal > col)
function renderImage(drawing, paletteId) {
	// debugRenderCount++;
	// console.log("RENDER COUNT " + debugRenderCount);

	var col = drawing.col;
	var colStr = "" + col;
	var pal = paletteId;
	var drwId = drawing.drw;
	var imgSrc = imageStore.source[ drawing.drw ];

	// initialize render cache entry
	if (imageStore.render[drwId] === undefined || imageStore.render[drwId] === null) {
		imageStore.render[drwId] = {};
	}

	if (imageStore.render[drwId][pal] === undefined || imageStore.render[drwId][pal] === null) {
		imageStore.render[drwId][pal] = {};
	}

	// create array of ImageData frames
	imageStore.render[drwId][pal][colStr] = [];

	for (var i = 0; i < imgSrc.length; i++) {
		var frameSrc = imgSrc[i];
		var frameData = imageDataFromImageSource( frameSrc, pal, col );
		imageStore.render[drwId][pal][colStr].push(frameData);
	}
}

function imageDataFromImageSource(imageSource, pal, col) {
	//console.log(imageSource);

	var img = context.createImageData(tilesize*scale,tilesize*scale);

	var backgroundColor = getPaletteColor(pal,0);
	var foregroundColor = getPaletteColor(pal,col);

	for (var y = 0; y < tilesize; y++) {
		for (var x = 0; x < tilesize; x++) {
			var px = imageSource[y][x];
			for (var sy = 0; sy < scale; sy++) {
				for (var sx = 0; sx < scale; sx++) {
					var pxl = (((y * scale) + sy) * tilesize * scale * 4) + (((x*scale) + sx) * 4);
					if ( px === 1 ) {
						img.data[pxl + 0] = foregroundColor.r;
						img.data[pxl + 1] = foregroundColor.g;
						img.data[pxl + 2] = foregroundColor.b;
						img.data[pxl + 3] = 255;
					}
					else { //ch === 0
						img.data[pxl + 0] = backgroundColor.r;
						img.data[pxl + 1] = backgroundColor.g;
						img.data[pxl + 2] = backgroundColor.b;
						img.data[pxl + 3] = 255;
					}
				}
			}
		}
	}

	return img;
}

// TODO : move into core
function undefinedOrNull(x) {
	return x === undefined || x === null;
}

function isImageRendered(drawing, paletteId) {
	var col = drawing.col;
	var colStr = "" + col;
	var pal = paletteId;
	var drwId = drawing.drw;

	if (undefinedOrNull(imageStore.render[drwId]) ||
		undefinedOrNull(imageStore.render[drwId][pal]) ||
		undefinedOrNull(imageStore.render[drwId][pal][colStr])) {
			return false;
	}
	else {
		return true;
	}
}

function getImageSet(drawing, paletteId) {
	return imageStore.render[drawing.drw][paletteId][drawing.col];
}

function getImageFrame(drawing, paletteId, frameOverride) {
	var frameIndex = 0;
	if (drawing.animation.isAnimated) {
		if (frameOverride != undefined && frameOverride != null) {
			frameIndex = frameOverride;
		}
		else {
			frameIndex = drawing.animation.frameIndex;
		}
	}

	return getImageSet(drawing, paletteId)[frameIndex];
}

function getOrRenderImage(drawing, paletteId, frameOverride) {
	if (!isImageRendered(drawing, paletteId)) {
		renderImage(drawing, paletteId);
	}

	return getImageFrame(drawing, paletteId, frameOverride);
}

/* PUBLIC INTERFACE */
this.GetImage = getOrRenderImage;

this.SetPalettes = setPalettes;

this.SetImageSource = function(drawingId, imageSourceData) {
	imageStore.source[drawingId] = imageSourceData;
	imageStore.render[drawingId] = {}; // reset render cache for this image
}

this.GetImageSource = function(drawingId) {
	return imageStore.source[drawingId];
}

this.GetFrameCount = function(drawingId) {
	return imageStore.source[drawingId].length;
}

this.AttachContext = function(ctx) {
	context = ctx;
}

} // Renderer()
</script>

<script>
var xhr; // TODO : remove
var canvas;
var context; // TODO : remove if safe?
var ctx;

var title = "";
var room = {};
var tile = {};
var sprite = {};
var item = {};
var dialog = {};
var palette = {
	"0" : [[0,0,0],[255,0,0],[255,255,255]] //start off with a default palette (can be overriden)
};
var ending = {};
var variable = {}; // these are starting variable values -- they don't update (or I don't think they will)
var playerId = "A";

var defaultFontName = "ascii_small";
var fontName = defaultFontName;
var TextDirection = {
	LeftToRight : "LTR",
	RightToLeft : "RTL"
};
var textDirection = TextDirection.LeftToRight;

var names = {
	room : new Map(),
	tile : new Map(), // Note: Not currently enabled in the UI
	sprite : new Map(),
	item : new Map(),
	/*dialog : new Map()*/ // TODO
	/*ending : new Map()*/ // TODO
};
function updateNamesFromCurData() {
	names.room = new Map();
	for(id in room) {
		if(room[id].name != undefined && room[id].name != null) {
			names.room.set( room[id].name, id );
		}
	}
	names.tile = new Map();
	for(id in tile) {
		if(tile[id].name != undefined && tile[id].name != null) {
			names.tile.set( tile[id].name, id );
		}
	}
	names.sprite = new Map();
	for(id in sprite) {
		if(sprite[id].name != undefined && sprite[id].name != null) {
			names.sprite.set( sprite[id].name, id );
		}
	}
	names.item = new Map();
	for(id in item) {
		if(item[id].name != undefined && item[id].name != null) {
			names.item.set( item[id].name, id );
		}
	}
}

var spriteStartLocations = {};

/* VERSION */
var version = {
	major: 6, // major changes
	minor: 0 // smaller changes
};
function getEngineVersion() {
	return version.major + "." + version.minor;
}

/* FLAGS */
var flags;
function resetFlags() {
	flags = {
		ROOM_FORMAT : 0 // 0 = non-comma separated, 1 = comma separated
	};
}
resetFlags(); //init flags on load script

// SUPER hacky location... :/
var editorDevFlags = {
	// NONE right now!
};

function clearGameData() {
	title = "";
	room = {};
	tile = {};
	sprite = {};
	item = {};
	dialog = {};
	palette = { //start off with a default palette (can be overriden)
		"0" : {
			name : null,
			colors : [[0,0,0],[255,0,0],[255,255,255]]
		}
	};
	ending = {};
	isEnding = false; //todo - correct place for this?
	variable = {};

	// TODO RENDERER : clear data?

	spriteStartLocations = {};

	names = {
		room : new Map(),
		tile : new Map(),
		sprite : new Map(),
		item : new Map()
	};

	fontName = defaultFontName; // TODO : reset font manager too?
	textDirection = TextDirection.LeftToRight;
}

var width = 128;
var height = 128;
var scale = 4; //this is stupid but necessary
var tilesize = 8;
var mapsize = 16;

var curRoom = "0";

var key = {
	left : 37,
	right : 39,
	up : 38,
	down : 40,
	space : 32,
	enter : 13,
	w : 87,
	a : 65,
	s : 83,
	d : 68,
	r : 82,
	shift : 16,
	ctrl : 17,
	alt : 18,
	cmd : 224
};

var prevTime = 0;
var deltaTime = 0;

//methods used to trigger gif recording
var didPlayerMoveThisFrame = false;
var onPlayerMoved = null;
// var didDialogUpdateThisFrame = false;
var onDialogUpdate = null;

//inventory update UI handles
var onInventoryChanged = null;
var onVariableChanged = null;

var isPlayerEmbeddedInEditor = false;

var renderer = new Renderer(tilesize, scale);

function getGameNameFromURL() {
	var game = window.location.hash.substring(1);
	// console.log("game name --- " + game);
	return game;
}

function attachCanvas(c) {
	canvas = c;
	canvas.width = width * scale;
	canvas.height = width * scale;
	ctx = canvas.getContext("2d");
	dialogRenderer.AttachContext(ctx);
	renderer.AttachContext(ctx);
}

var curGameData = null;
function load_game(game_data, startWithTitle) {
	curGameData = game_data; //remember the current game (used to reset the game)

	dialogBuffer.Reset();
	scriptInterpreter.ResetEnvironment(); // ensures variables are reset -- is this the best way?

	parseWorld(game_data);

	if (!isPlayerEmbeddedInEditor) {
		// hack to ensure default font is available
		fontManager.AddResource(defaultFontName + fontManager.GetExtension(), document.getElementById(defaultFontName).text.slice(1));
	}

	var font = fontManager.Get( fontName );
	dialogBuffer.SetFont(font);
	dialogRenderer.SetFont(font);

	setInitialVariables();

	// setInterval(updateLoadingScreen, 300); // hack test

	onready(startWithTitle);
}

function reset_cur_game() {
	if (curGameData == null) return; //can't reset if we don't have the game data
	stopGame();
	clearGameData();
	load_game(curGameData);
}

var update_interval = null;
function onready(startWithTitle) {
	if(startWithTitle === undefined || startWithTitle === null) startWithTitle = true;

	clearInterval(loading_interval);

	input = new InputManager();

	document.addEventListener('keydown', input.onkeydown);
	document.addEventListener('keyup', input.onkeyup);

	if (isPlayerEmbeddedInEditor) {
		canvas.addEventListener('touchstart', input.ontouchstart);
		canvas.addEventListener('touchmove', input.ontouchmove);
		canvas.addEventListener('touchend', input.ontouchend);
	}
	else {
		document.addEventListener('touchstart', input.ontouchstart);
		document.addEventListener('touchmove', input.ontouchmove);
		document.addEventListener('touchend', input.ontouchend);
	}

	window.onblur = input.onblur;

	update_interval = setInterval(update,-1);

	console.log("TITLE ??? " + startWithTitle);
	if(startWithTitle) // used by editor
		startNarrating(title);
}

function setInitialVariables() {
	for(id in variable) {
		var value = variable[id]; // default to string
		if(value === "true") {
			value = true;
		}
		else if(value === "false") {
			value = false;
		}
		else if(!isNaN(parseFloat(value))) {
			value = parseFloat(value);
		}
		scriptInterpreter.SetVariable(id,value);
	}
	scriptInterpreter.SetOnVariableChangeHandler( onVariableChanged );
}

// TODO: this is likely broken
function breadthFirstSearch(map, from, to) {
	from.trail = [];
	var visited = [];
	var queue = [from];
	visited.push( posToString(from) );

	//console.log( "~ bfs ~");
	//console.log( posToString(from) + " to " + posToString(to) );

	while ( queue.length > 0 ) {

		//grab pos from queue and mark as visited
		var curPos = queue.shift();

		//console.log( posToString(curPos) );
		//console.log( ".. " + pathToString(curPos.trail) );
		//console.log( visited );

		if (curPos.x == to.x && curPos.y == to.y) {
			//found a path!
			var path = curPos.trail.splice(0);
			path.push( curPos );
			return path;
		}

		//look at neighbors
		neighbors(curPos).forEach( function(n) {
			var inBounds = (n.x >= 0 && n.x < 16 && n.y >= 0 && n.y < 16);
			if (inBounds) {
				var noCollision = map[n.y][n.x] <= 0;
				var notVisited = visited.indexOf( posToString(n) ) == -1;
				if (noCollision && notVisited) {
					n.trail = curPos.trail.slice();
					n.trail.push(curPos);
					queue.push( n );
					visited.push( posToString(n) );
				}
			}
		});

	}

	return []; // no path found
}

function posToString(pos) {
	return pos.x + "," + pos.y;
}

function pathToString(path) {
	var s = "";
	for (i in path) {
		s += posToString(path[i]) + " ";
	}
	return s;
}

function neighbors(pos) {
	var neighborList = [];
	neighborList.push( {x:pos.x+1, y:pos.y+0} );
	neighborList.push( {x:pos.x-1, y:pos.y+0} );
	neighborList.push( {x:pos.x+0, y:pos.y+1} );
	neighborList.push( {x:pos.x+0, y:pos.y-1} );
	return neighborList;
}

function collisionMap(roomId) {
	var map = [
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
	];

	for (r in room[roomId].tilemap) {
		var row = room[roomId].tilemap[r];
		for (var c = 0; c < row.length; c++) {
			if (room[roomId].walls.indexOf( row[x] ) != -1) {
				map[r][c] = 1;
			}
		}
	}

	for (id in sprite) {
		var spr = sprite[id];
		if (spr.room === roomId) {
			map[spr.y][spr.x] = 2;
		}
	}

	return map;
}

function getOffset(evt) {
	var offset = { x:0, y:0 };

	var el = evt.target;
	var rect = el.getBoundingClientRect();

	offset.x += rect.left + el.scrollLeft;
	offset.y += rect.top + el.scrollTop;

	offset.x = evt.clientX - offset.x;
	offset.y = evt.clientY - offset.y;

	return offset;
}

function stopGame() {
	console.log("stop GAME!");

	document.removeEventListener('keydown', input.onkeydown);
	document.removeEventListener('keyup', input.onkeyup);

	if (isPlayerEmbeddedInEditor) {
		canvas.removeEventListener('touchstart', input.ontouchstart);
		canvas.removeEventListener('touchmove', input.ontouchmove);
		canvas.removeEventListener('touchend', input.ontouchend);
	}
	else {
		document.removeEventListener('touchstart', input.ontouchstart);
		document.removeEventListener('touchmove', input.ontouchmove);
		document.removeEventListener('touchend', input.ontouchend);
	}

	window.onblur = null;

	clearInterval(update_interval);
}

/* loading animation */
var loading_anim_data = [
	[
		0,1,1,1,1,1,1,0,
		0,0,1,1,1,1,0,0,
		0,0,1,1,1,1,0,0,
		0,0,0,1,1,0,0,0,
		0,0,0,1,1,0,0,0,
		0,0,1,0,0,1,0,0,
		0,0,1,0,0,1,0,0,
		0,1,1,1,1,1,1,0,
	],
	[
		0,1,1,1,1,1,1,0,
		0,0,1,0,0,1,0,0,
		0,0,1,1,1,1,0,0,
		0,0,0,1,1,0,0,0,
		0,0,0,1,1,0,0,0,
		0,0,1,0,0,1,0,0,
		0,0,1,1,1,1,0,0,
		0,1,1,1,1,1,1,0,
	],
	[
		0,1,1,1,1,1,1,0,
		0,0,1,0,0,1,0,0,
		0,0,1,0,0,1,0,0,
		0,0,0,1,1,0,0,0,
		0,0,0,1,1,0,0,0,
		0,0,1,1,1,1,0,0,
		0,0,1,1,1,1,0,0,
		0,1,1,1,1,1,1,0,
	],
	[
		0,1,1,1,1,1,1,0,
		0,0,1,0,0,1,0,0,
		0,0,1,0,0,1,0,0,
		0,0,0,1,1,0,0,0,
		0,0,0,1,1,0,0,0,
		0,0,1,1,1,1,0,0,
		0,0,1,1,1,1,0,0,
		0,1,1,1,1,1,1,0,
	],
	[
		0,0,0,0,0,0,0,0,
		1,0,0,0,0,0,0,1,
		1,1,1,0,0,1,1,1,
		1,1,1,1,1,0,0,1,
		1,1,1,1,1,0,0,1,
		1,1,1,0,0,1,1,1,
		1,0,0,0,0,0,0,1,
		0,0,0,0,0,0,0,0,
	]
];
var loading_anim_frame = 0;
var loading_anim_speed = 500;
var loading_interval = null;

function loadingAnimation() {
	//create image
	var loadingAnimImg = ctx.createImageData(8*scale, 8*scale);
	//draw image
	for (var y = 0; y < 8; y++) {
		for (var x = 0; x < 8; x++) {
			var i = (y * 8) + x;
			if (loading_anim_data[loading_anim_frame][i] == 1) {
				//scaling nonsense
				for (var sy = 0; sy < scale; sy++) {
					for (var sx = 0; sx < scale; sx++) {
						var pxl = 4 * ( (((y*scale)+sy) * (8*scale)) + ((x*scale)+sx) );
						loadingAnimImg.data[pxl+0] = 255;
						loadingAnimImg.data[pxl+1] = 255;
						loadingAnimImg.data[pxl+2] = 255;
						loadingAnimImg.data[pxl+3] = 255;
					}
				}
			}
		}
	}
	//put image on canvas
	ctx.putImageData(loadingAnimImg,scale*(width/2 - 4),scale*(height/2 - 4));
	//update frame
	loading_anim_frame++;
	if (loading_anim_frame >= 5) loading_anim_frame = 0;
}

function updateLoadingScreen() {
	// TODO : in progress
	ctx.fillStyle = "rgb(0,0,0)";
	ctx.fillRect(0,0,canvas.width,canvas.height);

	loadingAnimation();
	drawSprite( getSpriteImage(sprite["a"],"0",0), 8, 8, ctx );
}

function update() {
	var curTime = Date.now();
	deltaTime = curTime - prevTime;

	if (!transition.IsTransitionActive()) {
		updateInput();
	}

	if (transition.IsTransitionActive()) {
		// transition animation takes over everything!
		transition.UpdateTransition(deltaTime);
	}
	else {
		if (!isNarrating && !isEnding) {
			updateAnimation();
			drawRoom( room[curRoom] ); // draw world if game has begun
		}
		else {
			//make sure to still clear screen
			ctx.fillStyle = "rgb(" + getPal(curPal())[0][0] + "," + getPal(curPal())[0][1] + "," + getPal(curPal())[0][2] + ")";
			ctx.fillRect(0,0,canvas.width,canvas.height);
		}

		// if (isDialogMode) { // dialog mode
		if(dialogBuffer.IsActive()) {
			dialogRenderer.Draw( dialogBuffer, deltaTime );
			dialogBuffer.Update( deltaTime );
		}
		else if (!isEnding) {
			moveSprites(); // TODO : I probably need to remove this..
		}

		// keep moving avatar if player holds down button
		if( !dialogBuffer.IsActive() && !isEnding )
		{
			if( curPlayerDirection != Direction.None ) {
				playerHoldToMoveTimer -= deltaTime;

				if( playerHoldToMoveTimer <= 0 )
				{
					movePlayer( curPlayerDirection );
					playerHoldToMoveTimer = 150;
				}
			}
		}
	}

	prevTime = curTime;

	//for gif recording
	if (didPlayerMoveThisFrame && onPlayerMoved != null) {
		onPlayerMoved();
	}
	didPlayerMoveThisFrame = false;

	/* hacky replacement */
	if (onDialogUpdate != null) {
		dialogRenderer.SetPageFinishHandler( onDialogUpdate );
	}

	input.resetKeyPressed();
	input.resetTapReleased();
}

function updateInput() {
	if( dialogBuffer.IsActive() ) {
		if (input.anyKeyPressed() || input.isTapReleased()) {
			/* CONTINUE DIALOG */
			if (dialogBuffer.CanContinue()) {
				var hasMoreDialog = dialogBuffer.Continue();
				if(!hasMoreDialog) {
					// ignore currently held keys UNTIL they are released (stops player from insta-moving)
					input.ignoreHeldKeys();
				}
			}
			else {
				dialogBuffer.Skip();
			}
		}
	}
	else if ( isEnding ) {
		if (input.anyKeyPressed() || input.isTapReleased()) {
			/* RESTART GAME */
			reset_cur_game();
		}
	}
	else {
		/* WALK */
		var prevPlayerDirection = curPlayerDirection;

		if ( input.isKeyDown( key.left ) || input.isKeyDown( key.a ) || input.swipeLeft() ) {
			curPlayerDirection = Direction.Left;
		}
		else if ( input.isKeyDown( key.right ) || input.isKeyDown( key.d ) || input.swipeRight() ) {
			curPlayerDirection = Direction.Right;
		}
		else if ( input.isKeyDown( key.up ) || input.isKeyDown( key.w ) || input.swipeUp() ) {
			curPlayerDirection = Direction.Up;
		}
		else if ( input.isKeyDown( key.down ) || input.isKeyDown( key.s ) || input.swipeDown() ) {
			curPlayerDirection = Direction.Down;
		}
		else {
			curPlayerDirection = Direction.None;
		}

		if (curPlayerDirection != Direction.None && curPlayerDirection != prevPlayerDirection) {
			movePlayer( curPlayerDirection );
			playerHoldToMoveTimer = 500;
		}
	}
}

var animationCounter = 0;
var animationTime = 400;
function updateAnimation() {
	animationCounter += deltaTime;

	if ( animationCounter >= animationTime ) {

		// animate sprites
		for (id in sprite) {
			var spr = sprite[id];
			if (spr.animation.isAnimated) {
				spr.animation.frameIndex = ( spr.animation.frameIndex + 1 ) % spr.animation.frameCount;
			}
		}

		// animate tiles
		for (id in tile) {
			var til = tile[id];
			if (til.animation.isAnimated) {
				til.animation.frameIndex = ( til.animation.frameIndex + 1 ) % til.animation.frameCount;
			}
		}

		// animate items
		for (id in item) {
			var itm = item[id];
			if (itm.animation.isAnimated) {
				itm.animation.frameIndex = ( itm.animation.frameIndex + 1 ) % itm.animation.frameCount;
			}
		}

		// reset counter
		animationCounter = 0;

	}
}

var moveCounter = 0;
var moveTime = 200;
function moveSprites() {
	moveCounter += deltaTime;

	if (moveCounter >= moveTime) {

		for (id in sprite) {
			var spr = sprite[id];
			if (spr.walkingPath.length > 0) {
				//move sprite
				var nextPos = spr.walkingPath.shift();
				spr.x = nextPos.x;
				spr.y = nextPos.y;


				var end = getEnding( spr.room, spr.x, spr.y );
				var ext = getExit( spr.room, spr.x, spr.y );
				var itmIndex = getItemIndex( spr.room, spr.x, spr.y );
				if (end) { //if the sprite hits an ending
					if (id === playerId) { // only the player can end the game
						startNarrating( ending[end.id], true /*isEnding*/ );
					}
				}
				else if (ext) { //if the sprite hits an exit
					//move it to another scene
					spr.room = ext.dest.room;
					spr.x = ext.dest.x;
					spr.y = ext.dest.y;
					if (id === playerId) {
						//if the player changes scenes, change the visible scene
						curRoom = ext.dest.room;
					}
				}
				else if(itmIndex > -1) {
					var itm = room[ spr.room ].items[ itmIndex ];
					room[ spr.room ].items.splice( itmIndex, 1 );
					if( spr.inventory[ itm.id ] )
						spr.inventory[ itm.id ] += 1;
					else
						spr.inventory[ itm.id ] = 1;

					if(onInventoryChanged != null)
						onInventoryChanged( itm.id );

					if(id === playerId)
						startItemDialog( itm.id  /*itemId*/ );

					// stop moving : is this a good idea?
					spr.walkingPath = [];
				}

				if (id === playerId) didPlayerMoveThisFrame = true;
			}
		}

		moveCounter = 0;
	}

}

function getSpriteAt(x,y) {
	for (id in sprite) {
		var spr = sprite[id];
		if (spr.room === curRoom) {
			if (spr.x == x && spr.y == y) {
				return id;
			}
		}
	}
	return null;
}

var Direction = {
	None : -1,
	Up : 0,
	Down : 1,
	Left : 2,
	Right : 3
};

var curPlayerDirection = Direction.None;
var playerHoldToMoveTimer = 0;

var InputManager = function() {
	var self = this;

	var pressed;
	var ignored;
	var newKeyPress;
	var touchState;

	function resetAll() {
		pressed = {};
		ignored = {};
		newKeyPress = false;

		touchState = {
			isDown : false,
			startX : 0,
			startY : 0,
			curX : 0,
			curY : 0,
			swipeDistance : 30,
			swipeDirection : Direction.None,
			tapReleased : false
		};
	}
	resetAll();

	function stopWindowScrolling(e) {
		if(e.keyCode == key.left || e.keyCode == key.right || e.keyCode == key.up || e.keyCode == key.down || !isPlayerEmbeddedInEditor)
			e.preventDefault();
	}

	function tryRestartGame(e) {
		/* RESTART GAME */
		if ( e.keyCode === key.r && ( e.getModifierState("Control") || e.getModifierState("Meta") ) ) {
			if ( confirm("Restart the game?") ) {
				reset_cur_game();
			}
		}
	}

	function eventIsModifier(event) {
		return (event.keyCode == key.shift || event.keyCode == key.ctrl || event.keyCode == key.alt || event.keyCode == key.cmd);
	}

	function isModifierKeyDown() {
		return ( self.isKeyDown(key.shift) || self.isKeyDown(key.ctrl) || self.isKeyDown(key.alt) || self.isKeyDown(key.cmd) );
	}

	this.ignoreHeldKeys = function() {
		for (var key in pressed) {
			if (pressed[key]) { // only ignore keys that are actually held
				ignored[key] = true;
				// console.log("IGNORE -- " + key);
			}
		}
	}

	this.onkeydown = function(event) {
		// console.log("KEYDOWN -- " + event.keyCode);

		stopWindowScrolling(event);

		tryRestartGame(event);

		// Special keys being held down can interfere with keyup events and lock movement
		// so just don't collect input when they're held
		{
			if (isModifierKeyDown()) {
				return;
			}

			if (eventIsModifier(event)) {
				resetAll();
			}
		}

		if (ignored[event.keyCode]) {
			return;
		}

		if (!self.isKeyDown(event.keyCode)) {
			newKeyPress = true;
		}

		pressed[event.keyCode] = true;
		ignored[event.keyCode] = false;
	}

	this.onkeyup = function(event) {
		// console.log("KEYUP -- " + event.keyCode);
		pressed[event.keyCode] = false;
		ignored[event.keyCode] = false;
	}

	this.ontouchstart = function(event) {
		event.preventDefault();

		if( event.changedTouches.length > 0 ) {
			touchState.isDown = true;

			touchState.startX = touchState.curX = event.changedTouches[0].clientX;
			touchState.startY = touchState.curY = event.changedTouches[0].clientY;

			touchState.swipeDirection = Direction.None;
		}
	}

	this.ontouchmove = function(event) {
		event.preventDefault();

		if( touchState.isDown && event.changedTouches.length > 0 ) {
			touchState.curX = event.changedTouches[0].clientX;
			touchState.curY = event.changedTouches[0].clientY;

			var prevDirection = touchState.swipeDirection;

			if( touchState.curX - touchState.startX <= -touchState.swipeDistance ) {
				touchState.swipeDirection = Direction.Left;
			}
			else if( touchState.curX - touchState.startX >= touchState.swipeDistance ) {
				touchState.swipeDirection = Direction.Right;
			}
			else if( touchState.curY - touchState.startY <= -touchState.swipeDistance ) {
				touchState.swipeDirection = Direction.Up;
			}
			else if( touchState.curY - touchState.startY >= touchState.swipeDistance ) {
				touchState.swipeDirection = Direction.Down;
			}

			if( touchState.swipeDirection != prevDirection ) {
				// reset center so changing directions is easier
				touchState.startX = touchState.curX;
				touchState.startY = touchState.curY;
			}
		}
	}

	this.ontouchend = function(event) {
		event.preventDefault();

		touchState.isDown = false;

		if( touchState.swipeDirection == Direction.None ) {
			// tap!
			touchState.tapReleased = true;
		}

		touchState.swipeDirection = Direction.None;
	}

	this.isKeyDown = function(keyCode) {
		return pressed[keyCode] != null && pressed[keyCode] == true && (ignored[keyCode] == null || ignored[keyCode] == false);
	}

	this.anyKeyPressed = function() {
		return newKeyPress;
	}

	this.resetKeyPressed = function() {
		newKeyPress = false;
	}

	this.swipeLeft = function() {
		return touchState.swipeDirection == Direction.Left;
	}

	this.swipeRight = function() {
		return touchState.swipeDirection == Direction.Right;
	}

	this.swipeUp = function() {
		return touchState.swipeDirection == Direction.Up;
	}

	this.swipeDown = function() {
		return touchState.swipeDirection == Direction.Down;
	}

	this.isTapReleased = function() {
		return touchState.tapReleased;
	}

	this.resetTapReleased = function() {
		touchState.tapReleased = false;
	}

	this.onblur = function() {
		// console.log("~~~ BLUR ~~");
		resetAll();
	}
}
var input = null;

function movePlayer(direction) {
	var spr = null;

	if ( curPlayerDirection == Direction.Left && !(spr = getSpriteLeft()) && !isWallLeft()) {
		player().x -= 1;
		didPlayerMoveThisFrame = true;
	}
	else if ( curPlayerDirection == Direction.Right && !(spr = getSpriteRight()) && !isWallRight()) {
		player().x += 1;
		didPlayerMoveThisFrame = true;
	}
	else if ( curPlayerDirection == Direction.Up && !(spr = getSpriteUp()) && !isWallUp()) {
		player().y -= 1;
		didPlayerMoveThisFrame = true;
	}
	else if ( curPlayerDirection == Direction.Down && !(spr = getSpriteDown()) && !isWallDown()) {
		player().y += 1;
		didPlayerMoveThisFrame = true;
	}
	
	var ext = getExit( player().room, player().x, player().y );
	var end = getEnding( player().room, player().x, player().y );
	// TODO : vNext
	// var eff = getEffect( player().room, player().x, player().y );
	var itmIndex = getItemIndex( player().room, player().x, player().y );

	// do items first, because you can pick up an item AND go through a door
	if (itmIndex > -1) {
		// TODO pick up items (what about touch?)
		// console.log("HIT ITM ");
		// console.log( itmIndex );
		var itm = room[ player().room ].items[ itmIndex ];
		// console.log(itm);
		room[ player().room ].items.splice( itmIndex, 1 );
		if( player().inventory[ itm.id ] )
			player().inventory[ itm.id ] += 1;
		else
			player().inventory[ itm.id ] = 1;

		if(onInventoryChanged != null)
			onInventoryChanged( itm.id );

		startItemDialog( itm.id  /*itemId*/ );

		// console.log( player().inventory );
	}

	if (end) {
		startNarrating( ending[end.id], true /*isEnding*/ );
	}
	else if (ext) {
		movePlayerThroughExit(ext);
	}
	// TODO : vNext
	// else if (eff) {
	// 	startDialog( script[eff.id].source, eff.id );
	// }
	else if (spr) {
		startSpriteDialog( spr /*spriteId*/ );
	}
}

var transition = new TransitionManager();

function movePlayerThroughExit(ext) {
	var GoToDest = function() {
		if (ext.transition_effect != null) {
			transition.BeginTransition(player().room, player().x, player().y, ext.dest.room, ext.dest.x, ext.dest.y, ext.transition_effect);
			transition.UpdateTransition(0);
		}

		player().room = ext.dest.room;
		player().x = ext.dest.x;
		player().y = ext.dest.y;
		curRoom = ext.dest.room;
	};

	// TODO : vNext
	// if(ext.script_id != null && script[ext.script_id]){
	// 	var scriptSourceStr = script[ext.script_id].source;
	// 	startDialog(scriptSourceStr, ext.script_id, function(isExitUnlocked) {
	// 		if (isExitUnlocked == true) {
	// 			GoToDest();
	// 		}
	// 	});
	// }
	// else {
	// 	GoToDest();
	// }

	GoToDest();
}

function getItemIndex( roomId, x, y ) {
	for( var i = 0; i < room[roomId].items.length; i++ ) {
		var itm = room[roomId].items[i];
		if ( itm.x == x && itm.y == y)
			return i;
	}
	return -1;
}

function getSpriteLeft() { //repetitive?
	return getSpriteAt( player().x - 1, player().y );
}

function getSpriteRight() {
	return getSpriteAt( player().x + 1, player().y );
}

function getSpriteUp() {
	return getSpriteAt( player().x, player().y - 1 );
}

function getSpriteDown() {
	return getSpriteAt( player().x, player().y + 1 );
}

function isWallLeft() {
	return (player().x - 1 < 0) || isWall( player().x - 1, player().y );
}

function isWallRight() {
	return (player().x + 1 >= 16) || isWall( player().x + 1, player().y );
}

function isWallUp() {
	return (player().y - 1 < 0) || isWall( player().x, player().y - 1 );
}

function isWallDown() {
	return (player().y + 1 >= 16) || isWall( player().x, player().y + 1 );
}

function isWall(x,y,roomId) {
	if(roomId == undefined || roomId == null)
		roomId = curRoom;

	var tileId = getTile( x, y );

	if( tileId === '0' )
		return false; // Blank spaces aren't walls, ya doofus

	if( tile[tileId].isWall === undefined || tile[tileId].isWall === null ) {
		// No wall-state defined: check room-specific walls
		var i = room[roomId].walls.indexOf( getTile(x,y) );
		return i > -1;
	}

	// Otherwise, use the tile's own wall-state
	return tile[tileId].isWall;
}

function getItem(roomId,x,y) {
	for (i in room[roomId].items) {
		var item = room[roomId].items[i];
		if (x == item.x && y == item.y) {
			return item;
		}
	}
	return null;
}

function getExit(roomId,x,y) {
	for (i in room[roomId].exits) {
		var e = room[roomId].exits[i];
		if (x == e.x && y == e.y) {
			return e;
		}
	}
	return null;
}

function getEnding(roomId,x,y) {
	for (i in room[roomId].endings) {
		var e = room[roomId].endings[i];
		if (x == e.x && y == e.y) {
			return e;
		}
	}
	return null;
}

// TODO : vNext
// function getEffect(roomId,x,y) {
// 	for (i in room[roomId].effects) {
// 		var e = room[roomId].effects[i];
// 		if (x == e.x && y == e.y) {
// 			return e;
// 		}
// 	}
// 	return null;
// }

function getTile(x,y) {
	// console.log(x + " " + y);
	var t = getRoom().tilemap[y][x];
	return t;
}

function player() {
	return sprite[playerId];
}

// Sort of a hack for legacy palette code (when it was just an array)
function getPal(id) {
	return palette[ id ].colors;
}

function getRoom() {
	return room[curRoom];
}

function isSpriteOffstage(id) {
	return sprite[id].room == null;
}

function parseWorld(file) {
	// console.log("~~~ PARSE WORLD ~~~");
	// console.log(file);

	// var parseTimer = new Timer();

	resetFlags();

	var versionNumber = 0;

	var lines = file.split("\n");
	var i = 0;
	while (i < lines.length) {
		var curLine = lines[i];

		// console.log(lines[i]);

		if (i == 0) {
			i = parseTitle(lines, i);
		}
		else if (curLine.length <= 0 || curLine.charAt(0) === "#") {
			// collect version number (from a comment.. hacky I know)
			if (curLine.indexOf("# BITSY VERSION ") != -1) {
				versionNumber = parseFloat(curLine.replace("# BITSY VERSION ", ""));
			}

			//skip blank lines & comments
			i++;
		}
		else if (getType(curLine) == "PAL") {
			i = parsePalette(lines, i);
		}
		else if (getType(curLine) === "ROOM" || getType(curLine) === "SET") { //SET for back compat
			i = parseRoom(lines, i);
		}
		else if (getType(curLine) === "TIL") {
			i = parseTile(lines, i);
		}
		else if (getType(curLine) === "SPR") {
			i = parseSprite(lines, i);
		}
		else if (getType(curLine) === "ITM") {
			i = parseItem(lines, i);
		}
		else if (getType(curLine) === "DRW") {
			i = parseDrawing(lines, i);
		}
		else if (getType(curLine) === "DLG") {
			i = parseDialog(lines, i);
		}
		else if (getType(curLine) === "END") {
			i = parseEnding(lines, i);
		}
		// TODO: vNext
		// else if (getType(curLine) === "PRG") {
		// 	i = parseScript(lines, i);
		// }
		else if (getType(curLine) === "VAR") {
			i = parseVariable(lines, i);
		}
		else if (getType(curLine) === "DEFAULT_FONT") {
			i = parseFontName(lines, i);
		}
		else if (getType(curLine) === "TEXT_DIRECTION") {
			i = parseTextDirection(lines, i);
		}
		else if (getType(curLine) === "FONT") {
			i = parseFontData(lines, i);
		}
		else if (getType(curLine) === "!") {
			i = parseFlag(lines, i);
		}
		else {
			i++;
		}
	}
	placeSprites();
	if (player().room != null) {
		curRoom = player().room;
	}

	renderer.SetPalettes(palette);

	// console.log(names);

	// console.log("~~~~~ PARSE TIME " + parseTimer.Milliseconds());

	return versionNumber;
}

//TODO this is in progress and doesn't support all features
function serializeWorld(skipFonts) {
	if (skipFonts === undefined || skipFonts === null)
		skipFonts = false;

	var worldStr = "";
	/* TITLE */
	worldStr += title + "\n";
	worldStr += "\n";
	/* VERSION */
	worldStr += "# BITSY VERSION " + getEngineVersion() + "\n"; // add version as a comment for debugging purposes
	worldStr += "\n";
	/* FLAGS */
	for (f in flags) {
		worldStr += "! " + f + " " + flags[f] + "\n";
	}
	worldStr += "\n"
	/* FONT */
	if (fontName != defaultFontName) {
		worldStr += "DEFAULT_FONT " + fontName + "\n";
		worldStr += "\n"
	}
	if (textDirection != TextDirection.LeftToRight) {
		worldStr += "TEXT_DIRECTION " + textDirection + "\n";
		worldStr += "\n"
	}
	/* PALETTE */
	for (id in palette) {
		worldStr += "PAL " + id + "\n";
		if( palette[id].name != null )
			worldStr += "NAME " + palette[id].name + "\n";
		for (i in getPal(id)) {
			for (j in getPal(id)[i]) {
				worldStr += getPal(id)[i][j];
				if (j < 2) worldStr += ",";
			}
			worldStr += "\n";
		}
		worldStr += "\n";
	}
	/* ROOM */
	for (id in room) {
		worldStr += "ROOM " + id + "\n";
		if ( flags.ROOM_FORMAT == 0 ) {
			// old non-comma separated format
			for (i in room[id].tilemap) {
				for (j in room[id].tilemap[i]) {
					worldStr += room[id].tilemap[i][j];	
				}
				worldStr += "\n";
			}
		}
		else if ( flags.ROOM_FORMAT == 1 ) {
			// new comma separated format
			for (i in room[id].tilemap) {
				for (j in room[id].tilemap[i]) {
					worldStr += room[id].tilemap[i][j];
					if (j < room[id].tilemap[i].length-1) worldStr += ","
				}
				worldStr += "\n";
			}
		}
		if (room[id].name != null) {
			/* NAME */
			worldStr += "NAME " + room[id].name + "\n";
		}
		if (room[id].walls.length > 0) {
			/* WALLS */
			worldStr += "WAL ";
			for (j in room[id].walls) {
				worldStr += room[id].walls[j];
				if (j < room[id].walls.length-1) {
					worldStr += ",";
				}
			}
			worldStr += "\n";
		}
		if (room[id].items.length > 0) {
			/* ITEMS */
			for (j in room[id].items) {
				var itm = room[id].items[j];
				worldStr += "ITM " + itm.id + " " + itm.x + "," + itm.y;
				worldStr += "\n";
			}
		}
		if (room[id].exits.length > 0) {
			/* EXITS */
			for (j in room[id].exits) {
				var e = room[id].exits[j];
				if ( isExitValid(e) ) {
					worldStr += "EXT " + e.x + "," + e.y + " " + e.dest.room + " " + e.dest.x + "," + e.dest.y;
					if (e.transition_effect != undefined && e.transition_effect != null) {
						worldStr += " FX " + e.transition_effect;
					}
					// TODO : vNext
					// if (e.script_id != undefined && e.script_id != null) {
					// 	worldStr += " PRG " + e.script_id;
					// }
					worldStr += "\n";
				}
			}
		}
		if (room[id].endings.length > 0) {
			/* ENDINGS */
			for (j in room[id].endings) {
				var e = room[id].endings[j];
				// todo isEndingValid
				worldStr += "END " + e.id + " " + e.x + "," + e.y;
				worldStr += "\n";
			}
		}
		// TODO : vNext
		// if (room[id].effects.length > 0) {
		// 	/* EFFECTS */
		// 	for (j in room[id].effects) {
		// 		var e = room[id].effects[j];
		// 		worldStr += "EFF " + e.id + " " + e.x + "," + e.y;
		// 		worldStr += "\n";
		// 	}
		// }
		if (room[id].pal != null) {
			/* PALETTE */
			worldStr += "PAL " + room[id].pal + "\n";
		}
		worldStr += "\n";
	}
	/* TILES */
	for (id in tile) {
		worldStr += "TIL " + id + "\n";
		worldStr += serializeDrawing( "TIL_" + id );
		if (tile[id].name != null && tile[id].name != undefined) {
			/* NAME */
			worldStr += "NAME " + tile[id].name + "\n";
		}
		if (tile[id].isWall != null && tile[id].isWall != undefined) {
			/* WALL */
			worldStr += "WAL " + tile[id].isWall + "\n";
		}
		if (tile[id].col != null && tile[id].col != undefined && tile[id].col != 1) {
			/* COLOR OVERRIDE */
			worldStr += "COL " + tile[id].col + "\n";
		}
		worldStr += "\n";
	}
	/* SPRITES */
	for (id in sprite) {
		worldStr += "SPR " + id + "\n";
		worldStr += serializeDrawing( "SPR_" + id );
		if (sprite[id].name != null && sprite[id].name != undefined) {
			/* NAME */
			worldStr += "NAME " + sprite[id].name + "\n";
		}
		if (sprite[id].dlg != null) {
			worldStr += "DLG " + sprite[id].dlg + "\n";
		}
		if (sprite[id].room != null) {
			/* SPRITE POSITION */
			worldStr += "POS " + sprite[id].room + " " + sprite[id].x + "," + sprite[id].y + "\n";
		}
		if (sprite[id].inventory != null) {
			for(itemId in sprite[id].inventory) {
				worldStr += "ITM " + itemId + " " + sprite[id].inventory[itemId] + "\n";
			}
		}
		if (sprite[id].col != null && sprite[id].col != undefined && sprite[id].col != 2) {
			/* COLOR OVERRIDE */
			worldStr += "COL " + sprite[id].col + "\n";
		}
		worldStr += "\n";
	}
	/* ITEMS */
	for (id in item) {
		worldStr += "ITM " + id + "\n";
		worldStr += serializeDrawing( "ITM_" + id );
		if (item[id].name != null && item[id].name != undefined) {
			/* NAME */
			worldStr += "NAME " + item[id].name + "\n";
		}
		if (item[id].dlg != null) {
			worldStr += "DLG " + item[id].dlg + "\n";
		}
		if (item[id].col != null && item[id].col != undefined && item[id].col != 2) {
			/* COLOR OVERRIDE */
			worldStr += "COL " + item[id].col + "\n";
		}
		worldStr += "\n";
	}
	/* DIALOG */
	for (id in dialog) {
		worldStr += "DLG " + id + "\n";
		worldStr += dialog[id] + "\n";
		worldStr += "\n";
	}
	/* ENDINGS */
	for (id in ending) {
		worldStr += "END " + id + "\n";
		worldStr += ending[id] + "\n";
		worldStr += "\n";
	}
	// TODO : vNext
	// /* SCRIPTS */
	// for (id in script) {
	// 	if (script[id].type == ScriptType.Dialogue) {
	// 		worldStr += "DLG " + id + "\n";
	// 	}
	// 	else if (script[id].type == ScriptType.Ending) {
	// 		worldStr += "END " + id + "\n";
	// 	}
	// 	else {
	// 		worldStr += "PRG " + id + "\n";
	// 	}
	// 	worldStr += script[id].source + "\n";
	// 	worldStr += "\n";
	// }
	/* VARIABLES */
	for (id in variable) {
		worldStr += "VAR " + id + "\n";
		worldStr += variable[id] + "\n";
		worldStr += "\n";
	}
	/* FONT */
	// TODO : support multiple fonts
	if (fontName != defaultFontName && !skipFonts) {
		worldStr += fontManager.GetData(fontName);
	}

	return worldStr;
}

function serializeDrawing(drwId) {
	var imageSource = renderer.GetImageSource(drwId);
	var drwStr = "";
	for (f in imageSource) {
		for (y in imageSource[f]) {
			var rowStr = "";
			for (x in imageSource[f][y]) {
				rowStr += imageSource[f][y][x];
			}
			drwStr += rowStr + "\n";
		}
		if (f < (imageSource.length-1)) drwStr += ">\n";
	}
	return drwStr;
}

function isExitValid(e) {
	var hasValidStartPos = e.x >= 0 && e.x < 16 && e.y >= 0 && e.y < 16;
	var hasDest = e.dest != null;
	var hasValidRoomDest = (e.dest.room != null && e.dest.x >= 0 && e.dest.x < 16 && e.dest.y >= 0 && e.dest.y < 16);
	return hasValidStartPos && hasDest && hasValidRoomDest;
}

function placeSprites() {
	for (id in spriteStartLocations) {
		//console.log(id);
		//console.log( spriteStartLocations[id] );
		//console.log(sprite[id]);
		sprite[id].room = spriteStartLocations[id].room;
		sprite[id].x = spriteStartLocations[id].x;
		sprite[id].y = spriteStartLocations[id].y;
		//console.log(sprite[id]);
	}
}

/* ARGUMENT GETTERS */
function getType(line) {
	return getArg(line,0);
}

function getId(line) {
	return getArg(line,1);
}

function getArg(line,arg) {
	return line.split(" ")[arg];
}

function getCoord(line,arg) {
	return getArg(line,arg).split(",");
}

function parseTitle(lines, i) {
	title = lines[i];
	i++;
	return i;
}

function parseRoom(lines, i) {
	var id = getId(lines[i]);
	room[id] = {
		id : id,
		tilemap : [],
		walls : [],
		exits : [],
		endings : [],
		// effects : [], // TODO vNext
		items : [],
		pal : null,
		name : null
	};
	i++;

	// create tile map
	if ( flags.ROOM_FORMAT == 0 ) {
		// old way: no commas, single char tile ids
		var end = i + mapsize;
		var y = 0;
		for (; i<end; i++) {
			room[id].tilemap.push( [] );
			for (x = 0; x<mapsize; x++) {
				room[id].tilemap[y].push( lines[i].charAt(x) );
			}
			y++;
		}
	}
	else if ( flags.ROOM_FORMAT == 1 ) {
		// new way: comma separated, multiple char tile ids
		var end = i + mapsize;
		var y = 0;
		for (; i<end; i++) {
			room[id].tilemap.push( [] );
			var lineSep = lines[i].split(",");
			for (x = 0; x<mapsize; x++) {
				room[id].tilemap[y].push( lineSep[x] );
			}
			y++;
		}
	}

	while (i < lines.length && lines[i].length > 0) { //look for empty line
		// console.log(getType(lines[i]));
		if (getType(lines[i]) === "SPR") {
			/* NOTE SPRITE START LOCATIONS */
			var sprId = getId(lines[i]);
			if (sprId.indexOf(",") == -1 && lines[i].split(" ").length >= 3) { //second conditional checks for coords
				/* PLACE A SINGLE SPRITE */
				var sprCoord = lines[i].split(" ")[2].split(",");
				spriteStartLocations[sprId] = {
					room : id,
					x : parseInt(sprCoord[0]),
					y : parseInt(sprCoord[1])
				};
			}
			else if ( flags.ROOM_FORMAT == 0 ) { // TODO: right now this shortcut only works w/ the old comma separate format
				/* PLACE MULTIPLE SPRITES*/ 
				//Does find and replace in the tilemap (may be hacky, but its convenient)
				var sprList = sprId.split(",");
				for (row in room[id].tilemap) {
					for (s in sprList) {
						var col = room[id].tilemap[row].indexOf( sprList[s] );
						//if the sprite is in this row, replace it with the "null tile" and set its starting position
						if (col != -1) {
							room[id].tilemap[row][col] = "0";
							spriteStartLocations[ sprList[s] ] = {
								room : id,
								x : parseInt(col),
								y : parseInt(row)
							};
						}
					}
				}
			}
		}
		else if (getType(lines[i]) === "ITM") {
			var itmId = getId(lines[i]);
			var itmCoord = lines[i].split(" ")[2].split(",");
			var itm = {
				id: itmId,
				x : parseInt(itmCoord[0]),
				y : parseInt(itmCoord[1])
			};
			room[id].items.push( itm );
		}
		else if (getType(lines[i]) === "WAL") {
			/* DEFINE COLLISIONS (WALLS) */
			room[id].walls = getId(lines[i]).split(",");
		}
		else if (getType(lines[i]) === "EXT") {
			/* ADD EXIT */
			var exitArgs = lines[i].split(" ");
			//arg format: EXT 10,5 M 3,2 [AVA:7 LCK:a,9] [AVA 7 LCK a 9]
			var exitCoords = exitArgs[1].split(",");
			var destName = exitArgs[2];
			var destCoords = exitArgs[3].split(",");
			var ext = {
				x : parseInt(exitCoords[0]),
				y : parseInt(exitCoords[1]),
				dest : {
					room : destName,
					x : parseInt(destCoords[0]),
					y : parseInt(destCoords[1])
				},
				transition_effect : null,
				// TODO : vNext
				// script_id : null,
			};

			// optional arguments
			var exitArgIndex = 4;
			while (exitArgIndex < exitArgs.length) {
				if (exitArgs[exitArgIndex] == "FX") {
					ext.transition_effect = exitArgs[exitArgIndex+1];
					exitArgIndex += 2;
				}
				// TODO : vNext
				// else if (exitArgs[exitArgIndex] == "PRG") {
				// 	ext.script_id = exitArgs[exitArgIndex+1];
				// 	exitArgIndex += 2;
				// }
				else {
					exitArgIndex += 1;
				}
			}

			room[id].exits.push(ext);
		}
		else if (getType(lines[i]) === "END") {
			/* ADD ENDING */
			var endId = getId( lines[i] );
			var endCoords = getCoord( lines[i], 2 );
			var end = {
				id : endId,
				x : parseInt( endCoords[0] ),
				y : parseInt( endCoords[1] )
			};
			room[id].endings.push(end);
		}
		// TODO : vNext
		// else if (getType(lines[i]) === "EFF") {
		// 	/* ADD EFFECT */
		// 	var effectId = getId( lines[i] );
		// 	var effectCoords = getCoord( lines[i], 2 );
		// 	var effect = {
		// 		id : effectId,
		// 		x : parseInt( effectCoords[0] ),
		// 		y : parseInt( effectCoords[1] ),
		// 	};
		// 	room[id].effects.push(effect);
		// }
		else if (getType(lines[i]) === "PAL") {
			/* CHOOSE PALETTE (that's not default) */
			room[id].pal = getId(lines[i]);
		}
		else if (getType(lines[i]) === "NAME") {
			var name = lines[i].split(/\s(.+)/)[1];
			room[id].name = name;
			names.room.set( name, id);
		}
		i++;
	}
	return i;
}

function parsePalette(lines,i) { //todo this has to go first right now :(
	var id = getId(lines[i]);
	i++;
	var colors = [];
	var name = null;
	while (i < lines.length && lines[i].length > 0) { //look for empty line
		var args = lines[i].split(" ");
		if(args[0] === "NAME") {
			name = lines[i].split(/\s(.+)/)[1];
		}
		else {
			var col = [];
			lines[i].split(",").forEach(function(i) {
				col.push(parseInt(i));
			});
			colors.push(col);
		}
		i++;
	}
	palette[id] = {
		id : id,
		name : name,
		colors : colors
	};
	return i;
}

function parseTile(lines, i) {
	var id = getId(lines[i]);
	var drwId = null;
	var name = null;

	i++;

	if (getType(lines[i]) === "DRW") { //load existing drawing
		drwId = getId(lines[i]);
		i++;
	}
	else {
		// store tile source
		drwId = "TIL_" + id;
		i = parseDrawingCore( lines, i, drwId );
	}

	//other properties
	var colorIndex = 1; // default palette color index is 1
	var isWall = null; // null indicates it can vary from room to room (original version)
	while (i < lines.length && lines[i].length > 0) { //look for empty line
		if (getType(lines[i]) === "COL") {
			colorIndex = parseInt( getId(lines[i]) );
		}
		else if (getType(lines[i]) === "NAME") {
			/* NAME */
			name = lines[i].split(/\s(.+)/)[1];
			names.tile.set( name, id );
		}
		else if (getType(lines[i]) === "WAL") {
			var wallArg = getArg( lines[i], 1 );
			if( wallArg === "true" ) {
				isWall = true;
			}
			else if( wallArg === "false" ) {
				isWall = false;
			}
		}
		i++;
	}

	//tile data
	tile[id] = {
		id : id,
		drw : drwId, //drawing id
		col : colorIndex,
		animation : {
			isAnimated : (renderer.GetFrameCount(drwId) > 1),
			frameIndex : 0,
			frameCount : renderer.GetFrameCount(drwId)
		},
		name : name,
		isWall : isWall
	};

	return i;
}

function parseSprite(lines, i) {
	var id = getId(lines[i]);
	var drwId = null;
	var name = null;

	i++;

	if (getType(lines[i]) === "DRW") { //load existing drawing
		drwId = getId(lines[i]);
		i++;
	}
	else {
		// store sprite source
		drwId = "SPR_" + id;
		i = parseDrawingCore( lines, i, drwId );
	}

	//other properties
	var colorIndex = 2; //default palette color index is 2
	var dialogId = null;
	var startingInventory = {};
	while (i < lines.length && lines[i].length > 0) { //look for empty line
		if (getType(lines[i]) === "COL") {
			/* COLOR OFFSET INDEX */
			colorIndex = parseInt( getId(lines[i]) );
		}
		else if (getType(lines[i]) === "POS") {
			/* STARTING POSITION */
			var posArgs = lines[i].split(" ");
			var roomId = posArgs[1];
			var coordArgs = posArgs[2].split(",");
			spriteStartLocations[id] = {
				room : roomId,
				x : parseInt(coordArgs[0]),
				y : parseInt(coordArgs[1])
			};
		}
		else if(getType(lines[i]) === "DLG") {
			dialogId = getId(lines[i]);
		}
		else if (getType(lines[i]) === "NAME") {
			/* NAME */
			name = lines[i].split(/\s(.+)/)[1];
			names.sprite.set( name, id );
		}
		else if (getType(lines[i]) === "ITM") {
			/* ITEM STARTING INVENTORY */
			var itemId = getId(lines[i]);
			var itemCount = parseFloat( getArg(lines[i], 2) );
			startingInventory[itemId] = itemCount;
		}
		i++;
	}

	//sprite data
	sprite[id] = {
		id : id,
		drw : drwId, //drawing id
		col : colorIndex,
		dlg : dialogId,
		room : null, //default location is "offstage"
		x : -1,
		y : -1,
		walkingPath : [], //tile by tile movement path (isn't saved)
		animation : {
			isAnimated : (renderer.GetFrameCount(drwId) > 1),
			frameIndex : 0,
			frameCount : renderer.GetFrameCount(drwId)
		},
		inventory : startingInventory,
		name : name
	};
	return i;
}

function parseItem(lines, i) {
	var id = getId(lines[i]);
	var drwId = null;
	var name = null;

	i++;

	if (getType(lines[i]) === "DRW") { //load existing drawing
		drwId = getId(lines[i]);
		i++;
	}
	else {
		// store item source
		drwId = "ITM_" + id; // these prefixes are maybe a terrible way to differentiate drawing tyepes :/
		i = parseDrawingCore( lines, i, drwId );
	}

	//other properties
	var colorIndex = 2; //default palette color index is 2
	var dialogId = null;
	while (i < lines.length && lines[i].length > 0) { //look for empty line
		if (getType(lines[i]) === "COL") {
			/* COLOR OFFSET INDEX */
			colorIndex = parseInt( getArg( lines[i], 1 ) );
		}
		// else if (getType(lines[i]) === "POS") {
		// 	/* STARTING POSITION */
		// 	var posArgs = lines[i].split(" ");
		// 	var roomId = posArgs[1];
		// 	var coordArgs = posArgs[2].split(",");
		// 	spriteStartLocations[id] = {
		// 		room : roomId,
		// 		x : parseInt(coordArgs[0]),
		// 		y : parseInt(coordArgs[1])
		// 	};
		// }
		else if(getType(lines[i]) === "DLG") {
			dialogId = getId(lines[i]);
		}
		else if (getType(lines[i]) === "NAME") {
			/* NAME */
			name = lines[i].split(/\s(.+)/)[1];
			names.item.set( name, id );
		}
		i++;
	}

	//item data
	item[id] = {
		id : id,
		drw : drwId, //drawing id
		col : colorIndex,
		dlg : dialogId,
		// room : null, //default location is "offstage"
		// x : -1,
		// y : -1,
		animation : {
			isAnimated : (renderer.GetFrameCount(drwId) > 1),
			frameIndex : 0,
			frameCount : renderer.GetFrameCount(drwId)
		},
		name : name
	};

	// console.log("ITM " + id);
	// console.log(item[id]);

	return i;
}

function parseDrawing(lines, i) {
	// store drawing source
	var drwId = getId( lines[i] );
	return parseDrawingCore( lines, i, drwId );
}

function parseDrawingCore(lines, i, drwId) {
	var frameList = []; //init list of frames
	frameList.push( [] ); //init first frame
	var frameIndex = 0;
	var y = 0;
	while ( y < tilesize ) {
		var l = lines[i+y];
		var row = [];
		for (x = 0; x < tilesize; x++) {
			row.push( parseInt( l.charAt(x) ) );
		}
		frameList[frameIndex].push( row );
		y++;

		if (y === tilesize) {
			i = i + y;
			if ( lines[i] != undefined && lines[i].charAt(0) === ">" ) {
				// start next frame!
				frameList.push( [] );
				frameIndex++;
				//start the count over again for the next frame
				i++;
				y = 0;
			}
		}
	}

	renderer.SetImageSource(drwId, frameList);

	return i;
}

// TODO : vNext
// var ScriptType = {
// 	Script : 0,
// 	Dialogue : 1, // TODO : move everything to this spelling?
// 	Ending : 2,
// };

function parseScript(lines, i, objectStore) {
	// TODO : vNext
	// if (scriptType === undefined || scriptType === null) {
	// 	scriptType = ScriptType.Script;
	// }

	var id = getId(lines[i]);
	i++;

	var results = scriptUtils.ReadDialogScript(lines,i);

	// TODO : vNext
	// script[id] = {
	// 	source: results.script,
	// 	type: scriptType,
	// };

	objectStore[id] = results.script;

	i = results.index;

	return i;
}

function parseDialog(lines, i) {
	return parseScript(lines, i, dialog);
}

function parseEnding(lines, i) {
	return parseScript(lines, i, ending);
}

function parseVariable(lines, i) {
	var id = getId(lines[i]);
	i++;
	var value = lines[i];
	i++;
	variable[id] = value;
	return i;
}

function parseFontName(lines, i) {
	fontName = getArg(lines[i], 1);
	i++;
	return i;
}

function parseTextDirection(lines, i) {
	textDirection = getArg(lines[i], 1);
	i++;
	return i;
}

function parseFontData(lines, i) {
	// NOTE : we're not doing the actual parsing here --
	// just grabbing the block of text that represents the font
	// and giving it to the font manager to use later

	var localFontName = getId(lines[i]);
	var localFontData = lines[i];
	i++;

	while (i < lines.length && lines[i] != "") {
		localFontData += "\n" + lines[i];
		i++;
	}

	var localFontFilename = localFontName + fontManager.GetExtension();
	fontManager.AddResource( localFontFilename, localFontData );

	return i;
}

function parseFlag(lines, i) {
	var id = getId(lines[i]);
	var valStr = lines[i].split(" ")[2];
	flags[id] = parseInt( valStr );
	i++;
	return i;
}

function drawTile(img,x,y,context) {
	if (!context) { //optional pass in context; otherwise, use default
		context = ctx;
	}
	context.putImageData(img,x*tilesize*scale,y*tilesize*scale);
}

function drawSprite(img,x,y,context) { //this may differ later (or not haha)
	drawTile(img,x,y,context);
}

function drawItem(img,x,y,context) {
	drawTile(img,x,y,context); //TODO these methods are dumb and repetitive
}

// var debugLastRoomDrawn = "0";

function drawRoom(room,context,frameIndex) { // context & frameIndex are optional
	if (!context) { //optional pass in context; otherwise, use default (ok this is REAL hacky isn't it)
		context = ctx;
	}

	// if (room.id != debugLastRoomDrawn) {
	// 	debugLastRoomDrawn = room.id;
	// 	console.log("DRAW ROOM " + debugLastRoomDrawn);
	// }

	//clear screen
	context.fillStyle = "rgb(" + getPal(room.pal)[0][0] + "," + getPal(room.pal)[0][1] + "," + getPal(room.pal)[0][2] + ")";
	context.fillRect(0,0,canvas.width,canvas.height);

	//draw tiles
	for (i in room.tilemap) {
		for (j in room.tilemap[i]) {
			var id = room.tilemap[i][j];
			if (id != "0") {
				//console.log(id);
				if (tile[id] == null) { // hack-around to avoid corrupting files (not a solution though!)
					id = "0";
					room.tilemap[i][j] = id;
				}
				else {
					// console.log(id);
					drawTile( getTileImage(tile[id],getRoomPal(room.id),frameIndex), j, i, context );
				}
			}
		}
	}

	//draw items
	for (var i = 0; i < room.items.length; i++) {
		var itm = room.items[i];
		drawItem( getItemImage(item[itm.id],getRoomPal(room.id),frameIndex), itm.x, itm.y, context );
	}

	//draw sprites
	for (id in sprite) {
		var spr = sprite[id];
		if (spr.room === room.id) {
			drawSprite( getSpriteImage(spr,getRoomPal(room.id),frameIndex), spr.x, spr.y, context );
		}
	}
}

// TODO : remove these get*Image methods
function getTileImage(t,palId,frameIndex) {
	return renderer.GetImage(t,palId,frameIndex);
}

function getSpriteImage(s,palId,frameIndex) {
	return renderer.GetImage(s,palId,frameIndex);
}

function getItemImage(itm,palId,frameIndex) {
	return renderer.GetImage(itm,palId,frameIndex);
}

function curPal() {
	return getRoomPal(curRoom);
}

function getRoomPal(roomId) {
	if (room[roomId].pal != null) {
		//a specific palette was chosen
		return room[roomId].pal;
	}
	else {
		if (roomId in palette) {
			//there is a palette matching the name of the room
			return roomId;
		}
		else {
			//use the default palette
			return "0";
		}
	}
	return "0";	
}

var isDialogMode = false;
var isNarrating = false;
var isEnding = false;
var dialogModule = new Dialog();
var dialogRenderer = dialogModule.CreateRenderer();
var dialogBuffer = dialogModule.CreateBuffer();
var fontManager = new FontManager();

function onExitDialog(scriptResult, dialogCallback) {
	isDialogMode = false;
	if (isNarrating) isNarrating = false;
	if (isDialogPreview) {
		isDialogPreview = false;
		if (onDialogPreviewEnd != null)
			onDialogPreviewEnd();
	}

	if (dialogCallback != undefined && dialogCallback != null) {
		dialogCallback(scriptResult);
	}
}

/*
TODO
- titles and endings should also take advantage of the script pre-compilation if possible??
- could there be a namespace collision?
- what about dialog NAMEs vs IDs?
- what about a special script block separate from DLG?
*/
function startNarrating(dialogStr,end) {
	console.log("NARRATE " + dialogStr);

	if(end === undefined) end = false;

	isNarrating = true;
	isEnding = end;
	startDialog(dialogStr);
}

function startItemDialog(itemId) {
	var dialogId = item[itemId].dlg;
	// console.log("START ITEM DIALOG " + dialogId);
	if(dialog[dialogId]){
		var dialogStr = dialog[dialogId];
		startDialog(dialogStr,dialogId);
	}
}

function startSpriteDialog(spriteId) {
	var spr = sprite[spriteId];
	var dialogId = spr.dlg ? spr.dlg : spriteId;
	// console.log("START SPRITE DIALOG " + dialogId);
	if(dialog[dialogId]){
		var dialogStr = dialog[dialogId];
		startDialog(dialogStr,dialogId);
	}
}

function startDialog(dialogStr,scriptId,dialogCallback) {
	// console.log("START DIALOG ");
	if(dialogStr.length <= 0) {
		// console.log("ON EXIT DIALOG -- startDialog 1");
		onExitDialog(dialogCallback);
		return;
	}

	isDialogMode = true;

	dialogRenderer.Reset();
	dialogRenderer.SetCentered( isNarrating /*centered*/ );
	dialogBuffer.Reset();
	scriptInterpreter.SetDialogBuffer( dialogBuffer );

	var onScriptEnd = function(scriptResult) {
		dialogBuffer.OnDialogEnd(function() {
			onExitDialog(scriptResult, dialogCallback);
		});
	};

	if(scriptId === undefined) {
		scriptInterpreter.Interpret( dialogStr, onScriptEnd );
	}
	else {
		if( !scriptInterpreter.HasScript(scriptId) ) {
			scriptInterpreter.Compile( scriptId, dialogStr );
		}
		scriptInterpreter.DebugVisualizeScriptTree(scriptId);
		scriptInterpreter.Run( scriptId, onScriptEnd );
	}

}

var isDialogPreview = false;
function startPreviewDialog(script, onScriptEnd) {
	isNarrating = true;

	isDialogMode = true;

	isDialogPreview = true;

	dialogRenderer.Reset();
	dialogRenderer.SetCentered( true );
	dialogBuffer.Reset();
	scriptInterpreter.SetDialogBuffer( dialogBuffer );

	onDialogPreviewEnd = onScriptEnd;

	scriptInterpreter.Eval( script, null );
}

/* NEW SCRIPT STUFF */
var scriptModule = new Script();
var scriptInterpreter = scriptModule.CreateInterpreter();
var scriptUtils = scriptModule.CreateUtils(); // TODO: move to editor.js?
// scriptInterpreter.SetDialogBuffer( dialogBuffer );
</script>

<!-- store default font in separate script tag for back compat-->
<script type="bitsyFontData" id="ascii_small">
FONT ascii_small
SIZE 6 8
CHAR 0
000000
000000
000000
000000
000000
000000
000000
000000
CHAR 1
001110
010001
011011
010001
010101
010001
001110
000000
CHAR 2
001110
011111
010101
011111
010001
011111
001110
000000
CHAR 3
000000
001010
011111
011111
011111
001110
000100
000000
CHAR 4
000000
000000
001010
001110
001110
000100
000000
000000
CHAR 5
000100
001110
001110
000100
011111
011111
000100
000000
CHAR 6
000000
000100
001110
011111
011111
000100
001110
000000
CHAR 7
000000
000000
000000
001100
001100
000000
000000
000000
CHAR 8
111111
111111
111111
110011
110011
111111
111111
111111
CHAR 9
000000
000000
011110
010010
010010
011110
000000
000000
CHAR 10
111111
111111
100001
101101
101101
100001
111111
111111
CHAR 11
000000
000111
000011
001101
010010
010010
001100
000000
CHAR 12
001110
010001
010001
001110
000100
001110
000100
000000
CHAR 13
000100
000110
000101
000100
001100
011100
011000
000000
CHAR 14
000011
001101
001011
001101
001011
011011
011000
000000
CHAR 15
000000
010101
001110
011011
001110
010101
000000
000000
CHAR 16
001000
001100
001110
001111
001110
001100
001000
000000
CHAR 17
000010
000110
001110
011110
001110
000110
000010
000000
CHAR 18
000100
001110
011111
000100
011111
001110
000100
000000
CHAR 19
001010
001010
001010
001010
001010
000000
001010
000000
CHAR 20
001111
010101
010101
001101
000101
000101
000101
000000
CHAR 21
001110
010001
001100
001010
000110
010001
001110
000000
CHAR 22
000000
000000
000000
000000
000000
011110
011110
000000
CHAR 23
000100
001110
011111
000100
011111
001110
000100
001110
CHAR 24
000100
001110
011111
000100
000100
000100
000100
000000
CHAR 25
000100
000100
000100
000100
011111
001110
000100
000000
CHAR 26
000000
000100
000110
011111
000110
000100
000000
000000
CHAR 27
000000
000100
001100
011111
001100
000100
000000
000000
CHAR 28
000000
000000
000000
010000
010000
010000
011111
000000
CHAR 29
000000
001010
001010
011111
001010
001010
000000
000000
CHAR 30
000100
000100
001110
001110
011111
011111
000000
000000
CHAR 31
011111
011111
001110
001110
000100
000100
000000
000000
CHAR 32
000000
000000
000000
000000
000000
000000
000000
000000
CHAR 33
000100
001110
001110
000100
000100
000000
000100
000000
CHAR 34
011011
011011
010010
000000
000000
000000
000000
000000
CHAR 35
000000
001010
011111
001010
001010
011111
001010
000000
CHAR 36
001000
001110
010000
001100
000010
011100
000100
000000
CHAR 37
011001
011001
000010
000100
001000
010011
010011
000000
CHAR 38
001000
010100
010100
001000
010101
010010
001101
000000
CHAR 39
001100
001100
001000
000000
000000
000000
000000
000000
CHAR 40
000100
001000
001000
001000
001000
001000
000100
000000
CHAR 41
001000
000100
000100
000100
000100
000100
001000
000000
CHAR 42
000000
001010
001110
011111
001110
001010
000000
000000
CHAR 43
000000
000100
000100
011111
000100
000100
000000
000000
CHAR 44
000000
000000
000000
000000
000000
001100
001100
001000
CHAR 45
000000
000000
000000
011111
000000
000000
000000
000000
CHAR 46
000000
000000
000000
000000
000000
001100
001100
000000
CHAR 47
000000
000001
000010
000100
001000
010000
000000
000000
CHAR 48
001110
010001
010011
010101
011001
010001
001110
000000
CHAR 49
000100
001100
000100
000100
000100
000100
001110
000000
CHAR 50
001110
010001
000001
000110
001000
010000
011111
000000
CHAR 51
001110
010001
000001
001110
000001
010001
001110
000000
CHAR 52
000010
000110
001010
010010
011111
000010
000010
000000
CHAR 53
011111
010000
010000
011110
000001
010001
001110
000000
CHAR 54
000110
001000
010000
011110
010001
010001
001110
000000
CHAR 55
011111
000001
000010
000100
001000
001000
001000
000000
CHAR 56
001110
010001
010001
001110
010001
010001
001110
000000
CHAR 57
001110
010001
010001
001111
000001
000010
001100
000000
CHAR 58
000000
000000
001100
001100
000000
001100
001100
000000
CHAR 59
000000
000000
001100
001100
000000
001100
001100
001000
CHAR 60
000010
000100
001000
010000
001000
000100
000010
000000
CHAR 61
000000
000000
011111
000000
000000
011111
000000
000000
CHAR 62
001000
000100
000010
000001
000010
000100
001000
000000
CHAR 63
001110
010001
000001
000110
000100
000000
000100
000000
CHAR 64
001110
010001
010111
010101
010111
010000
001110
000000
CHAR 65
001110
010001
010001
010001
011111
010001
010001
000000
CHAR 66
011110
010001
010001
011110
010001
010001
011110
000000
CHAR 67
001110
010001
010000
010000
010000
010001
001110
000000
CHAR 68
011110
010001
010001
010001
010001
010001
011110
000000
CHAR 69
011111
010000
010000
011110
010000
010000
011111
000000
CHAR 70
011111
010000
010000
011110
010000
010000
010000
000000
CHAR 71
001110
010001
010000
010111
010001
010001
001111
000000
CHAR 72
010001
010001
010001
011111
010001
010001
010001
000000
CHAR 73
001110
000100
000100
000100
000100
000100
001110
000000
CHAR 74
000001
000001
000001
000001
010001
010001
001110
000000
CHAR 75
010001
010010
010100
011000
010100
010010
010001
000000
CHAR 76
010000
010000
010000
010000
010000
010000
011111
000000
CHAR 77
010001
011011
010101
010001
010001
010001
010001
000000
CHAR 78
010001
011001
010101
010011
010001
010001
010001
000000
CHAR 79
001110
010001
010001
010001
010001
010001
001110
000000
CHAR 80
011110
010001
010001
011110
010000
010000
010000
000000
CHAR 81
001110
010001
010001
010001
010101
010010
001101
000000
CHAR 82
011110
010001
010001
011110
010010
010001
010001
000000
CHAR 83
001110
010001
010000
001110
000001
010001
001110
000000
CHAR 84
011111
000100
000100
000100
000100
000100
000100
000000
CHAR 85
010001
010001
010001
010001
010001
010001
001110
000000
CHAR 86
010001
010001
010001
010001
010001
001010
000100
000000
CHAR 87
010001
010001
010101
010101
010101
010101
001010
000000
CHAR 88
010001
010001
001010
000100
001010
010001
010001
000000
CHAR 89
010001
010001
010001
001010
000100
000100
000100
000000
CHAR 90
011110
000010
000100
001000
010000
010000
011110
000000
CHAR 91
001110
001000
001000
001000
001000
001000
001110
000000
CHAR 92
000000
010000
001000
000100
000010
000001
000000
000000
CHAR 93
001110
000010
000010
000010
000010
000010
001110
000000
CHAR 94
000100
001010
010001
000000
000000
000000
000000
000000
CHAR 95
000000
000000
000000
000000
000000
000000
000000
111111
CHAR 96
001100
001100
000100
000000
000000
000000
000000
000000
CHAR 97
000000
000000
001110
000001
001111
010001
001111
000000
CHAR 98
010000
010000
011110
010001
010001
010001
011110
000000
CHAR 99
000000
000000
001110
010001
010000
010001
001110
000000
CHAR 100
000001
000001
001111
010001
010001
010001
001111
000000
CHAR 101
000000
000000
001110
010001
011110
010000
001110
000000
CHAR 102
000110
001000
001000
011110
001000
001000
001000
000000
CHAR 103
000000
000000
001111
010001
010001
001111
000001
001110
CHAR 104
010000
010000
011100
010010
010010
010010
010010
000000
CHAR 105
000100
000000
000100
000100
000100
000100
000110
000000
CHAR 106
000010
000000
000110
000010
000010
000010
010010
001100
CHAR 107
010000
010000
010010
010100
011000
010100
010010
000000
CHAR 108
000100
000100
000100
000100
000100
000100
000110
000000
CHAR 109
000000
000000
011010
010101
010101
010001
010001
000000
CHAR 110
000000
000000
011100
010010
010010
010010
010010
000000
CHAR 111
000000
000000
001110
010001
010001
010001
001110
000000
CHAR 112
000000
000000
011110
010001
010001
010001
011110
010000
CHAR 113
000000
000000
001111
010001
010001
010001
001111
000001
CHAR 114
000000
000000
010110
001001
001000
001000
011100
000000
CHAR 115
000000
000000
001110
010000
001110
000001
001110
000000
CHAR 116
000000
001000
011110
001000
001000
001010
000100
000000
CHAR 117
000000
000000
010010
010010
010010
010110
001010
000000
CHAR 118
000000
000000
010001
010001
010001
001010
000100
000000
CHAR 119
000000
000000
010001
010001
010101
011111
001010
000000
CHAR 120
000000
000000
010010
010010
001100
010010
010010
000000
CHAR 121
000000
000000
010010
010010
010010
001110
000100
011000
CHAR 122
000000
000000
011110
000010
001100
010000
011110
000000
CHAR 123
000110
001000
001000
011000
001000
001000
000110
000000
CHAR 124
000100
000100
000100
000100
000100
000100
000100
000100
CHAR 125
001100
000010
000010
000011
000010
000010
001100
000000
CHAR 126
001010
010100
000000
000000
000000
000000
000000
000000
CHAR 127
000100
001110
011011
010001
010001
011111
000000
000000
CHAR 128
001110
010001
010000
010000
010001
001110
000100
001100
CHAR 129
010010
000000
010010
010010
010010
010110
001010
000000
CHAR 130
000011
000000
001110
010001
011110
010000
001110
000000
CHAR 131
001110
000000
001110
000001
001111
010001
001111
000000
CHAR 132
001010
000000
001110
000001
001111
010001
001111
000000
CHAR 133
001100
000000
001110
000001
001111
010001
001111
000000
CHAR 134
001110
001010
001110
000001
001111
010001
001111
000000
CHAR 135
000000
001110
010001
010000
010001
001110
000100
001100
CHAR 136
001110
000000
001110
010001
011110
010000
001110
000000
CHAR 137
001010
000000
001110
010001
011110
010000
001110
000000
CHAR 138
001100
000000
001110
010001
011110
010000
001110
000000
CHAR 139
001010
000000
000100
000100
000100
000100
000110
000000
CHAR 140
000100
001010
000000
000100
000100
000100
000110
000000
CHAR 141
001000
000000
000100
000100
000100
000100
000110
000000
CHAR 142
001010
000000
000100
001010
010001
011111
010001
000000
CHAR 143
001110
001010
001110
011011
010001
011111
010001
000000
CHAR 144
000011
000000
011111
010000
011110
010000
011111
000000
CHAR 145
000000
000000
011110
000101
011111
010100
001111
000000
CHAR 146
001111
010100
010100
011111
010100
010100
010111
000000
CHAR 147
001110
000000
001100
010010
010010
010010
001100
000000
CHAR 148
001010
000000
001100
010010
010010
010010
001100
000000
CHAR 149
011000
000000
001100
010010
010010
010010
001100
000000
CHAR 150
001110
000000
010010
010010
010010
010110
001010
000000
CHAR 151
011000
000000
010010
010010
010010
010110
001010
000000
CHAR 152
001010
000000
010010
010010
010010
001110
000100
011000
CHAR 153
010010
001100
010010
010010
010010
010010
001100
000000
CHAR 154
001010
000000
010010
010010
010010
010010
001100
000000
CHAR 155
000000
000100
001110
010000
010000
001110
000100
000000
CHAR 156
000110
001001
001000
011110
001000
001001
010111
000000
CHAR 157
010001
001010
000100
011111
000100
011111
000100
000000
CHAR 158
011000
010100
010100
011010
010111
010010
010010
000000
CHAR 159
000010
000101
000100
001110
000100
000100
010100
001000
CHAR 160
000110
000000
001110
000001
001111
010001
001111
000000
CHAR 161
000110
000000
000100
000100
000100
000100
000110
000000
CHAR 162
000110
000000
001100
010010
010010
010010
001100
000000
CHAR 163
000110
000000
010010
010010
010010
010110
001010
000000
CHAR 164
001010
010100
000000
011100
010010
010010
010010
000000
CHAR 165
001010
010100
000000
010010
011010
010110
010010
000000
CHAR 166
001110
000001
001111
010001
001111
000000
001111
000000
CHAR 167
001100
010010
010010
010010
001100
000000
011110
000000
CHAR 168
000100
000000
000100
001100
010000
010001
001110
000000
CHAR 169
000000
000000
011111
010000
010000
010000
000000
000000
CHAR 170
000000
000000
111111
000001
000001
000000
000000
000000
CHAR 171
010000
010010
010100
001110
010001
000010
000111
000000
CHAR 172
010000
010010
010100
001011
010101
000111
000001
000000
CHAR 173
000100
000000
000100
000100
001110
001110
000100
000000
CHAR 174
000000
000000
001001
010010
001001
000000
000000
000000
CHAR 175
000000
000000
010010
001001
010010
000000
000000
000000
CHAR 176
010101
000000
101010
000000
010101
000000
101010
000000
CHAR 177
010101
101010
010101
101010
010101
101010
010101
101010
CHAR 178
101010
111111
010101
111111
101010
111111
010101
111111
CHAR 179
000100
000100
000100
000100
000100
000100
000100
000100
CHAR 180
000100
000100
000100
111100
000100
000100
000100
000100
CHAR 181
000000
000000
010010
010010
010010
011100
010000
010000
CHAR 182
010100
010100
010100
110100
010100
010100
010100
010100
CHAR 183
000000
000000
000000
111100
010100
010100
010100
010100
CHAR 184
000000
111100
000100
111100
000100
000100
000100
000100
CHAR 185
010100
110100
000100
110100
010100
010100
010100
010100
CHAR 186
010100
010100
010100
010100
010100
010100
010100
010100
CHAR 187
000000
111100
000100
110100
010100
010100
010100
010100
CHAR 188
010100
110100
000100
111100
000000
000000
000000
000000
CHAR 189
010100
010100
010100
111100
000000
000000
000000
000000
CHAR 190
000100
111100
000100
111100
000000
000000
000000
000000
CHAR 191
000000
000000
000000
111100
000100
000100
000100
000100
CHAR 192
000100
000100
000100
000111
000000
000000
000000
000000
CHAR 193
000100
000100
000100
111111
000000
000000
000000
000000
CHAR 194
000000
000000
000000
111111
000100
000100
000100
000100
CHAR 195
000100
000100
000100
000111
000100
000100
000100
000100
CHAR 196
000000
000000
000000
111111
000000
000000
000000
000000
CHAR 197
000100
000100
000100
111111
000100
000100
000100
000100
CHAR 198
000100
000111
000100
000111
000100
000100
000100
000100
CHAR 199
010100
010100
010100
010111
010100
010100
010100
010100
CHAR 200
010100
010111
010000
011111
000000
000000
000000
000000
CHAR 201
000000
011111
010000
010111
010100
010100
010100
010100
CHAR 202
010100
110111
000000
111111
000000
000000
000000
000000
CHAR 203
000000
111111
000000
110111
010100
010100
010100
010100
CHAR 204
010100
010111
010000
010111
010100
010100
010100
010100
CHAR 205
000000
111111
000000
111111
000000
000000
000000
000000
CHAR 206
010100
110111
000000
110111
010100
010100
010100
010100
CHAR 207
000100
111111
000000
111111
000000
000000
000000
000000
CHAR 208
010100
010100
010100
111111
000000
000000
000000
000000
CHAR 209
000000
111111
000000
111111
000100
000100
000100
000100
CHAR 210
000000
000000
000000
111111
010100
010100
010100
010100
CHAR 211
010100
010100
010100
011111
000000
000000
000000
000000
CHAR 212
000000
000000
000000
000000
000000
000000
000000
111111
CHAR 213
000000
000000
000000
000000
000000
000000
111111
111111
CHAR 214
000000
000000
000000
000000
000000
111111
111111
111111
CHAR 215
000000
000000
000000
000000
111111
111111
111111
111111
CHAR 216
000000
000000
000000
111111
111111
111111
111111
111111
CHAR 217
000000
000000
111111
111111
111111
111111
111111
111111
CHAR 218
000000
111111
111111
111111
111111
111111
111111
111111
CHAR 219
111111
111111
111111
111111
111111
111111
111111
111111
CHAR 220
100000
100000
100000
100000
100000
100000
100000
100000
CHAR 221
110000
110000
110000
110000
110000
110000
110000
110000
CHAR 222
111000
111000
111000
111000
111000
111000
111000
111000
CHAR 223
111100
111100
111100
111100
111100
111100
111100
111100
CHAR 224
111110
111110
111110
111110
111110
111110
111110
111110
CHAR 225
000000
011100
010010
011100
010010
010010
011100
010000
CHAR 226
011110
010010
010000
010000
010000
010000
010000
000000
CHAR 227
000000
011111
001010
001010
001010
001010
001010
000000
CHAR 228
001010
000000
001110
000001
001111
010001
001111
000000
CHAR 229
000000
000000
001111
010010
010010
001100
000000
000000
CHAR 230
000000
000000
010010
010010
010010
011100
010000
010000
CHAR 231
000000
000000
001010
010100
000100
000100
000100
000000
CHAR 232
001110
000100
001110
010001
001110
000100
001110
000000
CHAR 233
001100
010010
010010
011110
010010
010010
001100
000000
CHAR 234
000000
001110
010001
010001
001010
001010
011011
000000
CHAR 235
001100
010000
001000
000100
001110
010010
001100
000000
CHAR 236
000000
000000
001010
010101
010101
001010
000000
000000
CHAR 237
000000
000100
001110
010101
010101
001110
000100
000000
CHAR 238
000000
001110
010000
011110
010000
001110
000000
000000
CHAR 239
000000
001100
010010
010010
010010
010010
000000
000000
CHAR 240
000000
011110
000000
011110
000000
011110
000000
000000
CHAR 241
000000
000100
001110
000100
000000
001110
000000
000000
CHAR 242
010000
001100
000010
001100
010000
000000
011110
000000
CHAR 243
000000
000000
111111
111000
100110
100001
100000
111111
CHAR 244
000000
000000
111111
000111
011001
100001
000001
111111
CHAR 245
000100
000100
000100
000100
000100
010100
001000
000000
CHAR 246
001010
000000
001110
010001
010001
010001
001110
000000
CHAR 247
111110
111110
111110
111110
111110
111110
111110
111110
CHAR 248
111100
111100
111100
111100
111100
111100
111100
111100
CHAR 249
111000
111000
111000
111000
111000
111000
111000
111000
CHAR 250
110000
110000
110000
110000
110000
110000
110000
110000
CHAR 251
100000
100000
100000
100000
100000
100000
100000
100000
CHAR 252
001010
000000
010010
010010
010010
010110
001010
000000
CHAR 253
011000
000100
001000
011100
000000
000000
000000
000000
CHAR 254
000000
000000
000000
011110
110010
110011
111110
001111
CHAR 255
010010
111111
010010
010010
111111
010010
000000
000000
</script>

</head>


<!-- DOCUMENT BODY -->
<body onload='startExportedGame()'>
	<!-- GAME CANVAS -->
	<canvas id='game'></canvas>
</body>


</html>